aorinfw1d:   oracle -  Rock#123
             system - Z00mZ00m!
xorinfdbw1d: oracle -  Bl0ckhe@d
             system - locked99999

 
app server: xppmw3d - move2s10






!! To revert NextGen Db back to deault


cd $ORACLE_HOME/dbs

cp spfilePPMDEBIZ.ora_b4_ppm_additions spfilePPMDEBIZ.ora

cd $HOME/tls/rman/

rman

@restore_ppmdebiz_aft_create.rman
exit


Below steps were used to migrate PPMDEBIZ from AIX to Linux.
How to Perform a Full Database Export Import During Upgrade, Migrate, Copy or Move of a Database (Doc ID 286775.1)

Errors encountered along the way

  Datapump Export (EXPDP) fails with ORA-00600 [kotTrns:transient] ORA-39014 ORA-39029 ORA-31671 ORA-29913 Errors (Doc ID 2093472.1)
  Error DRG-10758 When Creating Text Index Using File or URL Datastore (Doc ID 1081227.1)
  Unable to Compile WMS_EPC_PVT get 'MGD_IDCOMPONENT_VARRAY' Must be Declared Error (Doc ID 1070991.1
  Data Pump Export Or Import Throws ORA-31623 When Using LOGTIME Parameter (Doc ID 1936319.1)


Pre-Steps

1) Send email to Storman to have tdpo installed (if not already installed).

   Already installed on xorinfdbw1d in support of SMCTEST migration


2) Logon to Next Gen server xorinfdbw1d


3) Create link to allow Oracle to communicate with TSM (after tdpo has been installed by Storman)

   Already created in support of PPMTEST migration

   cd $HOME

   . oraenv
   PPMDEBIZ

   cd $ORACLE_HOME/lib

   ln -s /opt/tivoli/tsm/client/oracle/bin64/libobk.so libobk.so


4) Create new database

   cd /orahome/u01/app/oracle/local/scripts

   Script accepts 5 input parameters

   <dbms_version>  <target_db_name>  <target_db_port>  <char_set>  <nchar_set>

   ./clone_sb_db.sh 12.1.0.2.160719 PPMDEBIZ 1551 WE8ISO8859P1 AL16UTF16

   Log file is written to /orahome/u01/app/oracle/local/logs

   Log file: /orahome/u01/app/oracle/local/logs/clone_db_PPMDEBIZ_20160812_1471009417.out


5) Configure new PPMDEBIZ database for RMAN (no catalog connections at this time)

   cd /home/oracle/tdpoopt

   create file tdpo.PPMDEBIZ.opt   



   cd /home/oracle/tls/rman

   rman

   rman =>connect target /
   
   rman => @configure_PPMDEBIZ.rman


6) Add N025774 to database

   cd /home/oracle/tls

   # Modify Password
   vi create_user.sql

   sqlplus / as sysdba

   @create_user.sql

   # Set password to XYZ
   vi create_user.sql


7) Take a database backup after initial creation

   cd /home/oracle/tls/rman

   export NLS_DATE_FORMAT='YYYY-MM-DD HH24:MI:SS'

   rman |tee backup_PPMDEBIZ_aft_initial_create.out

   rman => connect target /
   
   rman => @incremental_level0_backup_tape_ppm.rman 


8) Modify master tnsnames.ora file used by SWM and LDAP in ICR to reflect new hosts
   and service PPMDEBIZ_APP.


9) Logoff Next Gen server xorinfdbw1d


End Pre-Steps
------------------------------------------------------------------------------------
------------------------------------------------------------------------------------
------------------------------------------------------------------------------------

Please follow this document Doc ID 1585256.1, it gives all the steps to prep-up and exp/imp the db. Your starting point is section 1, step 3.


!! Take AIX DB backup and Saved

cd $SCRIPTS/backup


./rman_general_purpose_oem.ksh PPMDEBIZ RCATDEV incremental_level0_backup_tape_oem.rman Y


#Once backup completed. Get latest log file name
cd $INSTANCE_OUTPUTS/rman_backups

ls -altr *.log

#Save Backup
$BKPSCR/savebkp.ksh $ORACLE_SID PPMDEBIZ_20161006_11:25:23_incremental_level0_backup_tape_oem.rman.log b4NextGenMig



view PPMDEBIZ backup saved as PPMDEBIZ_sbk_20161006_11:25:23_b4NextGenMig.rman


##Restore DataBase
#connect target /
#connect catalog PPMDEBIZ/XXX@RCATDEV
#startup force nomount;
#set DBID=3478304185;
#reset database to incarnation 2;
#restore controlfile from 'c-3478304185-20161006-09_PPMDEBIZ';
#alter database mount;
#run{
#restore database until sequence 10822;
#recover database until sequence 10822;
#}
#alter database open resetlogs;
##End Restore DataBase



Section 1: Prepare the source system

1. Apply prerequisite patches 

   -->Should be completed by App Admin


2. Apply the Applications consolidated export/import utility patch 

   -->Should be completed by App Admin


3. Create a working directory 


   
   mkdir /oraexport/meru276/PPMDEBIZ

   Do following if not already there


sqlplus / as sysdba

CREATE OR REPLACE DIRECTORY DATA_PUMP_DIR3 AS '/oraexport/meru276/PPMDEBIZ/'
/
GRANT EXECUTE ON DIRECTORY DATA_PUMP_DIR3 TO A236120 WITH GRANT OPTION
/
GRANT READ ON DIRECTORY DATA_PUMP_DIR3 TO A236120 WITH GRANT OPTION
/
GRANT WRITE ON DIRECTORY DATA_PUMP_DIR3 TO A236120 WITH GRANT OPTION
/
GRANT READ ON DIRECTORY DATA_PUMP_DIR3 TO EXP_FULL_DATABASE
/
GRANT WRITE ON DIRECTORY DATA_PUMP_DIR3 TO EXP_FULL_DATABASE
/
GRANT READ ON DIRECTORY DATA_PUMP_DIR3 TO IMP_FULL_DATABASE
/
GRANT WRITE ON DIRECTORY DATA_PUMP_DIR3 TO IMP_FULL_DATABASE
/
GRANT EXECUTE ON DIRECTORY DATA_PUMP_DIR3 TO N025774 WITH GRANT OPTION
/
GRANT READ ON DIRECTORY DATA_PUMP_DIR3 TO N025774 WITH GRANT OPTION
/
GRANT WRITE ON DIRECTORY DATA_PUMP_DIR3 TO N025774 WITH GRANT OPTION
/

exit



Ask App Admin to copy following scripts from app server to Oracle Server

$AU_TOP/patch/115/sql/

auclondb.sql
auque1.sql
audb1210.sql
ausy1210.sql
aujv1210.sql
aumsc1210.sql


$AU_TOP/patch/115/import/
auexpdp.dat
auxmlexp.dat
aufullimp.dat


$APPL_TOP/admin/
adgrants.sql       

$AD_TOP/patch/115/sql/
adctxprv.sql       


$AU_TOP/patch/115/bin/
dpost_imp.pl


$XLA_TOP/patch/115/sql/
xla6128278.sql

$APPL_TOP/admin/ 
adstats.sql



login to Linux App server: xppmw3d



scp -rp /aetnas28/asrxoracle/DBAixUpg/ahm/DBA_FILES aorinfw1d:/orahome/allu01/aetna/scripts/PPMDEBIZ/DBA_FILES




4. Generate target database instance creation script aucrdb.sql 


go back to AIX server

cd /orahome/allu01/aetna/scripts/PPMDEBIZ/DBA_FILES

Login with system account


sqlplus

system/Z00mZ00m!@PPMDEBIZ


 @auclondb.sql 12


5. Record Advanced Queue settings 



cd /orahome/allu01/aetna/scripts/PPMDEBIZ/DBA_FILES

sqlplus / as sysdba

 @auque1.sql


6. Remove rebuild index parameter in spatial indexes 

sqlplus / as sysdba

select * from dba_indexes where index_type='DOMAIN' and upper(parameters) like '%REBUILD%';
select count(*) from dba_indexes where index_type='DOMAIN' and upper(parameters) like '%REBUILD%';


sqlplus as HR

###alter index HR.PER_ADDRESSES_SPT rebuild parameters ('sdo_indx_dims=2', 'sdo_rtr_pctfree=10', 'tablespace=APPS_TS_TX_IDX');

alter index HR.PER_ADDRESSES_SPT rebuild parameters ('sdo_indx_dims=2');
alter index HR.PER_ADDRESSES_SPT rebuild parameters ('sdo_rtr_pctfree=10');
alter index HR.PER_ADDRESSES_SPT rebuild parameters ('tablespace=APPS_TS_TX_IDX');


###alter index HR.HR_LOCATIONS_SPT rebuild parameters sdo_indx_dims=2 sdo_rtr_pctfree=10 tablespace=APPS_TS_TX_IDX;

alter index HR.HR_LOCATIONS_SPT rebuild parameters ('sdo_indx_dims=2');
alter index HR.HR_LOCATIONS_SPT rebuild parameters ('sdo_rtr_pctfree=10');
alter index HR.HR_LOCATIONS_SPT rebuild parameters ('tablespace=APPS_TS_TX_IDX');

 

sqlplus as MST
###alter index MST.MST_MD_ADM_BNDS_N1 rebuild parameters sdo_indx_dims=2 sdo_rtr_pctfree=10 tablespace=APPS_TS_TX_IDX

alter index MST.MST_MD_ADM_BNDS_N1 rebuild parameters ('sdo_indx_dims=2');
alter index MST.MST_MD_ADM_BNDS_N1 rebuild parameters ('sdo_rtr_pctfree=10');
alter index MST.MST_MD_ADM_BNDS_N1 rebuild parameters ('tablespace=APPS_TS_TX_IDX');


###alter index MST.MST_MD_HYDROS_N1 rebuild parameters sdo_indx_dims=2 sdo_rtr_pctfree=10 tablespace=APPS_TS_TX_IDX 

alter index MST.MST_MD_HYDROS_N1 rebuild parameters ('sdo_indx_dims=2');
alter index MST.MST_MD_HYDROS_N1 rebuild parameters ('sdo_rtr_pctfree=10');
alter index MST.MST_MD_HYDROS_N1 rebuild parameters ('tablespace=APPS_TS_TX_IDX');

  
sqlplus / as sysdba

select count(*) from dba_indexes where index_type='DOMAIN' and upper(parameters) like '%REBUILD%';

Should be 0


7. Synchronize Text indexes 

sqlplus / as sysdba

select pnd_index_owner,pnd_index_name,count(*)
  from ctxsys.ctx_pending
  group by pnd_index_owner,pnd_index_name;

PND_INDEX_OWNER                PND_INDEX_NAME                   COUNT(*)
------------------------------ ------------------------------ ----------
APPLSYS                        FND_LOBS_CTX                            2
JTF                            JTF_AMV_ITEMS_NAME_CTX               1131
JTF                            JTF_AMV_ITEMS_DESC_CTX               1131
JTF                            JTF_AMV_ITEMS_TEXT_CTX               1131
IBC                            IBC_ATTRIBUTE_BUNDLES_CTX              58





exec ctx_ddl.sync_index('APPLSYS.FND_LOBS_CTX');
exec ctx_ddl.sync_index('JTF.JTF_AMV_ITEMS_NAME_CTX');
exec ctx_ddl.sync_index('JTF.JTF_AMV_ITEMS_DESC_CTX');
exec ctx_ddl.sync_index('JTF.JTF_AMV_ITEMS_TEXT_CTX');
exec ctx_ddl.sync_index('IBC.IBC_ATTRIBUTE_BUNDLES_CTX');

select pnd_index_owner,pnd_index_name,count(*)
  from ctxsys.ctx_pending
  group by pnd_index_owner,pnd_index_name;

Should return 0


Section 2: Prepare a target Release 12 database instance

1. Create target Oracle 12c Oracle home (conditional) 

  Completed prior.

2. Modify sqlnet.ora file (Windows only) 

   N/A

3. Create the target initialization parameter file and CBO parameter file

   Make sure 

*.undo_management='AUTO'
*.undo_retention=21600
*.undo_tablespace='APPS_UNDOTS1'




4. Create a working directory 

   Login to xorinfdbw1d

  

   mkdir /oraexport/u01/PPMDEBIZ
   

   ## copy all scripts to target server 

scp -rp /orahome/allu01/aetna/scripts/PPMDEBIZ/DBA_FILES xorinfdbw1d:/home/oracle/tls/migratedb/PPMDEBIZ/DBA_FILES


5. Create the target database instance 





Login to xorinfdbw1d

cd  /home/oracle/tls/migratedb/PPMDEBIZ/DBA_FILES

## Since Database already created. Extract what missing and modify based on new environment

view aucrdb.sql


CREATE TABLESPACE AEDBA
        DATAFILE '+DATA_01' SIZE 5M AUTOEXTEND ON NEXT 5M MAXSIZE 50M
        EXTENT MANAGEMENT LOCAL AUTOALLOCATE
        LOGGING
        ONLINE
        SEGMENT SPACE MANAGEMENT AUTO
    /

    CREATE TABLESPACE APPS_TS_TX_DATA
        DATAFILE '+DATA_01' SIZE 4096M AUTOEXTEND OFF,
                 '+DATA_01' SIZE 2048M AUTOEXTEND ON NEXT 10M MAXSIZE 4096M
    EXTENT MANAGEMENT LOCAL UNIFORM SIZE 128K
    LOGGING
    ONLINE
    SEGMENT SPACE MANAGEMENT AUTO
    /

   CREATE TABLESPACE ODM
       DATAFILE '+DATA_01' SIZE 20M AUTOEXTEND ON NEXT 5M MAXSIZE 50M
       EXTENT MANAGEMENT LOCAL UNIFORM SIZE 128K
       LOGGING
       ONLINE
       SEGMENT SPACE MANAGEMENT AUTO
    /

    CREATE TABLESPACE OLAP
        DATAFILE '+DATA_01' SIZE 40M AUTOEXTEND ON NEXT 5M MAXSIZE 100M
        EXTENT MANAGEMENT LOCAL UNIFORM SIZE 128K
        LOGGING
        ONLINE
        SEGMENT SPACE MANAGEMENT AUTO
    /

    CREATE TABLESPACE OWAPUB
        DATAFILE '+DATA_01' SIZE 10M AUTOEXTEND ON NEXT 5M MAXSIZE 20M
        EXTENT MANAGEMENT LOCAL UNIFORM SIZE 128K
        LOGGING
        ONLINE
        SEGMENT SPACE MANAGEMENT AUTO
    /

    CREATE TABLESPACE PORTAL
        DATAFILE '+DATA_01' SIZE 10M AUTOEXTEND ON NEXT 5M MAXSIZE 100M
        EXTENT MANAGEMENT LOCAL UNIFORM SIZE 128K
        LOGGING
        ONLINE
        SEGMENT SPACE MANAGEMENT AUTO
    /


   CREATE TABLESPACE PPMFIND
       DATAFILE '+DATA_01' SIZE 1200M AUTOEXTEND ON NEXT 10M MAXSIZE 4096M
       EXTENT MANAGEMENT LOCAL UNIFORM SIZE 128K
       LOGGING
       ONLINE
       SEGMENT SPACE MANAGEMENT AUTO
    /

    CREATE TABLESPACE PPMFINCLOB
       DATAFILE '+DATA_01' SIZE 10M AUTOEXTEND ON NEXT 10M MAXSIZE 2048M
       EXTENT MANAGEMENT LOCAL AUTOALLOCATE
       LOGGING
       ONLINE
       SEGMENT SPACE MANAGEMENT AUTO
   /

   CREATE TABLESPACE PPMFINX
       DATAFILE '+DATA_01' SIZE 10M AUTOEXTEND ON NEXT 10M MAXSIZE 2048M
       EXTENT MANAGEMENT LOCAL UNIFORM SIZE 128K
       LOGGING
       ONLINE
       SEGMENT SPACE MANAGEMENT AUTO
   /

   CREATE TABLESPACE PPMRXD
       DATAFILE '+DATA_01' SIZE 1200M AUTOEXTEND ON NEXT 10M MAXSIZE 2048M
       EXTENT MANAGEMENT LOCAL UNIFORM SIZE 128K
       LOGGING
       ONLINE
       SEGMENT SPACE MANAGEMENT AUTO
   /

   CREATE TABLESPACE PPMRXCLOB
       DATAFILE '+DATA_01' SIZE 10M AUTOEXTEND ON NEXT 10M MAXSIZE 2048M
       EXTENT MANAGEMENT LOCAL AUTOALLOCATE
       LOGGING
       ONLINE
       SEGMENT SPACE MANAGEMENT AUTO
   /

   CREATE TABLESPACE PPMRXX
       DATAFILE '+DATA_01' SIZE 10M AUTOEXTEND ON NEXT 10M MAXSIZE 2048M
       EXTENT MANAGEMENT LOCAL UNIFORM SIZE 128K
       LOGGING
       ONLINE
       SEGMENT SPACE MANAGEMENT AUTO
   /

   CREATE TEMPORARY TABLESPACE TEMP1
     TEMPFILE '+DATA_01' SIZE 500M AUTOEXTEND ON NEXT 10M MAXSIZE 8192M

     EXTENT MANAGEMENT LOCAL UNIFORM SIZE 1M
   /

   ALTER DATABASE 
TEMPFILE '+DATA_01/PPMDEBIZ_XORINFDBW1D/TEMPFILE/temp.297.924456339' AUTOEXTEND ON NEXT 10M MAXSIZE 8192M
;

   ALTER DATABASE 
DATAFILE '+DATA_01/PPMDEBIZ_XORINFDBW1D/DATAFILE/undotbs1.282.924456303' AUTOEXTEND ON NEXT 10M MAXSIZE 8192M
;

   
CREATE UNDO TABLESPACE APPS_UNDOTS1
    DATAFILE '+DATA_01' SIZE 10240M AUTOEXTEND OFF,
             '+DATA_01' SIZE 10240M AUTOEXTEND OFF,
             '+DATA_01' SIZE 10240M AUTOEXTEND OFF
    EXTENT MANAGEMENT LOCAL AUTOALLOCATE
    ONLINE
/


CREATE TABLESPACE APPS_TS_ARCHIVE
    DATAFILE '+DATA_01' SIZE 600M AUTOEXTEND OFF
    EXTENT MANAGEMENT LOCAL UNIFORM SIZE 128K
    LOGGING
    ONLINE
    SEGMENT SPACE MANAGEMENT AUTO
/
CREATE TABLESPACE APPS_TS_INTERFACE
    DATAFILE '+DATA_01' SIZE 800M AUTOEXTEND OFF
    EXTENT MANAGEMENT LOCAL UNIFORM SIZE 128K
    LOGGING
    ONLINE
    SEGMENT SPACE MANAGEMENT AUTO
/
CREATE TABLESPACE APPS_TS_MEDIA
    DATAFILE '+DATA_01' SIZE 1200M AUTOEXTEND OFF
    EXTENT MANAGEMENT LOCAL UNIFORM SIZE 128K
    LOGGING
    ONLINE
    SEGMENT SPACE MANAGEMENT AUTO
/
CREATE TABLESPACE APPS_TS_NOLOGGING
    DATAFILE '+DATA_01' SIZE 100M AUTOEXTEND OFF
    EXTENT MANAGEMENT LOCAL UNIFORM SIZE 128K
    LOGGING
    ONLINE
    SEGMENT SPACE MANAGEMENT AUTO
/
CREATE TABLESPACE APPS_TS_QUEUES
    DATAFILE '+DATA_01' SIZE 100M AUTOEXTEND OFF,
             '+DATA_01' SIZE 100M AUTOEXTEND OFF
    EXTENT MANAGEMENT LOCAL UNIFORM SIZE 128K
    LOGGING
    ONLINE
    SEGMENT SPACE MANAGEMENT AUTO
/




CREATE TABLESPACE APPS_TS_SEED
    DATAFILE '+DATA_01' SIZE 2048M AUTOEXTEND OFF,
             '+DATA_01' SIZE 2048M AUTOEXTEND OFF
    EXTENT MANAGEMENT LOCAL UNIFORM SIZE 128K
    LOGGING
    ONLINE
    SEGMENT SPACE MANAGEMENT AUTO
/
CREATE TABLESPACE APPS_TS_SUMMARY
    DATAFILE '+DATA_01' SIZE 1200M AUTOEXTEND OFF
    EXTENT MANAGEMENT LOCAL UNIFORM SIZE 128K
    LOGGING
    ONLINE
    SEGMENT SPACE MANAGEMENT AUTO
/
CREATE TABLESPACE APPS_TS_TX_IDX
    DATAFILE '+DATA_01' SIZE 4096M AUTOEXTEND OFF,
             '+DATA_01' SIZE 3072M AUTOEXTEND OFF,
             '+DATA_01' SIZE 3072M AUTOEXTEND OFF
    EXTENT MANAGEMENT LOCAL UNIFORM SIZE 128K
    LOGGING
    ONLINE
    SEGMENT SPACE MANAGEMENT AUTO
/
CREATE TABLESPACE CTXD
    DATAFILE '+DATA_01' SIZE 50M AUTOEXTEND OFF
    EXTENT MANAGEMENT LOCAL UNIFORM SIZE 128K
    LOGGING
    ONLINE
    SEGMENT SPACE MANAGEMENT AUTO
/
CREATE TABLESPACE APPS_TS_TOOLS
    DATAFILE '+DATA_01' SIZE 50M AUTOEXTEND OFF
    EXTENT MANAGEMENT LOCAL UNIFORM SIZE 128K
    LOGGING
    ONLINE
    SEGMENT SPACE MANAGEMENT AUTO
/


Confirm sizes of Next Gen tablespaces (system,temp,users,sysaux,undo...) to source database before running full import

Note: File Names may have changed so confirm first or run in DBArtisan

ALTER DATABASE 
DATAFILE '+DATA_01/PPMDEBIZ_XORINFDBW1D/DATAFILE/system.296.924456303' RESIZE 12G
;


ALTER DATABASE 
DATAFILE '+DATA_01/PPMDEBIZ_XORINFDBW1D/DATAFILE/system.296.924456303' AUTOEXTEND ON NEXT 100M MAXSIZE 14336M
;



on AIX Source

select count(*) from dba_data_files

47

select count(*) from dba_temp_files
2

select count(*) from dba_tablespaces

28

On Linux target

select count(*) from dba_data_files

35

select count(*) from dba_temp_files
2

select count(*) from dba_tablespaces

30


6. Copy database preparation scripts to target Oracle home 


Should be done in Step 5



7. Set up the SYS schema 

Login to xorinfdbw1d

cd  /home/oracle/tls/migratedb/PPMDEBIZ/DBA_FILES

sqlplus / as sysdba

##@audb1210.sql

!! Thats all what was missing.

@?/rdbms/admin/userlock.sql
@?/rdbms/admin/catblock.sql





8. Set up the SYSTEM schema

sqlplus 

system/locked99999


@ausy1210.sql


9. Install Java Virtual Machine 
 
   Completed before.

10. Install other required components 
   Completed before.


11. Install custom RDBMS components (conditional) 

   All set.

12. Perform patch post-install instructions 
   
    no need.


13. Disable automatic gathering of statistics 



sqlplus / as sysdba

SQL> alter system enable restricted session;

 @adstats.sql

SQL> alter system disable restricted session;


SQL> exit;


14. Back up the target database instance 




 Set database in noarchivelog mode

   cd $HOME/tls

   sqlplus / as sysdba

   @stop_archive.sql



 

  cd $HOME/tls/rman

  rman |tee backup_PPMDEBIZ_20161010.out

  connect target /

  @full_noarchivelog_backup.rman




ORA-19511: non RMAN, but media manager or vendor specific failure, error text:
   ANS1329S (RC29)   Server out of data storage space



Section 3: Export the source Release 12 database instance


1. Create the export parameter file 


go back to AIX server

cd /orahome/allu01/aetna/scripts/PPMDEBIZ/DBA_FILES

---Just to see what Oracle suggesting.
vi auexpdp.dat







--Create actual .par file

cd /oraexport/meru276/PPMDEBIZ/

vi expdp_ppmdebiz_full.par

directory=DATA_PUMP_DIR3
dumpfile=expdp_ppmdebiz_full_%U.dmp
full=y
logfile=expdp_ppmdebiz_full.log
metrics=y
parallel=4
reuse_dumpfiles=true
QUERY=applsys.wf_item_attribute_values:"where item_type!='WFERROR' and name != 'EVENT_MESSAGE'"
exclude=tablespaces
exclude=statistics
version=12


2. Shut down Applications server processes 

   Done.

3. Grant privilege to source system schema 

   
   go back to AIX server

   sqlplus / as sysdba

   grant EXEMPT ACCESS POLICY to system;


4. Remove the MGDSYS schema (conditional) 

   go back to AIX server

   sqlplus / as sysdba

   @?/md/admin/catnomgdidcode.sql


!!!!!Attention:
If the source 11g database will still be used, then the MGDSYS schema is still required.
Run the $ORACLE_HOME/md/admin/catmgdidcode.sql script on the source database after the export has completed to re-create the MGDSYS schema. 


5. Export OLAP analytical workspaces (optional) 

   Skip this step for now.


6. Drop XLA packages (optional) 

   Skip this step for now


7. Export the Applications database instance 




cd /oraexport/meru276/PPMDEBIZ/

expdp system/Z00mZ00m! parfile=expdp_ppmdebiz_full.par


Can ignore the following errors


ORA-31693: Table data object "SYSTEM"."SCHEDULER_PROGRAM_ARGS" failed to load/un
load and is being skipped due to error:
ORA-29913: error in executing ODCIEXTTABLEPOPULATE callout
ORA-00600: internal error code, arguments: [kotTrns:transient], [], [], [], [],
[], [], [], [], [], [], []







8. Export tables with XML type columns (conditional) 

   N/A - If the source database is Oracle Database 10g Release 2 (10.2.0),


9. Revoke privilege from source system schema 

   go back to AIX server

   sqlplus / as sysdba

   revoke EXEMPT ACCESS POLICY from system;



Section 4: Import the Release 12 database instance

1. Create the import parameter files 


## This is just sample file .par file.

cd  /home/oracle/tls/migratedb/PPMDEBIZ/DBA_FILES

vi auimpdp.dat

directory=dmpdir
dumpfile=aexp%U.dmp
full=y
transform=oid:n
# exclude=tablespace
# exclude=profile
# exclude=user
# exclude=role
# exclude=system_grant
# exclude=proc_system_grant
# exclude=role_grant
logfile=impdpapps.log
metrics=y

$AU_TOP/patch/115/import/aufullimp.dat




cd /oraexport/u01/PPMDEBIZ

vi impdp_create_users.par



cd /oraexport/u01/PPMDEBIZ

vi run_full_impdp.ksh
vi impdp_ppmdebiz_full.par



--Make sure appropriate data pump dir exist

sqlplus / as sysdba


CREATE OR REPLACE DIRECTORY DATA_PUMP_DIR2 AS '/oraexport/u01/PPMDEBIZ'
/
GRANT READ ON DIRECTORY DATA_PUMP_DIR2 TO EXP_FULL_DATABASE
/
GRANT WRITE ON DIRECTORY DATA_PUMP_DIR2 TO EXP_FULL_DATABASE
/
GRANT READ ON DIRECTORY DATA_PUMP_DIR2 TO IMP_FULL_DATABASE
/
GRANT WRITE ON DIRECTORY DATA_PUMP_DIR2 TO IMP_FULL_DATABASE
/
GRANT READ ON DIRECTORY DATA_PUMP_DIR2 TO SYSTEM WITH GRANT OPTION
/
GRANT WRITE ON DIRECTORY DATA_PUMP_DIR2 TO SYSTEM WITH GRANT OPTION
/





   




2. Copy the export dump files 

   Log back to AIX Server   

   cd /oraexport/meru276/PPMDEBIZ/

   scp -p expdp_ppmdebiz_full_01.dmp xorinfdbw1d:/oraexport/u01/PPMDEBIZ
   scp -p expdp_ppmdebiz_full_02.dmp xorinfdbw1d:/oraexport/u01/PPMDEBIZ
   scp -p expdp_ppmdebiz_full_03.dmp xorinfdbw1d:/oraexport/u01/PPMDEBIZ
   scp -p expdp_ppmdebiz_full_04.dmp xorinfdbw1d:/oraexport/u01/PPMDEBIZ


3. Import the Applications database instance 


  #### Create password function and profiles

   cd $HOME/tls/migratedb/PPMDEBIZ

   sqlplus / as sysdba

   @create_password_function.sql

   @create_profiles.sql



  cd /oraexport/u01/PPMDEBIZ


  impdp system/Z00mZ00m! parfile=impdp_create_users.par

   


  cd /home/oracle/tls/migratedb/PPMDEBIZ/DBA_FILES
   sqlplus / as sysdba

    grant select on sys.user$ to system;

    set trimspool on

    spool grant_sys_privs_PPMDEBIZ.out

    @grant_sys_privs_PPMDEBIZ.sql

    spool off



   sqlplus / as sysdba
   
   CREATE ROLE AD_PATCH_MONITOR_ROLE NOT IDENTIFIED;
   CREATE ROLE EM_OAM_MONITOR_ROLE NOT IDENTIFIED;



   ####Resize redo logs (Too many switches were occurring during impdp)

select * from v$logfile

MEMBER
+REDOA_01/PPMDEBIZ_XORINFDBW1D/ONLINELOG/group_3.364.924456339
+REDOB_01/PPMDEBIZ_XORINFDBW1D/ONLINELOG/group_3.364.924456339

+REDOA_01/PPMDEBIZ_XORINFDBW1D/ONLINELOG/group_2.363.924456339
+REDOB_01/PPMDEBIZ_XORINFDBW1D/ONLINELOG/group_2.363.924456339

+REDOA_01/PPMDEBIZ_XORINFDBW1D/ONLINELOG/group_1.362.924456339
+REDOB_01/PPMDEBIZ_XORINFDBW1D/ONLINELOG/group_1.362.924456339



    ALTER DATABASE ADD LOGFILE GROUP 4 ('+REDOA_01','+REDOB_01') SIZE 50M;

    Make logfile group 1 the current group

     select group#, status from v$log order by group#;

GROUP# STATUS
------ ----------
     1 CURRENT
     2 INACTIVE
     3 INACTIVE
     4 UNUSED


     alter system switch logfile; (as many times as needed)

     alter system checkpoint global;

    ### drop groups 2 and 3

    ALTER DATABASE DROP LOGFILE GROUP 2
;
    ALTER DATABASE DROP LOGFILE GROUP 3;

    ALTER DATABASE ADD LOGFILE GROUP 2 ('+REDOA_01','+REDOB_01') SIZE 200M;
    ALTER DATABASE ADD LOGFILE GROUP 3 ('+REDOA_01','+REDOB_01') SIZE 200M;

    Make logfile group 1 not the current group

     select group#, status from v$log order by group#;
     alter system switch logfile;

     alter system checkpoint global;


 GROUP# STATUS
------- --------
      1 INACTIVE
      2 CURRENT
      3 UNUSED
      4 UNUSED
select group#, status from v$log order by group#;

    ALTER DATABASE DROP LOGFILE GROUP 1;

    ALTER DATABASE ADD LOGFILE GROUP 1 ('+REDOA_01','+REDOB_01') SIZE 200M;

    ALTER DATABASE DROP LOGFILE GROUP 4
;




  
   
    


    cd /oraexport/u01/PPMDEBIZ


    nohup ./run_full_impdp.ksh PPMDEBIZ &

    PPMDEBIZ - x hours

    tail -f nohup.log

    cat nohup.out|grep -i "ora-" |egrep -v "31684|39082|39083|07443|39151|39171"




@?/rdbms/admin/utlrp.sql


select count(*)
from dba_objects
where status = 'INVALID';

select object_type,count(*)
    from dba_objects
    where status != 'VALID'
    and object_name not like 'BIN$%'
    group by object_type;


 select owner,count(*)
    from dba_objects
    where status != 'VALID'
    and object_name not like 'BIN$%'
    group by owner;




############################################# original run###########################################################
cd /oraexport/u01/PPMDEBIZ/
impdp system/locked99999 parfile=impdp_ppmdebiz_full.par 

directory=DATA_PUMP_DIR2
dumpfile=expdp_ppmdebiz_full_01.dmp,expdp_ppmdebiz_full_02.dmp,expdp_ppmdebiz_fll_03.dmp,expdp_ppmdebiz_full_04.dmp
full=y
logfile=impdp_ppmdebiz_full.log
metrics=y
PARALLEL=4

                                 


cat impdp_ppmdebiz_full.log|grep -i "ora-" |egrep -v "31684|39082|39083|07443|39151|39171"



CREATE TABLE "PPMFIN"."DSH_BUILDER_PORTLET_DEFS" ("PORTLET_DEF_ID" NUMBER(19,0)
NOT NULL ENABLE, "DATA_SOURCE" VARCHAR2(200 CHAR) NOT NULL ENABLE, "SHOW_PREFERE
NCE_SUMMARY" CHAR(1 BYTE) NOT NULL ENABLE, "REQUIRE_EDIT_BEFORE_FIRST_VIEW" CHAR
(1 BYTE) NOT NULL ENABLE, "SHOW_TOTAL" CHAR(1 CHAR)) SEGMENT CREATION IMMEDIATE
PCTFREE 10 PCTUSED 40 INITRANS 1
ORA-39083: Object type TABLE:"PPMFIN"."DSH_CHART_PORTLET_DEFS" failed to create
with error:
ORA-01950: no privileges on tablespace 'PPMFIND'
Failing sql is:


CREATE TABLE "PPMRX"."DSH_CONTAINER_SEQUENCE" ("CONTAINER_ID" NUMBER(19,0) NOT N
ULL ENABLE, "MODULE_ID" NUMBER(19,0), "SEQUENCE" NUMBER(19,0), "USER_ID" VARCHAR
2(255 BYTE) NOT NULL ENABLE, "CUSTOMER_ID" VARCHAR2(255 BYTE) NOT NULL ENABLE) S
EGMENT CREATION IMMEDIATE PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 NOCOMPRE
SS LOGGING STORAGE(INITIAL 65536 NEXT
ORA-39083: Object type TABLE:"PPMRX"."DSH_DEFAULT_MODULES" failed to create with
 error:
ORA-01950: no privileges on tablespace 'PPMRXD'


Failing sql is:
CREATE TABLE "PPMFIN"."DSH_MODULES" ("MODULE_ID" NUMBER(19,0) NOT NULL ENABLE, "
VERSION" NUMBER(10,0) NOT NULL ENABLE, "CREATED_BY" VARCHAR2(200 CHAR) NOT NULL
ENABLE, "CREATION_DATE" DATE NOT NULL ENABLE, "LAST_UPDATED_BY" VARCHAR2(200 CHA
R) NOT NULL ENABLE, "LAST_UPDATE_DATE" DATE NOT NULL ENABLE, "NAME" VARCHAR2(200
 CHAR) NOT NULL ENABLE, "UUID" VARCHAR2(50 CHA
ORA-39083: Object type TABLE:"PPMFIN"."DSH_MULTI_CHART_DEFS" failed to create wi
th error:
ORA-01950: no privileges on tablespace 'PPMFIND'



CREATE TABLE "APPS"


--Monitoring
select count(*) from dba_objects where OBJECT_TYPE = 'PACKAGE BODY'
select count(*) from dba_objects where owner ='APPS'

************************FIX START*******************************************


--drop followig users if exist

PPMRX	1170
PPMFIN	1171
APPS	127
RMLFIN	667
RMLRX	665

sqlplus / as sysdba


DROP USER PPMFIN CASCADE
;
DROP USER PPMRX CASCADE
;
DROP USER APPS CASCADE
;

DROP USER RMLFIN CASCADE
;
DROP USER RMLRX CASCADE
;

ORA-04063: APPLSYS.WF_ERROR has errors



   ---Add users to database

   ---This was done as users had many many SYS privs so was looking to cut down many of the import errors
   

  




--import only schema users

system/Z00mZ00m!
cd /oraexport/u01/PPMDEBIZ

vi impdp_ppmdebiz_schemas.par

directory=DATA_PUMP_DIR2
dumpfile=expdp_ppmdebiz_full_01.dmp,expdp_ppmdebiz_full_02.dmp,expdp_ppmdebiz_full_03.dmp,expdp_ppmdebiz_full_4.dmp
logfile=impdp_ppmdebiz_schemas.log
metrics=y
PARALLEL=4
schemas=PPMFIN,PPMFIN,APPS,RMLFIN,RMLRX


impdp system/Z00mZ00m! parfile=impdp_ppmdebiz_schemas.par

@?/rdbms/admin/utlrp.sql


select count(*)
from dba_objects
where status = 'INVALID';

1391


select object_type,count(*)
    from dba_objects
    where status != 'VALID'
    and object_name not like 'BIN$%'
    group by object_type;


OBJECT_TYPE                                                             COUNT(*)
--------------------------------------------------------------------- ----------
RULE                                                                           5
QUEUE                                                                         17
PROCEDURE                                                                      4
PACKAGE BODY                                                                 880
PACKAGE                                                                      174
RULE SET                                                                      19
TRIGGER                                                                        8
SYNONYM                                                                       32
VIEW                                                                         232
TABLE                                                                         11
FUNCTION                                                                       1




  select owner,count(*)
    from dba_objects
    where status != 'VALID'
    and object_name not like 'BIN$%'
    group by owner;



APPLSYS	56
CCT	5
XLA	4
CLM	19
PUBLIC	2
PO	10
OLAPSYS	5
PPMFIN	10
APPS	1273
RMLFIN	4
CSR	2
RMLRX	1



ALTER PACKAGE "APPS"."FII_PA_BUDGET_F_C"   COMPILE BODY     PLSQL_OPTIMIZE_LEVET
ORA-39083: Object type PACKAGE_BODY:"APPS"."FII_PA_COST_F_C" failed to create w:
ORA-04052: error occurred when looking up remote object APPS.EDW_LOCAL_INSTANCEH
ORA-00604: error occurred at recursive SQL level 3
ORA-12154: TNS:could not resolve the connect identifier specified

ORA-39082: Object type VIEW:"APPS"."GMS_ENC_PSI_V" created with compilation wars
ORA-39082: Object type VIEW:"APPS"."GMS_COMMITMENTS_OVERRIDE_V" created with cos





*******************************FIX END********************************************************

################################# END Original run######################################




4. Import OLAP analytical workspaces (conditional) 

   N/A


5. Revoke privilege from target system schema 

  Login to NextGEn DB

  sqlplus / as sysdba

  revoke EXEMPT ACCESS POLICY from system;


Section 5: Update the imported Release 12 database instance




1. Reset Advanced Queues 

scp -p /orahome/allu01/aetna/scripts/PPMDEBIZ/DBA_FILES/auque2.sql xorinfdbw1d:/home/oracle/tls/migratedb/PPMDEBIZ/DBA_FILES/auque2.sql 


ON NextGen DB

cd /home/oracle/tls/migratedb/PPMDEBIZ/DBA_FILES

sqlplus / as sysdba

@auque2.sql

APPS


2. Start the new database listener (conditional) 

   All set.


3. Run adgrants.sql 


ON NextGen DB

cd /home/oracle/tls/migratedb/PPMDEBIZ/DBA_FILES


@adgrants.sql


4. Grant create procedure privilege on CTXSYS 

ON NextGen DB

cd /home/oracle/tls/migratedb/PPMDEBIZ/DBA_FILES

Use SQL*Plus to connect to the database as APPS and run the script using the following command: 

sqlplus apps/apps

@adctxprv.sql

Z00mZ00m!

CTXSYS



5. Apply patch 6494466 (conditional) 

   N/A

6. Gather statistics for SYS schema 


ON NextGen DB

cd /home/oracle/tls/migratedb/PPMDEBIZ/DBA_FILES


$ sqlplus "/ as sysdba"
SQL> alter system enable restricted session;
SQL> @adstats.sql
$ sqlplus "/ as sysdba"
SQL> alter system disable restricted session;
SQL> exit;


7. Deregister the current database server (conditional) 


skip for now
$ sqlplus apps/[APPS password]
SQL> exec fnd_conc_clone.setup_clean;


8. Implement and run AutoConfig 


skip for now

s_dbhost New database hostname  - xorinfdbw1d
s_dbdomain New database domain name  - aetna.com
s_db_serv_sid Same SID as source  - PPMDEBIZ
s_dbSID Same SID as source  - PPMDEBIZ
s_dbservice Same SID as source  - PPMDEBIZ
s_dbport New database listener port  - 1551
s_apps_jdbc_connect_descriptor NULL 



9. Apply post-import WMS patches (conditional) 

   skip for now




10.Re-create custom database links (conditional) 


Compare DB links on Source and Target. 
if any missing. Run reverse_links.sql on AIX and recreate on Target (Linux)

select owner, db_link  from dba_db_links order by 1,2




on Ais Server

cd /orahome/allu01/aetna/scripts/PPMDEBIZ/DBA_FILES 

sqlplus / as sysdba

@reverse_links.sql PPMRX

exit

vi links_PPMRX.sql

scp /orahome/allu01/aetna/scripts/PPMDEBIZ/DBA_FILES/links_PPMRX.sql xorinfdbw1d:/home/oracle/tls/migratedb/PPMDEBIZ/DBA_FILES/links_PPMRX.sql



on Linux Server

cd /home/oracle/tls/migratedb/PPMDEBIZ/DBA_FILES

sqlpls as PPMRX/ppmrx91

@links_PPMRX.sql


11. Create ConText and AZ objects 

   skip for now


12. Import tables with XML type columns into the target database (conditional) 

    n/a


13. Populate CTXSYS.DR$SQE table 

    $ sqlplus apps/[apps password]
SQL> exec icx_cat_sqe_pvt.sync_sqes_for_all_zones;



14. Compile invalid objects 


@?/rdbms/admin/utlrp.sql


select count(*)
from dba_objects
where status = 'INVALID';


***************************************************************************************************************************

1) Full Export of AIX database PPMDEBIZ (1.5 hours)

   Logon to AIX server aorinfw1d

   cd /oraexport/meru276

   expdp system full=y version=12 dumpfile=expdp_ppmdebiz_full_%U.dmp directory=data_pump_dir2 logfile=expdp_ppmdebiz_full.log reuse_dumpfiles=true parallel=4 exclude=statistics exclude=tablespaces

   Z00mZ00m!


   Can ignore the following errors

   ORA-31693: Table data object "SYSTEM"."SCHEDULER_PROGRAM_ARGS" failed to load/unload and is being skipped due to error:
   ORA-29913: error in executing ODCIEXTTABLEPOPULATE callout
   ORA-00600: internal error code, arguments: [kotTrns:transient], [], [], [], [], [], [], [], [], [], [], []


   chmod 600 *.dmp *.log

   3 minutes to copy below in dev

   scp -p expdp_ppmdebiz_full_01.dmp xorinfdbw1d:/oraexport/u01/PPMDEBIZ
   scp -p expdp_ppmdebiz_full_02.dmp xorinfdbw1d:/oraexport/u01/PPMDEBIZ
   scp -p expdp_ppmdebiz_full_03.dmp xorinfdbw1d:/oraexport/u01/PPMDEBIZ
   scp -p expdp_ppmdebiz_full_04.dmp xorinfdbw1d:/oraexport/u01/PPMDEBIZ

   Logoff AIX server aorinfw1d


2) Recompile Any Invalids
   
   Logon Next Gen server xorinfdbw1d


   /home/oracle/tls/utility/run_utlrp.ksh PPMDEBIZ /home/oracle/tls/migratedb/PPMDEBIZ


3)  Add all init.ora settings from AIX server to Next Gen parameter file

    cd $ORACLE_HOME/dbs

    sqlplus / as sysdba

    create pfile from spfile;
    exit

    vi initPPMDEBIZ.ora

    Add all applicable entries

    sqlplus / as sysdba

    shutdown immediate;
    exit
    
    mv spfilePPMDEBIZ.ora spfilePPMDEBIZ.ora_b4_ppm_additions
  
    sqlplus / as sysdba

    startup;

    CREATE SPFILE ='$ORACLE_HOME/dbs/spfilePPMDEBIZ.ora' FROM PFILE;

    shutdown immediate;
    exit

    sqlplus / as sysdba

    startup;
    
    --Below was required to match source and the database links would not function
    ALTER DATABASE RENAME GLOBAL_NAME TO PPMDEBIZ.AETNA.COM;


4) Create and Alter tablespaces in Next Gen database.

   sqlplus / as sysdba

    CREATE TABLESPACE AEDBA
        DATAFILE '+DATA_01' SIZE 5M AUTOEXTEND ON NEXT 5M MAXSIZE 50M
        EXTENT MANAGEMENT LOCAL AUTOALLOCATE
        LOGGING
        ONLINE
        SEGMENT SPACE MANAGEMENT AUTO
    /

    CREATE TABLESPACE APPS_TS_TX_DATA
        DATAFILE '+DATA_01' SIZE 4096M AUTOEXTEND OFF,
                 '+DATA_01' SIZE 2048M AUTOEXTEND ON NEXT 10M MAXSIZE 4096M
    EXTENT MANAGEMENT LOCAL UNIFORM SIZE 128K
    LOGGING
    ONLINE
    SEGMENT SPACE MANAGEMENT AUTO
    /

   CREATE TABLESPACE ODM
       DATAFILE '+DATA_01' SIZE 20M AUTOEXTEND ON NEXT 5M MAXSIZE 50M
       EXTENT MANAGEMENT LOCAL UNIFORM SIZE 128K
       LOGGING
       ONLINE
       SEGMENT SPACE MANAGEMENT AUTO
    /

    CREATE TABLESPACE OLAP
        DATAFILE '+DATA_01' SIZE 40M AUTOEXTEND ON NEXT 5M MAXSIZE 100M
        EXTENT MANAGEMENT LOCAL UNIFORM SIZE 128K
        LOGGING
        ONLINE
        SEGMENT SPACE MANAGEMENT AUTO
    /

    CREATE TABLESPACE OWAPUB
        DATAFILE '+DATA_01' SIZE 10M AUTOEXTEND ON NEXT 5M MAXSIZE 20M
        EXTENT MANAGEMENT LOCAL UNIFORM SIZE 128K
        LOGGING
        ONLINE
        SEGMENT SPACE MANAGEMENT AUTO
    /

    CREATE TABLESPACE PORTAL
        DATAFILE '+DATA_01' SIZE 10M AUTOEXTEND ON NEXT 5M MAXSIZE 100M
        EXTENT MANAGEMENT LOCAL UNIFORM SIZE 128K
        LOGGING
        ONLINE
        SEGMENT SPACE MANAGEMENT AUTO
    /


   CREATE TABLESPACE PPMFIND
       DATAFILE '+DATA_01' SIZE 1200M AUTOEXTEND ON NEXT 10M MAXSIZE 4096M
       EXTENT MANAGEMENT LOCAL UNIFORM SIZE 128K
       LOGGING
       ONLINE
       SEGMENT SPACE MANAGEMENT AUTO
    /

    CREATE TABLESPACE PPMFINCLOB
       DATAFILE '+DATA_01' SIZE 10M AUTOEXTEND ON NEXT 10M MAXSIZE 2048M
       EXTENT MANAGEMENT LOCAL AUTOALLOCATE
       LOGGING
       ONLINE
       SEGMENT SPACE MANAGEMENT AUTO
   /

   CREATE TABLESPACE PPMFINX
       DATAFILE '+DATA_01' SIZE 10M AUTOEXTEND ON NEXT 10M MAXSIZE 2048M
       EXTENT MANAGEMENT LOCAL UNIFORM SIZE 128K
       LOGGING
       ONLINE
       SEGMENT SPACE MANAGEMENT AUTO
   /

   CREATE TABLESPACE PPMRXD
       DATAFILE '+DATA_01' SIZE 1200M AUTOEXTEND ON NEXT 10M MAXSIZE 2048M
       EXTENT MANAGEMENT LOCAL UNIFORM SIZE 128K
       LOGGING
       ONLINE
       SEGMENT SPACE MANAGEMENT AUTO
   /

   CREATE TABLESPACE PPMRXCLOB
       DATAFILE '+DATA_01' SIZE 10M AUTOEXTEND ON NEXT 10M MAXSIZE 2048M
       EXTENT MANAGEMENT LOCAL AUTOALLOCATE
       LOGGING
       ONLINE
       SEGMENT SPACE MANAGEMENT AUTO
   /

   CREATE TABLESPACE PPMRXX
       DATAFILE '+DATA_01' SIZE 10M AUTOEXTEND ON NEXT 10M MAXSIZE 2048M
       EXTENT MANAGEMENT LOCAL UNIFORM SIZE 128K
       LOGGING
       ONLINE
       SEGMENT SPACE MANAGEMENT AUTO
   /

   CREATE TEMPORARY TABLESPACE TEMP1
     TEMPFILE '+DATA_01' SIZE 500M AUTOEXTEND ON NEXT 10M MAXSIZE 8192M

     EXTENT MANAGEMENT LOCAL UNIFORM SIZE 1M
   /

   ALTER DATABASE 
TEMPFILE '+DATA_01/PPMDEBIZ_XORINFDBW1D/TEMPFILE/temp.279.920640483' AUTOEXTEND ON NEXT 10M MAXSIZE 8192M
;

   ALTER DATABASE 
DATAFILE '+DATA_01/PPMDEBIZ_XORINFDBW1D/DATAFILE/undotbs1.320.920640041' AUTOEXTEND ON NEXT 10M MAXSIZE 8192M
;

   
CREATE UNDO TABLESPACE APPS_UNDOTS1
    DATAFILE '+DATA_01' SIZE 10240M AUTOEXTEND OFF,
             '+DATA_01' SIZE 10240M AUTOEXTEND OFF,
             '+DATA_01' SIZE 10240M AUTOEXTEND OFF
    EXTENT MANAGEMENT LOCAL AUTOALLOCATE
    ONLINE
/
CREATE TABLESPACE APPS_TS_ARCHIVE
    DATAFILE '+DATA_01' SIZE 600M AUTOEXTEND OFF
    EXTENT MANAGEMENT LOCAL UNIFORM SIZE 128K
    LOGGING
    ONLINE
    SEGMENT SPACE MANAGEMENT AUTO
/
CREATE TABLESPACE APPS_TS_INTERFACE
    DATAFILE '+DATA_01' SIZE 800M AUTOEXTEND OFF
    EXTENT MANAGEMENT LOCAL UNIFORM SIZE 128K
    LOGGING
    ONLINE
    SEGMENT SPACE MANAGEMENT AUTO
/
CREATE TABLESPACE APPS_TS_MEDIA
    DATAFILE '+DATA_01' SIZE 1200M AUTOEXTEND OFF
    EXTENT MANAGEMENT LOCAL UNIFORM SIZE 128K
    LOGGING
    ONLINE
    SEGMENT SPACE MANAGEMENT AUTO
/
CREATE TABLESPACE APPS_TS_NOLOGGING
    DATAFILE '+DATA_01' SIZE 100M AUTOEXTEND OFF
    EXTENT MANAGEMENT LOCAL UNIFORM SIZE 128K
    LOGGING
    ONLINE
    SEGMENT SPACE MANAGEMENT AUTO
/
CREATE TABLESPACE APPS_TS_QUEUES
    DATAFILE '+DATA_01' SIZE 100M AUTOEXTEND OFF,
             '+DATA_01' SIZE 100M AUTOEXTEND OFF
    EXTENT MANAGEMENT LOCAL UNIFORM SIZE 128K
    LOGGING
    ONLINE
    SEGMENT SPACE MANAGEMENT AUTO
/
CREATE TABLESPACE APPS_TS_SEED
    DATAFILE '+DATA_01' SIZE 2048M AUTOEXTEND OFF,
             '+DATA_01' SIZE 2048M AUTOEXTEND OFF
    EXTENT MANAGEMENT LOCAL UNIFORM SIZE 128K
    LOGGING
    ONLINE
    SEGMENT SPACE MANAGEMENT AUTO
/
CREATE TABLESPACE APPS_TS_SUMMARY
    DATAFILE '+DATA_01' SIZE 1200M AUTOEXTEND OFF
    EXTENT MANAGEMENT LOCAL UNIFORM SIZE 128K
    LOGGING
    ONLINE
    SEGMENT SPACE MANAGEMENT AUTO
/
CREATE TABLESPACE APPS_TS_TX_IDX
    DATAFILE '+DATA_01' SIZE 4096M AUTOEXTEND OFF,
             '+DATA_01' SIZE 3072M AUTOEXTEND OFF,
             '+DATA_01' SIZE 3072M AUTOEXTEND OFF
    EXTENT MANAGEMENT LOCAL UNIFORM SIZE 128K
    LOGGING
    ONLINE
    SEGMENT SPACE MANAGEMENT AUTO
/
CREATE TABLESPACE CTXD
    DATAFILE '+DATA_01' SIZE 50M AUTOEXTEND OFF
    EXTENT MANAGEMENT LOCAL UNIFORM SIZE 128K
    LOGGING
    ONLINE
    SEGMENT SPACE MANAGEMENT AUTO
/
CREATE TABLESPACE APPS_TS_TOOLS
    DATAFILE '+DATA_01' SIZE 50M AUTOEXTEND OFF
    EXTENT MANAGEMENT LOCAL UNIFORM SIZE 128K
    LOGGING
    ONLINE
    SEGMENT SPACE MANAGEMENT AUTO
/


Confirm sizes of Next Gen tablespaces (system,temp,users,sysaux,undo...) to source database before running full import

Note: File Names may have changed so confirm first or run in DBArtisan

ALTER DATABASE
DATAFILE '+DATA_01/PPMDEBIZ_XORINFDBW1D/DATAFILE/system.312.922175961' RESIZE 12G
;


ALTER DATABASE
DATAFILE '+DATA_01/PPMDEBIZ_XORINFDBW1D/DATAFILE/system.312.922175961' AUTOEXTEND ON NEXT 100M MAXSIZE 14336M
;



5) Set database in noarchivelog mode

   cd $HOME/tls

   sqlplus / as sysdba

   @stop_archive.sql


6) Create password function and profiles

   cd $HOME/tls/migratedb/PPMDEBIZ

   sqlplus / as sysdba

   @create_password_function.sql

   @create_profiles.sql


7) Add users to database

   This was done as users had many many SYS privs so was looking to cut down many of the import errors
   
   impdp parfile=impdp_create_users.par

   system/Z00mZ00m!

   mv /oraexport/u01/PPMDEBIZ/impdp_ppmdebiz_users.log $HOME/tls/migratedb/PPMDEBIZ


8) Extract SYS and CTXSYS Privs

   Run the following on the AIX server

   cd /orahome/allu01/app/oracle/tls/migratedb/PPMDEBIZ

   sqlplus / as sysdba

   @ext_grant_sys_privs.sql PPMDEBIZ

   select dbms_metadata.get_ddl('PACKAGE', 'AD_DBMS_METADATA', 'SYS') from dual;
   select dbms_metadata.get_ddl('PACKAGE_BODY', 'AD_DBMS_METADATA', 'SYS') from dual;

   scp -p grant_sys_privs_PPMDEBIZ.sql xorinfdbw1d.aetna.com:/home/oracle/tls/migratedb/PPMDEBIZ

   Logoff the AIX server


9) Create roles for sys privs

   sqlplus / as sysdba
   
   CREATE ROLE AD_PATCH_MONITOR_ROLE NOT IDENTIFIED;
   CREATE ROLE EM_OAM_MONITOR_ROLE NOT IDENTIFIED;


10)  Create Temp Directory To Prevent Errors on Full Import

     CREATE OR REPLACE DIRECTORY DATA_PUMP_DIR2 AS '/oraexport/u01/PPMDEBIZ/';
     GRANT READ ON DIRECTORY DATA_PUMP_DIR2 TO EXP_FULL_DATABASE;
     GRANT WRITE ON DIRECTORY DATA_PUMP_DIR2 TO EXP_FULL_DATABASE;
     GRANT READ ON DIRECTORY DATA_PUMP_DIR2 TO IMP_FULL_DATABASE;
     GRANT WRITE ON DIRECTORY DATA_PUMP_DIR2 TO IMP_FULL_DATABASE;


11) Create Package, MGDSYS user, and Assign SYS Privs




    sqlplus / as sysdba

    @create_sys_objects.sql

    @create_adctx_ddl.sql

    grant select on sys.user$ to system;

    set trimspool on

    spool grant_sys_privs_PPMDEBIZ.out

    @grant_sys_privs_PPMDEBIZ.sql

    spool off


    Below in support of Metalink Note 2013213.1

    sqlplus / as sysdba

    ALTER PROFILE DEFAULT LIMIT 
PASSWORD_VERIFY_FUNCTION NULL;
    exit

    cd $ORACLE_HOME/rdbms/admin

    sqlplus / as sysdba
 
    @catmgd.sql

    ALTER PROFILE DEFAULT LIMIT 
PASSWORD_VERIFY_FUNCTION AI_PASSWORD_VALIDATE
_V2;

    exit;


12) Resize redo logs (Too many switches were occurring during impdp)


    ALTER DATABASE ADD LOGFILE GROUP 4 ('+REDOA_01','+REDOB_01') SIZE 50M;

    Make logfile group 1 the current group

     select group#, status from v$log order by group#;
     alter system switch logfile; (as many times as needed)

     alter system checkpoint global;

    drop groups 2 and 3

    ALTER DATABASE DROP LOGFILE GROUP 2
;
    ALTER DATABASE DROP LOGFILE GROUP 3;

    ALTER DATABASE ADD LOGFILE GROUP 2 ('+REDOA_01','+REDOB_01') SIZE 200M;
    ALTER DATABASE ADD LOGFILE GROUP 3 ('+REDOA_01','+REDOB_01') SIZE 200M;

    Make logfile group 1 not the current group

     select group#, status from v$log order by group#;
     alter system switch logfile;

     alter system checkpoint global;

    ALTER DATABASE DROP LOGFILE GROUP 1;

    ALTER DATABASE ADD LOGFILE GROUP 1 ('+REDOA_01','+REDOB_01') SIZE 200M;

    ALTER DATABASE DROP LOGFILE GROUP 4
;

   
    Logon to ASM and remove old log files



13) Take backup before import (No Catalog Connection)

    cd $HOME/tls/rman

    rman |tee backup_PPMDEBIZ_b4_full_impdp.out

    connect target /

    @full_noarchivelog_backup.rman


14) Do Full Import
   
    cd $HOME/tls/migratedb/PPMDEBIZ

    nohup ./run_full_impdp.ksh PPMDEBIZ &

    PPMDEBIZ - x hours

    tail -f nohup.log

    cat nohup.out|grep -i "ora-" |egrep -v "31684|39082|39083|07443|39151|39171"

    mv /oraexport/u01/PPMDEBIZ/impdp_ppmdebiz.log $HOME/tls/migratedb/PPMDEBIZ

  

15) Create indexes that had duplicate colum names in the index (ORA-54015: Duplicate column expression was specified)

    cd $HOME/tls/migratedb/PPMDEBIZ

    Indexes APPS.I_SNAP$_BIV_B_AGE_H_SUM_MV and APPS.I_SNAP$_FEM_BAL_NACC_HIER_1

    sqlplus / as sysdba

    @create_indexes_with_dup_columns.sql



16) Look For SYS owned Triggers in Source Database

    Identify all not in new database and bring over to target database.

    N/A to PPMDEBIZ as all triggers existed in the target database.


    Run in Source Database on AIX server

    sqlplus / as sysdba

    SELECT owner, trigger_name, trigger_type, triggering_event, table_owner, base_object_type, status 
    FROM dba_triggers 
    WHERE owner='SYS'
    ORDER BY 2;


17) Recompile Any Invalids
   
    /home/oracle/tls/utility/run_utlrp.ksh PPMDEBIZ /home/oracle/tls/migratedb/PPMDEBIZ


18) Compare invalid counts between source and target

    select object_type,count(*)
    from dba_objects
    where status != 'VALID'
    and object_name not like 'BIN$%'
    group by object_type;

    Source 

    OBJECT_TYPE	COUNT(*)
    PROCEDURE		8
    PACKAGE BODY	4
    SYNONYM		7
    VIEW		12

    Target

    OBJECT_TYPE	COUNT(*)
    PROCEDURE		8
    PACKAGE BODY	5 
       1 (APPS.WMS_EPC_PVT) references MGDSYS objects - user does not exist
    SYNONYM		7
    VIEW		11

 
19) Configure database and gather stats for database since stats were excluded during the export

    cd $HOME/tls/migratedb/PPMDEBIZ

    sqlplus / as sysdba

    exec dbms_stats.set_global_prefs(pname=>'NO_INVALIDATE',pvalue=>'FALSE');
    select  dbms_stats.get_param('NO_INVALIDATE') from dual;

    select dbms_stats.get_param('DEGREE') from dual; 
    exec DBMS_STATS.SET_PARAM('DEGREE','2'); 
    exit

    nohup ./analyze_auto.ksh PPMDEBIZ &


20) Add all necessary entries to tnsnames.ora file in support of database links


21) Move aud$ back to tablespace AUDIT_SPACE

    truncate table sys.aud$;

    BEGIN
     dbms_audit_mgmt.set_audit_trail_location(
     audit_trail_type => dbms_audit_mgmt.audit_trail_db_std,
     audit_trail_location_value => 'AUDIT_SPACE');
    END;
    /


22) Initialize the audit cleanup

    BEGIN
    DBMS_AUDIT_MGMT.INIT_CLEANUP(
    audit_trail_type          => DBMS_AUDIT_MGMT.AUDIT_TRAIL_AUD_STD,
    default_cleanup_interval  => 24 /* hours */);
    END;


    Run following to confirm all is well:

    BEGIN DBMS_AUDIT_MGMT.SET_LAST_ARCHIVE_TIMESTAMP(AUDIT_TRAIL_TYPE =>
 DBMS_AUDIT_MGMT.AUDIT_TRAIL_AUD_STD, LAST_ARCHIVE_TIME => sysdate-30); END;
    
    BEGIN DBMS_AUDIT_MGMT.CLEAN_AUDIT_TRAIL(1, TRUE, 1);  END;


23) Alter all profiles using function AI_PASSWORD_VALIDATE to use new function AI_PASSWORD_VALIDATE_V2

    sqlplus / as sysdba

    ALTER PROFILE EXPIRE_DBA_PWD LIMIT 
PASSWORD_VERIFY_FUNCTION AI_PASSWORD_VALIDATE_V2
;
    ALTER PROFILE EXPIRE_USER_PWD LIMIT 
PASSWORD_VERIFY_FUNCTION AI_PASSWORD_VALIDATE_V2
;
    ALTER PROFILE NOEXPIRE_USER_PWD LIMIT 
PASSWORD_VERIFY_FUNCTION AI_PASSWORD_VALIDATE_V2
;


24) Start queue process

    Below in support of Metalink Note 334237.1

    sqlplus / as sysdba

    alter session set current_schema=APPS;

    exec dbms_aqadm.start_queue(queue_name=>'APPLSYS.AQ$_WF_CONTROL_E',dequeue =>TRUE,enqueue=>FALSE);


25) Take backup before import (No Catalog Connection)

    cd $HOME/tls/rman

    rman |tee backup_PPMDEBIZ_aft_full_impdp.out

    connect target /

    @full_noarchivelog_backup.rman


26) Put database in archivelog mode

    cd $HOME/tls

    sqlplus / as sysdba

    @start_archive.sql


27) Upgrade catalog and register database to RCATDEV

    rman
    rman => connect target /
    rman => connect catalog PPMDEBIZ/PPMDEBIZnamr@RCATDEV
    rman => upgrade catalog;
    rman => upgrade catalog;
    rman => register database;


28) Take a database backup

    cd /orahome/u01/app/oracle/local/scripts/backup

    nohup rman_backup_ppm.ksh PPMDEBIZ RCATDEV incremental_level0_backup_tape_ppm.rman Y &


29) Shutdown AIX Database
