Pimary Database:       TARGET (WKABQA13
Duplicate Database :    AUX    (WKABDEV3)
RMAN Catalog Database: RMAN   (RCATDEV)


Target Database wkabqa3 reside on boraw1q server
Aux Database wkabdev3 reside on boraw1d Server


Prior to duplicate we need to Save last backup on wkabqa1 which will be used in future to restoration (duplication) over to Dev3.


. $SETUPENV wkabqa3

cd $INSTANCE_OUTPUTS\rman_backups

ls -altr
-rw-r-----    1 oracle   dba       185968128 Sep 26 04:00 bkp_df762840021_s5578_s1

-rw-r-----    1 oracle   dba      5800009728 Sep 26 04:14 bkp_df762840050_s5579_s1

-rw-r-----    1 oracle   dba         1845248 Sep 26 04:14 bkp_df762840847_s5580_s1

-rw-r-----    1 oracle   dba         7847936 Sep 26 04:14 c-168335963-20110926-00


rman
connect target /
connect catalog wkabqa3/wkabqa3namr@RCATDEV

list backup summary;


71345   B  A  A DISK        26-SEP-11       1       1       YES        L0_BACKUP
71368   B  0  A DISK        26-SEP-11       1       1       YES        L0_BACKUP
71402   B  A  A DISK        26-SEP-11       1       1       YES        L0_BACKUP
71429   B  F  A DISK        26-SEP-11       1       1       NO         TAG20110926T041410







********* Safe backupsets ***************


# CHANGE BACKUPSET 1322254 KEEP FOREVER;
#  DELETE NOPROMPT BACKUPSET 1322231;
 
#restore database until sequence 4736;
#recover database until sequence 4736;

#Sort of.  I just did a 
 
#change backupset xxxx keep forever;


CHANGE BACKUPSET 71345 KEEP FOREVER;
CHANGE BACKUPSET 71368 KEEP FOREVER;
CHANGE BACKUPSET 71402 KEEP FOREVER;
CHANGE BACKUPSET 71429 KEEP FOREVER;




***** Archive to TSM


-rw-r-----    1 oracle   dba       185968128 Sep 26 04:00 bkp_df762840021_s5578_s1

-rw-r-----    1 oracle   dba      5800009728 Sep 26 04:14 bkp_df762840050_s5579_s1

-rw-r-----    1 oracle   dba         1845248 Sep 26 04:14 bkp_df762840847_s5580_s1

-rw-r-----    1 oracle   dba         7847936 Sep 26 04:14 c-168335963-20110926-00

#dsmc archive -archmc=B30D_A1Y /boraw1qu101/wkabqa3/rman_backups/bkp_df762840021_s5578_s1
#dsmc archive -archmc=B30D_A1Y /boraw1qu101/wkabqa3/rman_backups/bkp_df762840050_s5579_s1
#dsmc archive -archmc=B30D_A1Y /boraw1qu101/wkabqa3/rman_backups/bkp_df762840847_s5580_s1
#dsmc archive -archmc=B30D_A1Y /boraw1qu101/wkabqa3/rman_backups/c-168335963-20110926-00



*** Capture sequence for duplication ************





select sequence#,completion_time, next_change# as scn 
         from v$archived_log 
            order by completion_time desc;

8273	09/26/2011 4:14:05.000 AM	8255105329003	   
8272	09/26/2011 4:00:19.000 AM	8255105322340	   	   






------>TARGET WKABQA3 Directory and datafile location<----------------- 

   ORACLE_HOME: /orahome/wkab01/app/oracle/product/11.2.0/db_2
   ORACLE_BASE: /orahome/wkab01/app/oracle
  
   /boraw1qu01/app/oracle/admin/wkabqa3/diag


  /boraw1qu101/wkabqa3/rman_backups

  /boraw1qu101/wkabqa3/arch

   /boraw1qu01/aetna/scripts


select file_id,file_name from dba_data_files order by 2

FILE_ID	FILE_NAME	   
7	/boraw1qu203/oradata/wkabqa3/sysaux01.dbf	   
1	/boraw1qu203/oradata/wkabqa3/system_01.dbf	   
2	/boraw1qu203/oradata/wkabqa3/undotbs_01.dbf	   
18	/boraw1qu204/oradata/wkabqa3/TAEDBA2.dbf	   
3	/boraw1qu204/oradata/wkabqa3/beneng_data_01.dbf	   
5	/boraw1qu204/oradata/wkabqa3/beneng_index_01.dbf	   
20	/boraw1qu204/oradata/wkabqa3/tivoliorts01.dbf	   
11	/boraw1qu204/oradata/wkabqa3/wkab_data_01.dbf	   
13	/boraw1qu204/oradata/wkabqa3/wkab_index_01.dbf	   
15	/boraw1qu204/oradata/wkabqa3/wkab_lob_01.dbf	   
4	/boraw1qu205/oradata/wkabqa3/beneng_data_02.dbf	   
6	/boraw1qu205/oradata/wkabqa3/beneng_index_02.dbf	   
17	/boraw1qu205/oradata/wkabqa3/ejsadmin_01.dbf	   
19	/boraw1qu205/oradata/wkabqa3/users_01.dbf	   
12	/boraw1qu205/oradata/wkabqa3/wkab_data_02.dbf	   
14	/boraw1qu205/oradata/wkabqa3/wkab_index_02.dbf	   
16	/boraw1qu205/oradata/wkabqa3/wkab_lob_02.dbf	   
8	/boraw1qu205/oradata/wkabqa3/xdb_01.dbf	   
		   
			
	



	
select file_id,file_name  from dba_temp_files order by 1

FILE_ID	FILE_NAME	   
1	/boraw1qu203/oradata/wkabqa3/temp01.dbf	   
2	/boraw1qu203/oradata/wkabqa3/tivoliortempts.dbf	   
		  
		
	

	

select * from v$logfile

GROUP#	STATUS	TYPE	MEMBER	IS_RECOVERY_DEST_FILE	   
3	[NULL]	ONLINE	/boraw1qu203/oradata/wkabqa3/redo03.log	NO	   
2	[NULL]	ONLINE	/boraw1qu203/oradata/wkabqa3/redo02.log	NO	   
1	[NULL]	ONLINE	/boraw1qu203/oradata/wkabqa3/redo01.log	NO	   
						   
					
			



			
select * from v$controlfile

STATUS	NAME	IS_RECOVERY_DEST_FILE	BLOCK_SIZE	FILE_SIZE_BLKS	   
[NULL]	/boraw1qu203/oradata/wkabqa3/control01.ctl	NO	8192	952	   
[NULL]	/boraw1qu203/oradata/wkabqa3/control02.ctl	NO	8192	952	   
[NULL]	/boraw1qu203/oradata/wkabqa3/control03.ctl	NO	8192	952	   
					   
						




------>AUX WKABDEV3 Directory and datafile location<----------------- 

   ORACLE_HOME: /orahome/wkab01/app/oracle/product/11.2.0/db_1
   ORACLE_BASE: /orahome/wkab01/app/oracle
   
   /orahome/wkab01/app/oracle/admin/wkabdev3/diag
   
   /boraw1du101/wkabdev3/rman_backups


select file_id,file_name from dba_data_files order by 1
	
FILE_ID	FILE_NAME	   
1	/boraw1du205/oradata/wkabdev3/system_01.dbf	   
2	/boraw1du205/oradata/wkabdev3/undotbs_01.dbf	   
3	/boraw1du205/oradata/wkabdev3/beneng_data_01.dbf	   
4	/boraw1du205/oradata/wkabdev3/beneng_data_02.dbf	   
5	/boraw1du205/oradata/wkabdev3/beneng_index_01.dbf	   
6	/boraw1du205/oradata/wkabdev3/beneng_index_02.dbf	   
7	/boraw1du205/oradata/wkabdev3/sysaux01.dbf	   
11	/boraw1du205/oradata/wkabdev3/wkab_data_01.dbf	   
12	/boraw1du205/oradata/wkabdev3/wkab_data_02.dbf	   
13	/boraw1du205/oradata/wkabdev3/wkab_index_01.dbf	   
14	/boraw1du205/oradata/wkabdev3/wkab_index_02.dbf	   
15	/boraw1du205/oradata/wkabdev3/wkab_lob_01.dbf	   
16	/boraw1du205/oradata/wkabdev3/wkab_lob_02.dbf	   
17	/boraw1du205/oradata/wkabdev3/ejsadmin_01.dbf	   
18	/boraw1du205/oradata/wkabdev3/TAEDBA2.dbf	   
19	/boraw1du205/oradata/wkabdev3/users_01.dbf	   
20	/boraw1du205/oradata/wkabdev3/tivoliorts01.dbf	   
		


select file_id,file_name  from dba_temp_files order by 1

FILE_ID	FILE_NAME	   
1	/boraw1du205/oradata/wkabdev3/temp_01.dbf	   
2	/boraw1du205/oradata/wkabdev3/tivoliortempts.dbf	   
		

select * from v$logfile

GROUP#	STATUS	TYPE	MEMBER	IS_RECOVERY_DEST_FILE	   
3	[NULL]	ONLINE	/boraw1du205/oradata/wkabdev3/redo03.log	NO	   
2	[NULL]	ONLINE	/boraw1du205/oradata/wkabdev3/redo02.log	NO	   
1	[NULL]	ONLINE	/boraw1du205/oradata/wkabdev3/redo01.log	NO


select * from v$controlfile

STATUS	NAME	IS_RECOVERY_DEST_FILE	BLOCK_SIZE	FILE_SIZE_BLKS	   
[NULL]	/boraw1du205/oradata/wkabdev3/control01.ctl	NO	16384	514	   
[NULL]	/boraw1du205/oradata/wkabdev3/control02.ctl	NO	16384	514	   
[NULL]	/boraw1du205/oradata/wkabdev3/control03.ctl	NO	16384	514	   
					
	   




1. Create directory or symbolic link on AUX Server and copy backupsets over
   
   cd /boraw1qu101/wkabqa3/rman_backups



I used to be able to do similar links. But some reason I am getting this error:

ln -s /boraw1du101/wkabdev3/backup_temp /boraw1qu101/wkabqa1/rman_backups
 
ln: No such file or directory

cd /boraw1du101/wkabdev3/
mkdir rman_backups_qa3


-rw-r-----    1 oracle   dba       185968128 Sep 26 04:00 bkp_df762840021_s5578_s1

-rw-r-----    1 oracle   dba      5800009728 Sep 26 04:14 bkp_df762840050_s5579_s1

-rw-r-----    1 oracle   dba         1845248 Sep 26 04:14 bkp_df762840847_s5580_s1

-rw-r-----    1 oracle   dba         7847936 Sep 26 04:14 c-168335963-20110926-00

nohup scp -rp /boraw1qu101/wkabqa3/rman_backups/bkp_df762840021_s5578_s1 boraw1d:/boraw1du101/wkabdev3/rman_backups_qa3/bkp_df762840021_s5578_s1
nohup scp -rp /boraw1qu101/wkabqa3/rman_backups/bkp_df762840050_s5579_s1 boraw1d:/boraw1du101/wkabdev3/rman_backups_qa3/bkp_df762840050_s5579_s1
nohup scp -rp /boraw1qu101/wkabqa3/rman_backups/bkp_df762840847_s5580_s1 boraw1d:/boraw1du101/wkabdev3/rman_backups_qa3/bkp_df762840847_s5580_s1
nohup scp -rp /boraw1qu101/wkabqa3/rman_backups/c-168335963-20110926-00 boraw1d:/boraw1du101/wkabdev3/rman_backups_qa3/c-168335963-20110926-00



cd /

mkdir /boraw1qu101
cd /boraw1qu101
mkdir wkabqa3


ln -s /boraw1du101/wkabdev3/rman_backups_qa3 /boraw1qu101/wkabqa3/rman_backups


*** Now we can see it 

cd /boraw1qu101/wkabqa3/rman_backups


2. Move init file from TARGET server to AUX server  However I would get latest in case any changes.
  



   . $SETUPENV wkabqa3
   cd $ORACLE_HOME/dbs
   sqlplus / as sysdba
   create pfile from spfile;
   exit
   

   scp  /orahome/wkab01/app/oracle/product/11.2.0/db_2/dbs/initwkabqa3.ora boraw1d.aetna.com:/orahome/wkab01/app/oracle/product/11.2.0/db_1/dbs/initwkabdev3_QA3.ora 

  
 . $SETUPENV wkabdev3
   cd $ORACLE_HOME/dbs
  
 vi initwkabdev3_QA3.ora


/boraw1qu203/oradata/wkabqa3/ - 11 GB
/boraw1qu204/oradata/wkabqa3/ - 17 GB
/boraw1qu205/oradata/wkabqa3/ - 16 GB

*.control_files='/boraw1du205/oradata/wkabdev3/control01.ctl','/boraw1du205/oradata/wkabdev3/control02.ctl','/boraw1du205/oradata/wkabdev3/control03.ctl'


*.db_file_name_convert='/boraw1qu203/oradata/wkabqa3/','/boraw1du205/oradata/wkabdev3/','/boraw1qu204/oradata/wkabqa3/','/boraw1du205/oradata/wkabdev3/','/boraw1qu205/oradata/wkabqa3/','/boraw1du205/oradata/wkabdev3/'


*.log_file_name_convert='/boraw1qu203/oradata/wkabqa3/','/boraw1du205/oradata/wkabdev3/'


*.diagnostic_dest='/orahome/wkab01/app/oracle/admin/wkabdev3/'

*.log_archive_dest_1='LOCATION=/boraw1du101/wkabdev3/arch'
*.utl_file_dir='/boraw1du01/wkabdev3/Utl_File_Dir'
*._compression_compatibility='11.2.0'

4. Create password file on AUX server. Check these could be completed before. 
  
   cd $ORACLE_HOME/dbs
   orapwd file=$ORACLE_HOME/dbs/orapwwkabdev3 password=no734s entries=10



   !!!Add oratab entry for new database

   wkabdev3:/orahome/wkab01/app/oracle/product/11.2.0/db_1:N:/boraw1du01:/boraw1du101




 
5.    Test connection from AUX(wkabdev3) server to TARGET (wkabqa1)   

   . $SETUPENV wkabdev3

   rman
   
   connect target sys/no734s@wkabqa1
   connect catalog wkabqa3/wkabqa3namr@RCATDEV
   connect AUXILIARY /
   #connect AUXILIARY sys/no734s@wkabtrg1




6. If this clone repeat process or AUX database exist then
   delete all datafiles,redo logs and control files in AUX (wkabdev3) database

   Make sure . $SETUPENV wkabdev3

   AUX database (WKABDEV3)

   cd $ORACLE_HOME/dbs

   mv spfilewkabdev3.ora spfilewkabdev3_YYYYMMDD.ora

   sqlplus / as sysdba
   shutdown immediate; 


   
   #Confirm
   ls /boraw1du*/oradata/wkabdev3/*
 
   #Remove
   rm /boraw1du*/oradata/wkabdev3/*

   #Confirm again
   ls /boraw1du*/oradata/wkabdev3/*


   #Optional delete old trace and log files

  cd /orahome/wkab01/app/oracle/admin/wkabdev3

   rm -rf ./diag
 

   cd $ORACLE_HOME/dbs
   # to have backup in case. If file exist.
   
   mv initwkabdev3.ora initwkabdev3_YYYYMMDD.ora
   mv spfilewkabdev3.ora spfilewkabdev3_YYYYMMDD.ora
   
   mv initwkabdev3_QA3.ora initwkabdev3.ora

   

7. AUX (WKABDEV3) database
    Make sure . $SETUPENV wkabdev3

    sqlplus / as sysdba
   startup pfile=/orahome/wkab01/app/oracle/product/11.2.0/db_1/dbs/initwkabdev3.ora force nomount;
   #startup pfile=/orahome/wkab01/app/oracle/product/11.2.0/db_1/dbs/initwkabdev3.ora;
    startup force nomount;
####################################################################################################################
10. AUX (WKABDEV3) database
    Make sure . $SETUPENV wkabdev3

cd /boraw1qu101/wkabqa1/rman_backups

select sequence#,thread#,completion_time, next_change# as scn 
         from v$archived_log 
            order by completion_time desc;


7201	09/14/2011 3:14:38.000 AM	8255084565517	   
7200	09/14/2011 3:00:43.000 AM	8255084560716

7199	1	09/14/2011 1:07:27.000 AM	8255084520219	   	   

## use latest 7201

# set until scn 8255084565517;

# set until sequence 7201 thread 1;

    
#  set until time "TO_DATE('09/14/2011:03:14:38', 'MM/DD/YYYY HH24:MI S')";
#  set until time "TO_DATE('09/14/2011:03:14:38','MM/DD/YYYY HH24:MI S')"; -- did not work
  
#set until time "TO_DATE('09/14/2011 03:14:43','MM/DD/YYYY HH24:MI:SS')";

   rman
   
   connect target sys/no734s@wkabqa1
   connect catalog wkabqa3/wkabqa3namr@RCATDEV
   connect AUXILIARY /

connect AUXILIARY sys/no734s@wkabdev3


#  SPOOL LOG TO 'dup2.txt'
#   run {
#        set until time "TO_DATE('09/14/2011 03:14:43','MM/DD/YYYY HH24:MI:SS')";
#        duplicate target database to wkabdev3;
#   }
#   SPOOL LOG OFF; 

#duplicate target database to wkabdev3 until time "TO_DATE('09/14/2011 03:14:43','MM/DD/YYYY HH24:MI:SS')";



!!!!!!!!!!!!!!! This worked

rman
connect AUXILIARY /
run {

 DUPLICATE DATABASE TO 'wkabdev3' BACKUP LOCATION '/boraw1qu101/wkabqa3/rman_backups';
}

************************************

connected to auxiliary database (not started)
RMAN-00571: ===========================================================
RMAN-00569: =============== ERROR MESSAGE STACK FOLLOWS ===============
RMAN-00571: ===========================================================
RMAN-03002: failure of Duplicate Db command at 09/14/2011 11:41:04
RMAN-06403: could not obtain a fully authorized session
RMAN-04006: error from auxiliary database: ORA-01034: ORACLE not available
ORA-27101: shared memory realm does not exist
IBM AIX RISC System/6000 Error: 2: No such file or directory
RMAN-03015: error occurred in stored script Memory Script
RMAN-04014: startup failed: ORA-00600: internal error code, arguments: [kck_rls_
check must use (11,0,0,0,0) or lower], [kdt.c], [9576], [11.2.0.2.0], [], [], []
, [], [], [], [], []
RMAN-04017: startup error description: ORA-32004: obsolete or deprecated paramet
er(s) specified for RDBMS instance


ORA-01078: failure in processing system parameters


rrors in file /orahome/wkab01/app/oracle/admin/wkabdev3/diag/rdbms/wkabdev3/wka
dev3/trace/wkabdev3_ora_4165716.trc  (incident=3921):
ORA-00600: internal error code, arguments: [kck_rls_check must use (11,0,0,0,0) or lower], [kdt.c], [9576], [11.2.0.2.0], [], [], [], [], [], [], [], []

ncident details in: /orahome/wkab01/app/oracle/admin/wkabdev3/diag/rdbms/wkabde3/wkabdev3/incident/incdir_3921/wkabdev3_ora_4165716_i3921.trc

weep [inc][3921]: completed
se ADRCI or Support Workbench to package the incident.
ee Note 411.1 at My Oracle Support for error and packaging details.

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
ORA-0600 [KCK_RLS_CHECK Must Use (11,0,0,0,0) or Lower] Whwn Starting From Newly Created SPFILE [ID 1064264.1]

_compression_compatibility= "11.2.0"

ALso fixed *.log_archive_dest_1='LOCATION=/boraw1du101/wkabdev3/arch'
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

channel ORA_AUX_DISK_1: starting datafile backup set restore
channel ORA_AUX_DISK_1: restoring control file
channel ORA_AUX_DISK_1: reading from backup piece /boraw1qu101/wkabqa1/rman_back
ups/c-472815084-20110913-01
channel ORA_AUX_DISK_1: ORA-19870: error while restoring backup piece /boraw1qu1
01/wkabqa1/rman_backups/c-472815084-20110913-01
ORA-19505: failed to identify file "/boraw1qu101/wkabqa1/rman_backups/c-472815084-20110913-01"
4-20110913-01"
ORA-27037: unable to obtain file status
IBM AIX RISC System/6000 Error: 2: No such file or directory



13. Move Database to NONEARCHIVELOG

SQL> shutdown immediate;
startup mount;

SQL> alter database noarchivelog;
##SQL> alter database archivelog;

Database altered.


SQL> alter database open;

Database altered.

SQL> archive log list;

alter database rename global_name to WKABDEV3.WORLD;
alter user wkab10 identified by wkab10_wkabdev3;
alter user beneng identified by beneng_wkabdev3; 



14. --this step need to be complete to avoid sending emails to actual customers

Login to sqlplus wkab10/wkab10_wkabqa3 

--Updates may take long time since a lot of records

select count(*) from S_COMMUNICATION where COMM_MODE_ID in (3,6,10)
and LOCATOR <> 'WKAB3.0@coreinc.com';


update S_COMMUNICATION set LOCATOR = 'WKAB3.0@coreinc.com'
where COMM_MODE_ID in (3,6,10)
and LOCATOR <> 'WKAB3.0@coreinc.com';
commit;

select count(*) from s_report_recipient where email_address like '%@%'
        and email_address <> 'WKAB3.0@coreinc.com'; 

update s_report_recipient
set email_address = 'WKAB3.0@coreinc.com'
where email_address like '%@%'
and email_address <> 'WKAB3.0@coreinc.com' ;
commit;
        
*** Will take long time look in *** (Select * from V$SESSION_LONGOPS) for monitor




ALTER SYSTEM SET MEMORY_TARGET = 1200M SCOPE = SPFILE;




list backup of controlfile;


					