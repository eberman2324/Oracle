- name: Check if PDB exits and is open
  become_user: "{{ oracle_user }}"
  become: true
  ansible.builtin.shell: |
    {{ oracle_home }}/bin/sqlplus -s / as sysdba <<EOF
    set  echo off ver off pages 0 linesize 180 trims on head off feed off
    select  open_mode from v\$pdbs where name = '{{ pdb_name }}';
    EOF
  register: pdb_status
  environment:
    ORACLE_HOME: "{{ oracle_home }}"
    ORACLE_SID: "{{ instance_name }}"
  failed_when: "'READ WRITE' not in pdb_status.stdout"
  args:
    creates: "{{ stage_directory }}/{{ lst_name }}_users_to_unlock.sql"

- name: Fetch user accounts to lock
  become_user: "{{ oracle_user }}"
  become: true
  ansible.builtin.shell: |
    {{ oracle_home }}/bin/sqlplus -s / as sysdba <<EOF > {{ stage_directory }}/{{ lst_name }}_users_to_lock.sql
    set  echo off ver off pages 0 linesize 180 trims on head off feed off
    alter session set container={{ pdb_name }};
    prompt set echo on;;
    select  'alter user ' || username || ' account lock;'
    from dba_users
    where username not in (select grantee from dba_role_privs where  granted_role = 'USERS_TO_REMAIN_UNLOCKED_DURING_DEVOPS_IMPLEMENTATIONS')
    and oracle_maintained = 'N' and account_status='OPEN';
    prompt set echo off;;
    EOF
  environment:
    ORACLE_HOME: "{{ oracle_home }}"
    ORACLE_SID: "{{ instance_name }}"
  args:
    creates: "{{ stage_directory }}/{{ lst_name }}_users_to_lock.sql"

- name: Fetch user accounts to unlock
  become_user: "{{ oracle_user }}"
  become: true
  ansible.builtin.shell: |
    {{ oracle_home }}/bin/sqlplus -s / as sysdba <<EOF > {{ stage_directory }}/{{ lst_name }}_users_to_unlock.sql
    set  echo off ver off pages 0 linesize 180 trims on head off feed off
    alter session set container={{ pdb_name }};
    prompt set echo on;;
    select  'alter user ' || username || ' account unlock;'
    from dba_users
    where username not in (select grantee from dba_role_privs where  granted_role = 'USERS_TO_REMAIN_UNLOCKED_DURING_DEVOPS_IMPLEMENTATIONS')
    and oracle_maintained = 'N' and account_status='OPEN';
    prompt set echo off;;
    EOF
  environment:
    ORACLE_HOME: "{{ oracle_home }}"
    ORACLE_SID: "{{ instance_name }}"
  args:
    creates: "{{ stage_directory }}/{{ lst_name }}_users_to_unlock.sql"

- name: Lock user accounts
  become_user: "{{ oracle_user }}"
  become: true
  ansible.builtin.shell: |
    {{ oracle_home }}/bin/sqlplus / as sysdba << EOF
    alter session set container={{ pdb_name }};
    spool {{ log_file }} append
    @{{ stage_directory }}/{{ lst_name }}_users_to_lock.sql
    spool off;
    quit;
    EOF
  environment:
    ORACLE_HOME: "{{ oracle_home }}"
    ORACLE_SID: "{{ instance_name }}"
  args:
    creates: "{{ stage_directory }}/oracle_setup_status_lock_user_accounts_{{ lst_name }}_successful"
