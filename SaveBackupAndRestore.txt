******* xhepydbw21d box template ***


1. create $HOME/eb/rman
2. Copy scripts (you can copy form QA2 box or Dev1 box)

scp ext_save_backup.sh xhepydbw21d:/home/oracle/eb/rman/ext_save_backup.sh
scp backup_HEPYQA2_b4_rlse20.sh xhepydbw21d:/home/oracle/eb/rman/backup_HEPYDBA_b4_clone_1.sh
scp backup_HEPYQA2_b4_rlse20.rman xhepydbw21d:/home/oracle/eb/rman/backup_HEPYDBA_b4_clone_1.rman


3. Make approprite changes in all scrips.

4. Example on how to execute

-- Take backup and save restore commands
nohup backup_HEPYDBA_b4_clone_1.sh ${ORACLE_SID} backup_HEPYDBA_b4_clone_1.rman


--Only save restore commands
ext_save_backup.ksh HEPYDBA

**********HEPYQA2 save backup and restore steps

Copy scripts from HEDWQA2 server ot HEPYQA2

-rwx------  1 oracle dba 19196 Dec 16 21:10 ext_save_backup.sh
-rwx------  1 oracle dba  2117 Dec 16 21:14 backup_hedwqa2_b4_rlse20.sh
-rw-------  1 oracle dba   652 Dec 16 21:28 backup_hedwqa2_b4_rlse20.rman

.oraenv

HEDWQA2

scp ext_save_backup.sh xhepydbw22q:/home/oracle/tls/rman/ext_save_backup.sh
scp backup_hedwqa2_b4_rlse20.sh xhepydbw22q:/home/oracle/tls/rman/backup_HEPYQA2_b4_rlse20.sh
scp backup_hedwqa2_b4_rlse20.rman xhepydbw22q:/home/oracle/tls/rman/backup_HEPYQA2_b4_rlse20.rman

vi backup_HEPYQA2_b4_rlse20.rman
list backup of controlfile completed after 'sysdate-13/24'


Run Level1 before (it actually starts at 4 PM)
Suspend Level1 after completion
Suspend Arhivelog jobs

Run my script backup + save

cd /home/oracle/tls/rman/
nohup backup_HEPYQA2_b4_rlse20.sh ${ORACLE_SID} backup_HEPYQA2_b4_rlse20.rman

open new SS session
cd /home/oracle/tls/rman/

tail -f *.log



## mark backup keep 

view HEPYQA3_sbk_20200127_09:58:42.rman

rmanc

CHANGE BACKUPSET 6455644 KEEP FOREVER;
CHANGE BACKUPSET 6455722 KEEP FOREVER;
CHANGE BACKUPSET 6455723 KEEP FOREVER;
CHANGE BACKUPSET 6455724 KEEP FOREVER;
CHANGE BACKUPSET 6455725 KEEP FOREVER;
CHANGE BACKUPSET 6455726 KEEP FOREVER;
CHANGE BACKUPSET 6455727 KEEP FOREVER;
CHANGE BACKUPSET 6455728 KEEP FOREVER;
CHANGE BACKUPSET 6455729 KEEP FOREVER;
CHANGE BACKUPSET 6456236 KEEP FOREVER;
CHANGE BACKUPSET 6456237 KEEP FOREVER;
CHANGE BACKUPSET 6456238 KEEP FOREVER;
CHANGE BACKUPSET 6456316 KEEP FOREVER;
CHANGE BACKUPSET 6456348 KEEP FOREVER;
CHANGE BACKUPSET 6456362 KEEP FOREVER;
CHANGE BACKUPSET 6456408 KEEP FOREVER;
CHANGE BACKUPSET 6456424 KEEP FOREVER;

or 

@HEPYQA3_sbk_20200127_09:58:42.rman

Resume Arhivelog jobs
Resume Level1


Once they done with PY 20.1 upgrade 
Run Level0 (Regular schedule 4 PM on Sunday)
Run Level1 (Resume)

Change schedule for Level0 and Level1 back to what it was




copy following files and make appropriate changes

restore_HEDWQA2.sh
restore_HEDWQA2.rman

scp restore_HEDWQA2.sh xhepydbw22q:/home/oracle/tls/rman/restore_HEPYQA2.sh
scp restore_HEDWQA2.rman xhepydbw22q:/home/oracle/tls/rman/restore_HEPYQA2.rman

## Get this from HEPYQA2_sbk_20191218_04:01:22.rman
vi 








view restore_HEPYQA2.rman

set echo on
startup force nomount;
set DBID=2804953687;
reset database to incarnation 2489670;
run {
 restore controlfile from 'c-2804953687-20191219-02';
}
alter database mount;
run {
 restore database until sequence 1735;
 recover database until sequence 1735;
}
alter database disable block change tracking;
alter database enable block change tracking using file '+DATA_01';
alter database open resetlogs;





1. Suspend OEM jobs for HEPYQA2
2. comment out crontab jobs
3. Make sure HRP bring all apps down.

sqlplus / as sysdba

shutdown immediate
exit

cd /home/oracle/tls/rman/
nohup restore_HEPYQA2.sh

open new SS session
cd /home/oracle/tls/rman/logs


tail -f *.log

##After your restore is complete, query the heartbeat table and compare the heartbeat date
 to the heartbeat date in the backup log prior to enabling the heartbeat job in cron.
select * from aedba.rman_heartbeat order by 2

Uncomment crontab
Resume OEM jobs


Once we get green light to remove saved backup do following
rmanc
DELETE NOPROMPT BACKUPSET 2720609;
DELETE NOPROMPT BACKUPSET 2720676;
DELETE NOPROMPT BACKUPSET 2720677;
DELETE NOPROMPT BACKUPSET 2720678;
DELETE NOPROMPT BACKUPSET 2720679;
DELETE NOPROMPT BACKUPSET 2720680;
DELETE NOPROMPT BACKUPSET 2720681;
DELETE NOPROMPT BACKUPSET 2720682;
DELETE NOPROMPT BACKUPSET 2720683;
DELETE NOPROMPT BACKUPSET 2721199;
DELETE NOPROMPT BACKUPSET 2721270;
DELETE NOPROMPT BACKUPSET 2721298;
DELETE NOPROMPT BACKUPSET 2721311;
DELETE NOPROMPT BACKUPSET 2721353;
DELETE NOPROMPT BACKUPSET 2721368;

crosscheck backup;



**********HEPYQA3 save backup and restore steps


Copy scripts from HEPYQA2 server to HEPYQA3





.oraenv

HEPYQA2

cd /home/oracle/tls/rman/

scp ext_save_backup.sh xhepydbw23q:/home/oracle/tls/rman/ext_save_backup.sh
scp backup_HEPYQA2_b4_rlse20.sh xhepydbw23q:/home/oracle/tls/rman/backup_HEPYQA3_b4_rlse20.sh
scp backup_HEPYQA2_b4_rlse20.rman xhepydbw23q:/home/oracle/tls/rman/backup_HEPYQA3_b4_rlse20.rman
scp restore_HEPYQA2.sh xhepydbw23q:/home/oracle/tls/rman/restore_HEPYQA3.sh
scp restore_HEPYQA2.rman xhepydbw23q:/home/oracle/tls/rman/restore_HEPYQA3.rman


.oraenv

HEPYQA3

cd /home/oracle/tls/rman/



!!!! vi all files above and make appropriate changes..


Run Level1 before (it actually starts at 4 PM)
Suspend Level1 after completion
Suspend Arhivelog jobs

Run my script backup + save

cd /home/oracle/tls/rman/
nohup backup_HEPYQA3_b4_rlse20.sh ${ORACLE_SID} backup_HEPYQA3_b4_rlse20.rman

open new SS session
cd /home/oracle/tls/rman/

tail -f *.log



## mark backup keep 
rmanc

-- File date stamp will be different...
@HEPYQA3_sbk_20200127_09:58:42.rman

Resume Arhivelog jobs
Resume Level1 job


Once they done with PY 20.1 upgrade 
Run Level0 (Regular schedule 4 PM on Sunday)
Run Level1 (Resume)

Change schedule for Level0 and Level1 back to what it was




## Get this from HEPYQA3_sbk_20200127_09:58:42.rman
vi 








view restore_HEPYQA3.rman

set echo on
startup force nomount;
set DBID=2837053391
reset database to incarnation 5852505;
restore controlfile from 'c-2837053391-20200127-0d';
alter database mount;
run{
restore database until sequence 5244;
recover database until sequence 5244;
}
alter database open resetlogs;





1. Suspend OEM jobs for HEPYQA3
2. comment out crontab jobs
3. Make sure HRP bring all apps down.

sqlplus / as sysdba

shutdown immediate
exit

asmcmd 

--Just for reference
cd +DATA_01/HEPYQA3_XHEPYDBW23Q
 du
Used_MB      Mirror_used_MB
15704524            15 704 524

+DATA_01/HEPYQA3_XHEPYDBW23Q/DATAFILE
rm all data files...

--Start under old PSU ORACLE_HOME since backup was taken before latest PSU

cd /etc

vi oratab

HEPYQA3:/orahome/u01/app/oracle/product/12.1.0.2.190716/db_1

. oraenv

HEPYQA3

--If spfile not present

cp -p /orahome/u01/app/oracle/product/12.1.0.2.200114/db_1/dbs/spfileHEPYQA3.ora /orahome/u01/app/oracle/product/12.1.0.2.190716/db_1/dbs/spfileHEPYQA3.ora 

cp -p /orahome/u01/app/oracle/product/12.1.0.2.200114/db_1/dbs/hc_HEPYQA3.dat /orahome/u01/app/oracle/product/12.1.0.2.190716/db_1/dbs/hc_HEPYQA3.dat


cd /home/oracle/tls/rman/
nohup restore_HEPYQA3.sh

open new SS session
cd /home/oracle/tls/rman/logs


tail -f *.log

##After your restore is complete, query the heartbeat table and compare the heartbeat date
 to the heartbeat date in the backup log prior to enabling the heartbeat job in cron.
select * from aedba.rman_heartbeat order by 2


   sqlplus / as sysdba

   @?/rdbms/admin/utlrp.sql

	select count(*)
	from dba_objects
	where status = 'INVALID';



--If PSU needs to be applied



sqlplus / as sysdba

shutdown immediate

cd /etc

vi oratab

change back to Jan2020 Oracl HOme

. oraenv

HEPYQA3


srvctl stop database -d HEPYQA3_xhepydbw23q
patch_apply_12.1.0.2.200114.sh HEPYQA3

srvctl start database -d HEPYQA3_xhepydbw23q





Uncomment crontab
--If time permitts run Level0

Normal schedule Tuesday at 7 PM

--Once Level0 is completed change schedule back

and 
Resume OEM jobs


Once we get green light to remove saved backup do following
rmanc
DELETE NOPROMPT BACKUPSET 6455644;
DELETE NOPROMPT BACKUPSET 6455722;
DELETE NOPROMPT BACKUPSET 6455723;
DELETE NOPROMPT BACKUPSET 6455724;
DELETE NOPROMPT BACKUPSET 6455725;
DELETE NOPROMPT BACKUPSET 6455726;
DELETE NOPROMPT BACKUPSET 6455727;
DELETE NOPROMPT BACKUPSET 6455728;
DELETE NOPROMPT BACKUPSET 6455729;
DELETE NOPROMPT BACKUPSET 6456236;
DELETE NOPROMPT BACKUPSET 6456237;
DELETE NOPROMPT BACKUPSET 6456238;
DELETE NOPROMPT BACKUPSET 6456316;
DELETE NOPROMPT BACKUPSET 6456348;
DELETE NOPROMPT BACKUPSET 6456362;
DELETE NOPROMPT BACKUPSET 6456408;
DELETE NOPROMPT BACKUPSET 6456424;

--change back
CONFIGURE RETENTION POLICY TO RECOVERY WINDOW OF 14 DAYS;
crosscheck backup;



********* Restore HEPYQA3 from failed HRP upgrade *******

1. Suspend OEM backups
2. comment out crontab


--Get latest Restore Point name

select name, scn, time from v$restore_point order by time;

B4UPGMAY242020


cd /home/oracle/tls/rman/

vi restore_HEPYQA3.rman



nohup restore_HEPYQA3_RestorePoint.sh

open new SS session
cd /home/oracle/tls/rman/logs


tail -f *.log

##After your restore is complete, query the heartbeat table and compare the heartbeat date
 to the heartbeat date in the backup log prior to enabling the heartbeat job in cron.
select * from aedba.rman_heartbeat order by 2


   sqlplus / as sysdba

   @?/rdbms/admin/utlrp.sql

	select count(*)
	from dba_objects
	where status = 'INVALID';


Resume OEM backups
Uncomment out crontab



****** Restore from OEM COLD BACKUP ****

Login to Primary xhedwdbw21q

. oraenv

HEDWQA

rmanc

RMAN> startup nomount;
RMAN> restore controlfile from autobackup;
RMAN> alter database mount;
RMAN> restore database;
RMAN> recover database;
RMAN> recover database noredo;
RMAN> alter database open resetlogs;



********** restore HEPYMGR2 from BEFORE_MOC_LOAD restore point*********


1. Suspend OEM backups
2. comment out crontab


--Get latest Restore Point name

select name, scn, time from v$restore_point order by time;

BEFORE_MOC_LOAD

cd /home/oracle/tls/rman/

vi restore_HEPYMGR2.rman

set echo on
startup force mount;
run {
 set until restore point "BEFORE_MOC_LOAD";
 restore database;
 recover database;
}
alter database disable block change tracking;
alter database enable block change tracking using file '+DATA_01';
alter database open resetlogs;


ps -ef | grep restore_HEPYMGR2.sh


nohup restore_HEPYMGR2.sh HEPYMGR2

open new SS session
cd /home/oracle/tls/rman/logs


tail -f *.log

##After your restore is complete, query the heartbeat table and compare the heartbeat date
 to the heartbeat date in the backup log prior to enabling the heartbeat job in cron.
select * from aedba.rman_heartbeat order by 2


   sqlplus / as sysdba

   @?/rdbms/admin/utlrp.sql

	select count(*)
	from dba_objects
	where status = 'INVALID';


Resume OEM backups
Uncomment out crontab

************* restore HEPYMGR2 from BEF_200K_LOAD_1 restore point **********

1. Suspend OEM backups
2. comment out crontab


--Get latest Restore Point name

select name, scn, time from v$restore_point order by time;



cd /home/oracle/tls/rman/

vi restore_HEPYMGR2.rman

set echo on
startup force mount;
run {
 set until restore point "BEF_200K_LOAD_1";
 restore database;
 recover database;
}
alter database disable block change tracking;
alter database enable block change tracking using file '+DATA_01';
alter database open resetlogs;


ps -ef | grep restore_HEPYMGR2.sh


nohup restore_HEPYMGR2.sh HEPYMGR2

open new SS session
cd /home/oracle/tls/rman/logs


tail -f *.log

##After your restore is complete, query the heartbeat table and compare the heartbeat date
 to the heartbeat date in the backup log prior to enabling the heartbeat job in cron.
select * from aedba.rman_heartbeat order by 2


   sqlplus / as sysdba

   @?/rdbms/admin/utlrp.sql

	select count(*)
	from dba_objects
	where status = 'INVALID';


Resume OEM backups
Uncomment out crontab


**** HEPYDBA*****


1. Suspend OEM backups
2. comment out crontab


--Get latest Restore Point name

select name, scn, time from v$restore_point order by time;

## Add to oratab if not there
HEPYDBA:/orahome/u01/app/oracle/product/12.1.0.2.200414/db_1:N          


. oraenv

HEPYDBA


cd /home/oracle/tls/rman/

vi restore_HEPYDBA.rman

set echo on
startup force mount;
run {
 set until restore point "B4UPGOCT052020";
 restore database;
 recover database;
}
alter database disable block change tracking;
alter database enable block change tracking using file '+DATA_01';
alter database open resetlogs;


ps -ef | grep restore_HEPYDBA.sh


nohup restore_HEPYDBA.sh HEPYDBA

open new SS session
cd /home/oracle/tls/rman/logs


tail -f *.log

##After your restore is complete, query the heartbeat table and compare the heartbeat date
 to the heartbeat date in the backup log prior to enabling the heartbeat job in cron.
select * from aedba.rman_heartbeat order by 2


   sqlplus / as sysdba

   @?/rdbms/admin/utlrp.sql

	select count(*)
	from dba_objects
	where status = 'INVALID';


Resume OEM backups
Uncomment out crontab



************* restore HEPYMGR2 from BEFORE_MOCK_15_A restore point **********

1. Suspend OEM backups
2. comment out crontab
3. Make sure HRP bring all apps down.

sqlplus / as sysdba

shutdown immediate

 ps -ef |grep pmon

exit

asmcmd 

--Just for reference
ASMCMD> cd +DATA_01/HEPYMGR2_XHEPYDBW26D/DATAFILE
ASMCMD> du
Used_MB      Mirror_used_MB
38989716            38989716

cd +IND_01/HEPYMGR2_XHEPYDBW26D/DATAFILE
ASMCMD> du
Used_MB      Mirror_used_MB
17920064            17920064


rm all data files...

--Monitor number of files that got restored

+ASM> asmcmd ls -l  DATA_01/HEPYMGR2_XHEPYDBW26D/datafile   | wc -l
431

select ROUND((sofar/totalwork) * 100,2) pct_done,sysdate + TIME_REMAINING/3600/24 end_time from   v$session_longops where  totalwork > sofar and    opname NOT LIKE '%aggregate%' and    opname like 'RMAN%';

--Get latest Restore Point name

select name, scn, time from v$restore_point order by time;



cd /home/oracle/tls/rman/

-- Special script to handle restore databases with DATA_01 and IND_01
vi restore_HEPYMGR2.rman

set echo on
startup force mount;
run {
 set newname for datafile 877 to '+IND_01';
 set newname for datafile 879 to '+IND_01';
 set newname for datafile 880 to '+IND_01';
 set newname for datafile 881 to '+IND_01';
 set until restore point "BEFORE_MOCK_15_A";
 restore database;
 switch datafile all;
 recover database;
}
alter database disable block change tracking;
alter database enable block change tracking using file '+DATA_01';
alter database open resetlogs;
ps -ef | grep restore_HEPYMGR2.sh


nohup restore_HEPYMGR2.sh HEPYMGR2

open new SS session
cd /home/oracle/tls/rman/logs


tail -f *.log

+ASM> asmcmd ls -l  DATA_01/HEPYMGR2_XHEPYDBW26D/datafile   | wc -l
431
721
736
749

select ROUND((sofar/totalwork) * 100,2) pct_done,sysdate + TIME_REMAINING/3600/24 end_time from   v$session_longops where  totalwork > sofar and    opname NOT LIKE '%aggregate%' and    opname like 'RMAN%';


##After your restore is complete, query the heartbeat table and compare the heartbeat date
 to the heartbeat date in the backup log prior to enabling the heartbeat job in cron.
select * from aedba.rman_heartbeat order by 2


   sqlplus / as sysdba

   @?/rdbms/admin/utlrp.sql

	select count(*)
	from dba_objects
	where status = 'INVALID';


Resume OEM backups
Uncomment out crontab


***** Restore HEPYSTS from point in time *****

-- change to 30
CONFIGURE RETENTION POLICY TO RECOVERY WINDOW OF 30 DAYS;

cd /home/oracle/tls/rman
##./create_restore_point_new.sh HEPYSTS B4UPGNOV302021
./create_restore_point_new.sh HEPYSTS B4UPGAPR122022
Run Archivelog backup

1. Suspend OEM backups
2. comment out crontab
3. Make sure HRP bring all apps down.

sqlplus / as sysdba

shutdown immediate

 ps -ef |grep pmon

exit

. oraenv
+ASM

asmcmd 

--Just for reference
ASMCMD> cd +DATA_01/HEPYSTS_XHEPYDBW21S/DATAFILE
ASMCMD> du
##Used_MB      Mirror_used_MB
##28202656            28202656

Used_MB      Mirror_used_MB
29015144            29015144


#cd +IND_01/HEPYSTS_XHEPYDBW21S/DATAFILE


#ASMCMD> du
#Used_MB      Mirror_used_MB
#4096016             4096016


rm all data files...
rm *xx*


--Monitor number of files that got restored

+ASM> asmcmd ls -l  +DATA_01/HEPYSTS_XHEPYDBW21S/DATAFILE  | wc -l
845

asmcmd ls -l  +IND_01/HEPYSTS_XHEPYDBW21S/DATAFILE  | wc -l

select  TOTALWORK, sofar, ROUND((sofar/totalwork) * 100,2) pct_done,
sysdate + TIME_REMAINING/3600/24 end_time
from   v$session_longops 
where  totalwork > sofar
and opname like 'RMAN%';


--Get latest Restore Point name

--select name, scn, time from v$restore_point order by time;


cd /home/oracle/tls/rman/

-- Special script to handle restore databases with DATA_01 and IND_01
vi restore_HEPYSTS.rman

set echo on
startup force mount;
run {
 set db_file_name_convert '+DATA_01','+DATA_01','+IND_01','+DATA_01';
 set until time "TO_DATE('03/18/2022 09:00:00', 'MM/DD/YYYY HH24:MI:SS')";
 restore database;
 switch datafile all;
 recover database;
}
alter database disable block change tracking;
alter database enable block change tracking using file '+DATA_01';
alter database open resetlogs;



*************

reset database to incarnation 6623203;

restore the spfile;
restore the controlfile;

set db_file_name_convert '+DATA_01','+DATA_01','+IND_01','+DATA_01';
set db_file_name_convert '+DATA_01','+DATA_01','+IND_01','+DATA_01';


set newname for datafile 789 to '+DATA_01';

************
set echo on
startup pfile=/orahome/u01/app/oracle/product/19.12.1/db_1/dbs/init_for_clone.pfile force nomount;
set DBID=816934119; 
reset database to incarnation 8350617;
restore the spfile;
restore the controlfile;
alter database mount;
run {
 set db_file_name_convert '+DATA_01','+DATA_01','+IND_01','+DATA_01';
 set until time "TO_DATE('03/18/2022 09:00:00', 'MM/DD/YYYY HH24:MI:SS')";
 restore database;
 switch datafile all;
 recover database;
}
alter database disable block change tracking;
alter database enable block change tracking using file '+DATA_01';
alter database open resetlogs;


**

#ps -ef | grep restore_HEPYSTS.sh
#nohup restore_HEPYSTS.sh HEPYSTS

ps -ef | grep restore_HEPYSTS_aftr_clone.sh

nohup restore_HEPYSTS_aftr_clone.sh HEPYSTS

open new SS session
cd /home/oracle/tls/rman/logs

##After your restore is complete, query the heartbeat table and compare the heartbeat date
 to the heartbeat date in the backup log prior to enabling the heartbeat job in cron.
select * from aedba.rman_heartbeat order by 2


   sqlplus / as sysdba

   @?/rdbms/admin/utlrp.sql

	select count(*)
	from dba_objects
	where status = 'INVALID';


Resume OEM backups
Uncomment out crontab




***** Restore HEDWSTS from point in time *****

-- change to 30
CONFIGURE RETENTION POLICY TO RECOVERY WINDOW OF 30 DAYS;

cd /home/oracle/tls/rman
./create_restore_point_new.sh HEDWSTS B4UPGAPR122022
Run Archivelog backup

1. Suspend OEM backups
2. comment out crontab
3. Make sure HRP bring all apps down.

sqlplus / as sysdba

shutdown immediate

 ps -ef |grep pmon

exit

. oraenv
+ASM

asmcmd 

--Just for reference
cd +DATA_01/HEDWSTS_XHEDWDBW21S/DATAFILE
ASMCMD> du
Used_MB      Mirror_used_MB
10165884            10165884





rm all data files...



--Monitor number of files that got restored

+ASM> asmcmd ls -l  +DATA_01/HEDWSTS_XHEDWDBW21S/DATAFILE  | wc -l
845



select  TOTALWORK, sofar, ROUND((sofar/totalwork) * 100,2) pct_done,
sysdate + TIME_REMAINING/3600/24 end_time
from   v$session_longops 
where  totalwork > sofar
and opname like 'RMAN%';


--Get latest Restore Point name

--select name, scn, time from v$restore_point order by time;


cd /home/oracle/tls/rman/

-- Special script to handle restore databases with DATA_01 and IND_01
vi restore_HEDWSTS.rman

set echo on
startup force mount;
run {
 set until time "TO_DATE('03/18/2022 11:00:00', 'MM/DD/YYYY HH24:MI:SS')";
 restore database;
 recover database;
}
alter database disable block change tracking;
alter database enable block change tracking using file '+DATA_01';
alter database open resetlogs;

~

ps -ef | grep restore_HEDWSTS.sh

ps -ef | grep *.rman


nohup restore_HEDWSTS.sh HEDWSTS

open new SS session
cd /home/oracle/tls/rman/logs

##After your restore is complete, query the heartbeat table and compare the heartbeat date
 to the heartbeat date in the backup log prior to enabling the heartbeat job in cron.
select * from aedba.rman_heartbeat order by 2


   sqlplus / as sysdba

   @?/rdbms/admin/utlrp.sql

	select count(*)
	from dba_objects
	where status = 'INVALID';


Resume OEM backups
Uncomment out crontab



**** HEPYMGR2 ****

1. Suspend OEM backups
2. comment out crontab
3. Make sure HRP bring all apps down.

sqlplus / as sysdba

shutdown immediate

 ps -ef |grep pmon

exit

asmcmd 

--Just for reference
ASMCMD> cd +DATA_01/HEPYMGR2_XHEPYDBW26D/DATAFILE
ASMCMD> du
Used_MB      Mirror_used_MB
41523952            41523952

cd +IND_01/HEPYMGR2_XHEPYDBW26D/DATAFILE
ASMCMD> du
Used_MB      Mirror_used_MB
17920064            17920064


rm all data files...

--Monitor number of files that got restored

+ASM> asmcmd ls -l  DATA_01/HEPYMGR2_XHEPYDBW26D/datafile   | wc -l
934
select ROUND((sofar/totalwork) * 100,2) pct_done,sysdate + TIME_REMAINING/3600/24 end_time from   v$session_longops where  totalwork > sofar and    opname NOT LIKE '%aggregate%' and    opname like 'RMAN%';

--Get latest Restore Point name

select name, scn, time from v$restore_point order by time;



cd /home/oracle/tls/rman/

-- Special script to handle restore databases with DATA_01 and IND_01
vi restore_HEPYMGR2.rman

set echo on
startup force mount;
run {
 set newname for datafile 877 to '+IND_01';
 set newname for datafile 879 to '+IND_01';
 set newname for datafile 880 to '+IND_01';
 set newname for datafile 881 to '+IND_01';
 set until restore point "B4UPGAPR192022";
 restore database;
 switch datafile all;
 recover database;
}
alter database disable block change tracking;
alter database enable block change tracking using file '+DATA_01';
alter database open resetlogs;
ps -ef | grep restore_HEPYMGR2.sh


nohup restore_HEPYMGR2.sh HEPYMGR2

open new SS session
cd /home/oracle/tls/rman/logs


tail -f *.log

+ASM> asmcmd ls -l  DATA_01/HEPYMGR2_XHEPYDBW26D/datafile   | wc -l
431
721
736
749

select ROUND((sofar/totalwork) * 100,2) pct_done,sysdate + TIME_REMAINING/3600/24 end_time from   v$session_longops where  totalwork > sofar and    opname NOT LIKE '%aggregate%' and    opname like 'RMAN%';


##After your restore is complete, query the heartbeat table and compare the heartbeat date
 to the heartbeat date in the backup log prior to enabling the heartbeat job in cron.
select * from aedba.rman_heartbeat order by 2


   sqlplus / as sysdba

   @?/rdbms/admin/utlrp.sql

	select count(*)
	from dba_objects
	where status = 'INVALID';


Resume OEM backups
Uncomment out crontab


*** HEDWMGR2 ***

1. Suspend OEM backups
2. comment out crontab
3. Make sure HRP bring all apps down.

sqlplus / as sysdba

shutdown immediate

 ps -ef |grep pmon

exit

asmcmd 

--Just for reference
ASMCMD> cd +DATA_01/HEDWMGR2_XHEDWDBW26D/DATAFILE
ASMCMD> du
Used_MB      Mirror_used_MB
21382348            21382348



rm all data files...

--Monitor number of files that got restored

+ASM> asmcmd ls -l  DATA_01/HEDWMGR2_XHEDWDBW26D/datafile   | wc -l
542
select ROUND((sofar/totalwork) * 100,2) pct_done,sysdate + TIME_REMAINING/3600/24 end_time from   v$session_longops where  totalwork > sofar and    opname NOT LIKE '%aggregate%' and    opname like 'RMAN%';

--Get latest Restore Point name

select name, scn, time from v$restore_point order by time;



cd /home/oracle/tls/rman/

-- Special script to handle restore databases with DATA_01 and IND_01
vi restore_HEDWMGR2.rman

set echo on
startup force mount;
run {
 set until restore point "B4UPGAPR192022";
 restore database;
 recover database;
}
alter database disable block change tracking;
alter database enable block change tracking using file '+DATA_01';
alter database open resetlogs;



ps -ef | grep restore_HEDWMGR2.sh


nohup restore_HEDWMGR2.sh HEDWMGR2

open new SS session
cd /home/oracle/tls/rman/logs


tail -f *.log

+ASM> asmcmd ls -l  DATA_01/HEDWMGR2_XHEDWDBW26D/datafile   | wc -l
431
721
736
749

select ROUND((sofar/totalwork) * 100,2) pct_done,sysdate + TIME_REMAINING/3600/24 end_time from   v$session_longops where  totalwork > sofar and    opname NOT LIKE '%aggregate%' and    opname like 'RMAN%';


##After your restore is complete, query the heartbeat table and compare the heartbeat date
 to the heartbeat date in the backup log prior to enabling the heartbeat job in cron.
select * from aedba.rman_heartbeat order by 2


   sqlplus / as sysdba

   @?/rdbms/admin/utlrp.sql

	select count(*)
	from dba_objects
	where status = 'INVALID';


Resume OEM backups
Uncomment out crontab


******* HEPYSTS ********************************


1. Suspend OEM backups
2. comment out crontab
3. Make sure HRP bring all apps down.

sqlplus / as sysdba

shutdown immediate

 ps -ef |grep pmon

exit

. oraenv

+ASM

asmcmd 

--Just for reference
ASMCMD> cd +DATA_01/HEPYSTS_XHEPYDBW21S/DATAFILE
ASMCMD> du
Used_MB      Mirror_used_MB
52725804            52725804



rm all data files...

--Monitor number of files that got restored

+ASM> asmcmd ls -l  +DATA_01/HEPYSTS_XHEPYDBW21S/DATAFILE   | wc -l

asmcmd ls -l  +DATA_01/HEPYSTS_XHEPYDBW21S/datafile   | wc -l
17

select ROUND((sofar/totalwork) * 100,2) pct_done,sysdate + TIME_REMAINING/3600/24 end_time from   v$session_longops where  totalwork > sofar and    opname NOT LIKE '%aggregate%' and    opname like 'RMAN%';

--Get latest Restore Point name

select name, scn, time from v$restore_point order by time;

B4UPGAUG232022

cd /home/oracle/tls/rman/


vi restore_HEPYSTS.rman

set echo on
startup force mount;
run {
 set until restore point "B4UPGAUG232022";
 restore database;
 recover database;
}
alter database disable block change tracking;
alter database enable block change tracking using file '+DATA_01';
alter database open resetlogs;

 set until time "TO_DATE('08/23/2022 10:00:00', 'MM/DD/YYYY HH24:MI:SS')";

!! I deleted all Datafiles, control files and redeologs (DO NOT DO THIS NEXT TIME)

!! How to restore after that
set echo on
startup force nomount;
set DBID = 860232859
restore controlfile until restore point "B4UPGAUG232022";
alter database mount;
run {
 set until restore point "B4UPGAUG232022";
 restore database;
 recover database;
}
alter database disable block change tracking;
alter database enable block change tracking using file '+DATA_01';
alter database open resetlogs;



ps -ef | grep restore_HEPYSTS.sh


nohup restore_HEPYSTS.sh HEPYSTS

open new SS session
cd /home/oracle/tls/rman/logs


tail -f *.log

asmcmd ls -l  +DATA_01/HEPYSTS_XHEPYDBW21S/datafile   | wc -l
431
721
736
749
incarnation 
select ROUND((sofar/totalwork) * 100,2) pct_done,sysdate + TIME_REMAINING/3600/24 end_time from   v$session_longops where  totalwork > sofar and    opname NOT LIKE '%aggregate%' and    opname like 'RMAN%';


##After your restore is complete, query the heartbeat table and compare the heartbeat date
 to the heartbeat date in the backup log prior to enabling the heartbeat job in cron.
select * from aedba.rman_heartbeat order by 2


   sqlplus / as sysdba

   @?/rdbms/admin/utlrp.sql

	select count(*)
	from dba_objects
	where status = 'INVALID';


Resume OEM backups
Uncomment out crontab

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

RMAN-00571: ===========================================================
RMAN-00569: =============== ERROR MESSAGE STACK FOLLOWS ===============
RMAN-00571: ===========================================================
RMAN-03002: failure of recover command at 08/26/2022 18:24:49
RMAN-11003: failure during parse/execution of SQL statement: alter database recover logfile '+FLASH_01/HEPYSTS_XHEPYDBW21S/ARCHIVELOG/2022_08_26/thread_1_seq_2966.277.1113697991'
ORA-10877: error signaled in parallel recovery slave 

RMAN> alter database disable block change tracking;
Statement processed

RMAN> alter database enable block change tracking using file '+DATA_01';
Statement processed

RMAN> alter database open resetlogs;
RMAN-00571: ===========================================================
RMAN-00569: =============== ERROR MESSAGE STACK FOLLOWS ===============
RMAN-00571: ===========================================================
RMAN-03002: failure of sql statement command at 08/26/2022 18:24:55
ORA-01157: cannot identify/lock data file 16 - see DBWR trace file
ORA-01111: name for data file 16 is unknown - rename to correct file
ORA-01110: data file 16: '/orahome/u01/app/oracle/product/19.12.1/db_1/dbs/UNNAMED00016'

-- SOLUTION
alter database datafile 16 offline drop;

alter database open resetlogs;


!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

************** HEDWSTS ******************


1. Suspend OEM backups
2. comment out crontab
3. Make sure HRP bring all apps down.

sqlplus / as sysdba

shutdown immediate

 ps -ef |grep pmon

exit

asmcmd 

--Just for reference
ASMCMD> cd +DATA_01/HEDWSTS_XHEDWDBW21S/DATAFILE
ASMCMD> du
Used_MB      Mirror_used_MB
10165884            10165884


rm all data files...

--Monitor number of files that got restored

+ASM> asmcmd ls -l  DATA_01/HEDWSTS_XHEDWDBW21S/DATAFILE  | wc -l


296

select ROUND((sofar/totalwork) * 100,2) pct_done,sysdate + TIME_REMAINING/3600/24 end_time from   v$session_longops where  totalwork > sofar and    opname NOT LIKE '%aggregate%' and    opname like 'RMAN%';

--Get latest Restore Point name

select name, scn, time from v$restore_point order by time;

B4UPGAUG232022

cd /home/oracle/tls/rman/


vi restore_HEDWSTS.rman




set echo on
startup force mount;
run {
 set until restore point "B4UPGAUG232022";
 restore database;
 recover database;
}
alter database disable block change tracking;
alter database enable block change tracking using file '+DATA_01';
alter database open resetlogs;








ps -ef | grep restore_HEDWSTS.sh


nohup restore_HEDWSTS.sh HEDWSTS

open new SS session
cd /home/oracle/tls/rman/logs


tail -f *.log


select ROUND((sofar/totalwork) * 100,2) pct_done,sysdate + TIME_REMAINING/3600/24 end_time from   v$session_longops where  totalwork > sofar and    opname NOT LIKE '%aggregate%' and    opname like 'RMAN%';


##After your restore is complete, query the heartbeat table and compare the heartbeat date
 to the heartbeat date in the backup log prior to enabling the heartbeat job in cron.
select * from aedba.rman_heartbeat order by 2



 sqlplus / as sysdba

   @?/rdbms/admin/utlrp.sql

	select count(*)
	from dba_objects
	where status = 'INVALID';


Resume OEM backups
Uncomment out crontab



**** HEDWQA3 ***

vi restore_HEDWQA3_20230307.rman




set echo on
startup force mount;
run {
 set until time "TO_DATE('03/06/2023 01:01:00', 'MM/DD/YYYY HH24:MI:SS')";
 restore database;
 recover database;
}
alter database disable block change tracking;
alter database enable block change tracking using file '+DATA_01';
alter database open resetlogs;




**** EB ****

SID
16174
2320
12
4635
11565
13874
9252


**********HEPYSTS save backup before HPR upgrade and restore steps


Copy scripts from HEPYQA2 server to HEPYSTS if they are not there already





.oraenv

HEPYQA2

cd /home/oracle/tls/rman/

scp ext_save_backup.sh xhepydbw21s:/home/oracle/tls/rman/ext_save_backup.sh
scp backup_HEPYQA2_b4_rlse20.sh xhepydbw21s:/home/oracle/tls/rman/backup_HEPYSTS_b4_rlse2234.sh
scp backup_HEPYQA2_b4_rlse20.rman xhepydbw21s:/home/oracle/tls/rman/backup_HEPYSTS_b4_rlse2234.rman

-- Those were already there. 
scp restore_HEPYQA2.sh xhepydbw21s:/home/oracle/tls/rman/restore_HEPYSTS.sh
scp restore_HEPYQA2.rman xhepydbw21s:/home/oracle/tls/rman/restore_HEPYSTS.rman


.oraenv

HEPYSTS


RMAN> list incarnation of database;


List of Database Incarnations
DB Key  Inc Key DB Name  DB ID            STATUS  Reset SCN  Reset Time
------- ------- -------- ---------------- --- ---------- ----------
6623202 6624776 HEPYSTS  816934119        PARENT  13575759468995 09-DEC-2020 15:39:41
6623202 6623203 HEPYSTS  816934119        PARENT  13576349406103 02-FEB-2021 21:36:12
6623202 8350617 HEPYSTS  816934119        PARENT  13580200523614 30-NOV-2021 22:33:54
6623202 8990978 HEPYSTS  816934119        CURRENT 13581500773933 13-APR-2022 09:22:03
8895489 8895560 HEPYSTS  853200237        PARENT  42565283   01-MAR-2022 13:35:02
8895489 8895490 HEPYSTS  853200237        CURRENT 267323819  19-MAR-2022 15:30:55
9246572 9246651 HEPYSTS  860232859        PARENT  47888731   19-MAY-2022 16:06:33
9246572 9246573 HEPYSTS  860232859        PARENT  677801843  08-JUN-2022 01:01:17
9246572 9845074 HEPYSTS  860232859        CURRENT 1448691453 27-AUG-2022 06:57:24
10420079 10420209 HEPYSTS  880386359        PARENT  13641666736748 23-DEC-2022 01:53:17
10420079 10420080 HEPYSTS  880386359        CURRENT 13641684768252 24-JAN-2023 07:12:59


CONFIGURE DEVICE TYPE 'SBT_TAPE' PARALLELISM 12 BACKUP TYPE TO BACKUPSET;

cd /home/oracle/tls/rman/



!!!! vi all files above and make appropriate changes..


!!!Suspend all OEM backup jobs
!!!Note backup next start times

BACKUP_HEPYSTS_XHEPYDBW21S_BIWKLY_LEVEL_1 - March 31 7 PM

BBACKUP_HEPYSTS_XHEPYDBW21S_DAILY_LEVEL_1 - April 1 7 PM

BACKUP_HEPYSTS_XHEPYDBW21S_LEVEL0 - April 7 7 PM



Run my script backup + save

cd /home/oracle/tls/rman/
nohup backup_HEPYSTS_b4_rlse2234_4.sh ${ORACLE_SID} backup_HEPYSTS_b4_rlse2234_4.rman

open new SS session
cd /home/oracle/tls/rman/

tail -f *.log



## mark backup keep 
rmanc

-- File date stamp will be different...

## Run this script to mark backupsets keep forever
@HEPYSTS_sbk_20230331_02:26:47.rman

Resume OEM Jobs




## Create Restore Script
## Get this from HEPYSTS_sbk_20230331_02:26:47.rman
vi 






## Save priv restore_HEPYSTS.rman

mv restore_HEPYSTS.rman restore_HEPYSTS.rman_ori

vi restore_HEPYSTS.rman

startup force nomount;
set DBID=880386359
reset database to incarnation 10420080;
------ Add next time -------> restore the spfile;
restore controlfile from 'c-880386359-20230331-0c';
alter database mount;
run{
restore database until sequence 2607;
recover database until sequence 2607;
}
alter database disable block change tracking;
alter database enable block change tracking using file '+DATA_01';
alter database open resetlogs;




1. Suspend OEM jobs for HEPYSTS
2. comment out crontab jobs
3. Make sure HRP bring all apps down.

sqlplus / as sysdba

shutdown immediate
exit

asmcmd 


rm -r */HEPYSTS_XHEPYDBW21S



cd /home/oracle/tls/rman/
nohup restore_HEPYSTS.sh HEPYSTS

open new SS session
cd /home/oracle/tls/rman/logs


tail -f *.log




!!!! RMAN> alter database open resetlogs;
RMAN-00571: ===========================================================
RMAN-00569: =============== ERROR MESSAGE STACK FOLLOWS ===============
RMAN-00571: ===========================================================
RMAN-03002: failure of sql statement command at 04/07/2023 01:39:40
ORA-01378: The logical block size (4096) of file +REDOA_01 is not compatible with the disk sector size (media sector size is 512 and )

. oraenv

HEPYSTS
alter system set "_DISK_SECTOR_SIZE_OVERRIDE"=true scope=both;

alter database open resetlogs;

Received ORA-600..


###I cleared redo log group3 because it was marked current

alter database clear unarchived logfile group 3;



###I then bounce the instanace , startup nomount then opened resetlog

shutdown immediate;
startup mount
alter database open resetlogs;


HEPYSTS

select * from v$log

(Identify log groups that still blocksize 512) drop and re create them with 4096 


ALTER DATABASE DROP LOGFILE GROUP 6
/
ALTER DATABASE ADD LOGFILE GROUP 6 ('+REDOA_01','+REDOB_01') SIZE 6144M BLOCKSIZE 4096;

ALTER DATABASE DROP LOGFILE GROUP 3
/

ALTER DATABASE ADD LOGFILE GROUP 3 ('+REDOA_01','+REDOB_01') SIZE 6144M BLOCKSIZE 4096;

ALTER DATABASE DROP LOGFILE GROUP 4
/

ALTER DATABASE ADD LOGFILE GROUP 4 ('+REDOA_01','+REDOB_01') SIZE 6144M BLOCKSIZE 4096;

ALTER DATABASE DROP LOGFILE GROUP 5
/

ALTER DATABASE ADD LOGFILE GROUP 5 ('+REDOA_01','+REDOB_01') SIZE 6144M BLOCKSIZE 4096;



##After your restore is complete, query the heartbeat table and compare the heartbeat date
 to the heartbeat date in the backup log prior to enabling the heartbeat job in cron.
select * from aedba.rman_heartbeat order by 2


   sqlplus / as sysdba

   @?/rdbms/admin/utlrp.sql

	select count(*)
	from dba_objects
	where status = 'INVALID';


rmanc
CONFIGURE DEVICE TYPE 'SBT_TAPE' PARALLELISM 6 BACKUP TYPE TO BACKUPSET;

!!!!!!!!!!!!!!!!!!!!!!!!!!! GI + RU PATCHING ----> IF Needed




Once we get green light to remove saved backup do following
## Get DELETE NOPROMPT commands from this file HEPYSTS_sbk_20230331_02:26:47.rman

rmanc
DELETE NOPROMPT BACKUPSET xx;
DELETE NOPROMPT BACKUPSET xx;

--change back
CONFIGURE RETENTION POLICY TO RECOVERY WINDOW OF 14 DAYS;
crosscheck backup;


**********HEDWSTS save backup before HPR upgrade and restore steps




RMAN> list incarnation of database;


List of Database Incarnations
DB Key  Inc Key DB Name  DB ID            STATUS  Reset SCN  Reset Time
------- ------- -------- ---------------- --- ---------- ----------
6632916 6633519 HEDWSTS  444658222        PARENT  13562509789163 20-MAY-2020 19:48:29
6632916 6632917 HEDWSTS  444658222        PARENT  13568005838529 02-FEB-2021 16:34:05
6632916 8512789 HEDWSTS  444658222        PARENT  13571862929934 30-NOV-2021 17:03:39
6632916 9083081 HEDWSTS  444658222        PARENT  13572490815632 12-APR-2022 18:37:10
6632916 9943821 HEDWSTS  444658222        CURRENT 13573157737232 25-AUG-2022 16:27:42
10792117 10792577 HEDWSTS  508057578        PARENT  13609515762700 29-NOV-2022 18:14:41
10792117 10792118 HEDWSTS  508057578        CURRENT 13614600124311 23-JAN-2023 11:29:55


.oraenv

HEDWSTS

cd /home/oracle/tls/rman/



!!!! vi all files above and make appropriate changes..



!!!Suspend all OEM backup jobs
!!! Note backup startup times

BACKUP_HEDWSTS_XHEDWDBW21S_DAILY_LEVEL_1 - Mar 31 11:30 PM

	
BACKUP_HEDWSTS_XHEDWDBW21S_LEVEL_0 - Apr 4 - 11:30 PM

BACKUP_HEDWSTS_XHEDWDBW21S_BIWKLY_LEVEL_1 - Apr 11 11:30 PM


Run my script backup + save

cd /home/oracle/tls/rman/
nohup backup_HEDWSTS_b4_rlse2234.sh ${ORACLE_SID} backup_HEDWSTS_b4_rlse2234.rman

open new SS session
cd /home/oracle/tls/rman/

tail -f *.log



## mark backup keep 
rmanc

-- File date stamp will be different...

## Run this script to mark backupsets keep forever
@HEDWSTS_sbk_20230331_06:43:03.rman

Resume OEM Jobs if needed




## Create Restore Script
## Get Restore portion from  HEDWSTS_sbk_20230331_06:43:03.rman + add some missing BT code from original restore script. See below example.





## Save priv restore_HEDWSTS.rman

mv restore_HEDWSTS.rman restore_HEDWSTS.rman_ori

vi restore_HEDWSTS.rman

set echo on
startup force mount;
set DBID=508057578
reset database to incarnation 10792118;
------ Add next time -------> restore the spfile;
restore controlfile from 'c-508057578-20230331-10';
alter database mount;
run{
restore database until sequence 10365;
recover database until sequence 10365;
}
alter database disable block change tracking;
alter database enable block change tracking using file '+DATA_01';
alter database open resetlogs;










1. Suspend OEM jobs for HEDWSTS if not already suspended
2. comment out crontab jobs
3. Make sure HRP bring all apps down.

sqlplus / as sysdba

shutdown immediate
exit

. oraenv
+ASM


asmcmd 




rm -r */HEDWSTS_XHEDWDBW21S



ps -ef | grep restore_HEDWSTS.sh





cd /home/oracle/tls/rman/
nohup restore_HEDWSTS.sh HEDWSTS

open new SS session
cd /home/oracle/tls/rman/logs


tail -f *.log

##After your restore is complete, query the heartbeat table and compare the heartbeat date
 to the heartbeat date in the backup log prior to enabling the heartbeat job in cron.
select * from aedba.rman_heartbeat order by 2


   sqlplus / as sysdba

   @?/rdbms/admin/utlrp.sql

	select count(*)
	from dba_objects
	where status = 'INVALID';





!!!!!!!!!!!!!!!!!!!!!!!!!!! GI + RU PATCHING 




Once we get green light to remove saved backup do following
rmanc
DELETE NOPROMPT BACKUPSET 11148725;
DELETE NOPROMPT BACKUPSET 11148725;
DELETE NOPROMPT BACKUPSET 11148725;
DELETE NOPROMPT BACKUPSET 11148725;
DELETE NOPROMPT BACKUPSET 11148725;
DELETE NOPROMPT BACKUPSET 11148725;
DELETE NOPROMPT BACKUPSET 11148726;
DELETE NOPROMPT BACKUPSET 11148727;
DELETE NOPROMPT BACKUPSET 11148728;
DELETE NOPROMPT BACKUPSET 11148729;
DELETE NOPROMPT BACKUPSET 11148730;
DELETE NOPROMPT BACKUPSET 11148731;
DELETE NOPROMPT BACKUPSET 11148731;
DELETE NOPROMPT BACKUPSET 11148731;
DELETE NOPROMPT BACKUPSET 11148731;
DELETE NOPROMPT BACKUPSET 11148977;
DELETE NOPROMPT BACKUPSET 11148987;
DELETE NOPROMPT BACKUPSET 11149009;
DELETE NOPROMPT BACKUPSET 11149022;
DELETE NOPROMPT BACKUPSET 11149056;
DELETE NOPROMPT BACKUPSET 11149071;

--change back
CONFIGURE RETENTION POLICY TO RECOVERY WINDOW OF 14 DAYS;
crosscheck backup;


**********Pre 23.1.2 HEPYSTS save backup before HPR upgrade and restore steps



REMOVE PRIVIOUSE SAVED BACKUP
## Get DELETE NOPROMPT commands from this file HEPYSTS_sbk_20230331_02:26:47.rman 
##  Copy file to  your C Drive remove all stuff and uncommnet DELETE commands
##  Create HEPYSTS_DELETE_SBK_20230510.rman


rmanc
@HEPYSTS_DELETE_SBK_20230510.rman
--DELETE NOPROMPT BACKUPSET xx;
--DELETE NOPROMPT BACKUPSET xx;

crosscheck backup;


.oraenv

HEPYSTS


RMAN> list incarnation of database;


List of Database Incarnations
DB Key  Inc Key DB Name  DB ID            STATUS  Reset SCN  Reset Time
------- ------- -------- ---------------- --- ---------- ----------
DB Key  Inc Key DB Name  DB ID            STATUS  Reset SCN  Reset Time
------- ------- -------- ---------------- --- ---------- ----------
10420079 10420209 HEPYSTS  880386359        PARENT  13641666736748 23-DEC-2022 01:53:17
10420079 10420080 HEPYSTS  880386359        PARENT  13641684768252 24-JAN-2023 07:12:59
10420079 10669179 HEPYSTS  880386359        CURRENT 13642470233864 07-APR-2023 08:42:09
10654379 10656421 HEPYSTS  886457218        PARENT  13622195284692 16-AUG-2022 15:44:23
10654379 10654380 HEPYSTS  886457218        PARENT  13623171592566 01-APR-2023 13:34:39
10654379 10666179 HEPYSTS  886457218        CURRENT 13623191943984 05-APR-2023 15:20:42



## Precreate new set of scripts. Copy old ones and make appropriate changes


CONFIGURE DEVICE TYPE 'SBT_TAPE' PARALLELISM 12 BACKUP TYPE TO BACKUPSET;

cd /home/oracle/tls/rman/



!!!! vi all files above and make appropriate changes..


!!!Suspend all OEM backup jobs
!!!Note backup next start times

BACKUP_HEPYSTS_XHEPYDBW21S_BIWKLY_LEVEL_1 - May 12 7 PM

BBACKUP_HEPYSTS_XHEPYDBW21S_DAILY_LEVEL_1 - May 10 7 PM

BACKUP_HEPYSTS_XHEPYDBW21S_LEVEL0 - May 19 7 PM



Run my script backup + save

cd /home/oracle/tls/rman/
nohup backup_HEPYSTS_b4_rlse2312.sh ${ORACLE_SID} backup_HEPYSTS_b4_rlse2312.rman

open new SS session
cd /home/oracle/tls/rman/

tail -f *.log



## mark backup keep 
rmanc

-- File date stamp will be different...

## Run this script to mark backupsets keep forever
@HEPYSTS_sbk_20230510_05:49:02.rman

Resume OEM Jobs




## Create Restore Script
## Get this from HEPYSTS_sbk_20230331_02:26:47.rman
vi 






## Save priv restore_HEPYSTS.rman

mv restore_HEPYSTS.rman restore_HEPYSTS.rman_20230511

vi restore_HEPYSTS.rman



set echo on
startup force nomount;
set DBID=880386359
reset database to incarnation 10669179;
restore the spfile;
restore controlfile from 'c-880386359-20230511-02';
alter database mount;
run{
restore database until sequence 1228;
recover database until sequence 1228;
}
alter database disable block change tracking;
alter database enable block change tracking using file '+DATA_01';
alter database open resetlogs;


--- Restore Steps

1. Suspend OEM jobs for HEPYSTS
2. comment out crontab jobs
3. Make sure HRP bring all apps down.

sqlplus / as sysdba

shutdown immediate
exit

asmcmd 


rm -r */HEPYSTS_XHEPYDBW21S



cd /home/oracle/tls/rman/
nohup restore_HEPYSTS.sh HEPYSTS

open new SS session
cd /home/oracle/tls/rman/logs


tail -f *.log




!!!! RMAN> alter database open resetlogs;
RMAN-00571: ===========================================================
RMAN-00569: =============== ERROR MESSAGE STACK FOLLOWS ===============
RMAN-00571: ===========================================================
RMAN-03002: failure of sql statement command at 04/07/2023 01:39:40
ORA-01378: The logical block size (4096) of file +REDOA_01 is not compatible with the disk sector size (media sector size is 512 and )

. oraenv

HEPYSTS
alter system set "_DISK_SECTOR_SIZE_OVERRIDE"=true scope=both;

alter database open resetlogs;

Received ORA-600..


###I cleared redo log group3 because it was marked current

alter database clear unarchived logfile group 3;



###I then bounce the instanace , startup nomount then opened resetlog

shutdown immediate;
startup mount
alter database open resetlogs;


HEPYSTS

select * from v$log

(Identify log groups that still blocksize 512) drop and re create them with 4096 


ALTER DATABASE DROP LOGFILE GROUP 6
/
ALTER DATABASE ADD LOGFILE GROUP 6 ('+REDOA_01','+REDOB_01') SIZE 6144M BLOCKSIZE 4096;

ALTER DATABASE DROP LOGFILE GROUP 3
/

ALTER DATABASE ADD LOGFILE GROUP 3 ('+REDOA_01','+REDOB_01') SIZE 6144M BLOCKSIZE 4096;

ALTER DATABASE DROP LOGFILE GROUP 4
/

ALTER DATABASE ADD LOGFILE GROUP 4 ('+REDOA_01','+REDOB_01') SIZE 6144M BLOCKSIZE 4096;

ALTER DATABASE DROP LOGFILE GROUP 5
/

ALTER DATABASE ADD LOGFILE GROUP 5 ('+REDOA_01','+REDOB_01') SIZE 6144M BLOCKSIZE 4096;



##After your restore is complete, query the heartbeat table and compare the heartbeat date
 to the heartbeat date in the backup log prior to enabling the heartbeat job in cron.
select * from aedba.rman_heartbeat order by 2


   sqlplus / as sysdba

   @?/rdbms/admin/utlrp.sql

	select count(*)
	from dba_objects
	where status = 'INVALID';


rmanc
CONFIGURE DEVICE TYPE 'SBT_TAPE' PARALLELISM 6 BACKUP TYPE TO BACKUPSET;

!!!!!!!!!!!!!!!!!!!!!!!!!!! GI + RU PATCHING ----> IF Needed




Once we get green light to remove saved backup do following
## Get DELETE NOPROMPT commands from this file HEPYSTS_sbk_20230331_02:26:47.rman

rmanc
DELETE NOPROMPT BACKUPSET xx;
DELETE NOPROMPT BACKUPSET xx;

--change back
CONFIGURE RETENTION POLICY TO RECOVERY WINDOW OF 14 DAYS;
crosscheck backup;


**********Pre 23.1.2 HEDWSTS save backup before HPR upgrade and restore steps

.oraenv

HEDWSTS

cd /home/oracle/tls/rman/


REMOVE PRIVIOUSE SAVED BACKUP
## Get DELETE NOPROMPT commands from last HEDWSTS_sbk... file

view HEDWSTS_sbk_20230331_06:43:03.rman

vi HEDWSTS_DELETE_SBK_20230510.rman
DELETE NOPROMPT BACKUPSET 11148653;
DELETE NOPROMPT BACKUPSET 11148724;
DELETE NOPROMPT BACKUPSET 11148725;
DELETE NOPROMPT BACKUPSET 11148725;
DELETE NOPROMPT BACKUPSET 11148725;
DELETE NOPROMPT BACKUPSET 11148725;
DELETE NOPROMPT BACKUPSET 11148725;
DELETE NOPROMPT BACKUPSET 11148725;
DELETE NOPROMPT BACKUPSET 11148725;
DELETE NOPROMPT BACKUPSET 11148726;
DELETE NOPROMPT BACKUPSET 11148727;
DELETE NOPROMPT BACKUPSET 11148728;
DELETE NOPROMPT BACKUPSET 11148729;
DELETE NOPROMPT BACKUPSET 11148730;
DELETE NOPROMPT BACKUPSET 11148731;
DELETE NOPROMPT BACKUPSET 11148731;
DELETE NOPROMPT BACKUPSET 11148731;
DELETE NOPROMPT BACKUPSET 11148731;
DELETE NOPROMPT BACKUPSET 11148977;
DELETE NOPROMPT BACKUPSET 11148987;
DELETE NOPROMPT BACKUPSET 11149009;
DELETE NOPROMPT BACKUPSET 11149022;
DELETE NOPROMPT BACKUPSET 11149056;
DELETE NOPROMPT BACKUPSET 11149071;

rmanc
@HEDWSTS_sbk_20230331_06:43:03.rman

crosscheck backup;


.oraenv

HEPYSTS




RMAN> list incarnation of database;


List of Database Incarnations
DB Key  Inc Key DB Name  DB ID            STATUS  Reset SCN  Reset Time
------- ------- -------- ---------------- --- ---------- ----------
10792117 10792577 HEDWSTS  508057578        PARENT  13609515762700 29-NOV-2022 18:14:41
10792117 10792118 HEDWSTS  508057578        PARENT  13614600124311 23-JAN-2023 11:29:55
10792117 11173546 HEDWSTS  508057578        CURRENT 13614969880415 06-APR-2023 10:57:32
11149417 11149879 HEDWSTS  514129988        PARENT  13607538940304 12-FEB-2022 11:10:15
11149417 11149418 HEDWSTS  514129988        PARENT  13614313985275 31-MAR-2023 18:17:06
11149417 11169517 HEDWSTS  514129988        CURRENT 13614327997354 05-APR-2023 14:33:26


.oraenv

HEDWSTS

cd /home/oracle/tls/rman/



!!!! vi all files above and make appropriate changes..



!!!Suspend all OEM backup jobs
!!! Note backup startup times

BACKUP_HEDWSTS_XHEDWDBW21S_DAILY_LEVEL_1 - Mar 31 11:30 PM

	
BACKUP_HEDWSTS_XHEDWDBW21S_LEVEL_0 - Apr 4 - 11:30 PM

BACKUP_HEDWSTS_XHEDWDBW21S_BIWKLY_LEVEL_1 - Apr 11 11:30 PM


Run my script backup + save

cd /home/oracle/tls/rman/
nohup backup_HEDWSTS_b4_rlse2312.sh ${ORACLE_SID} backup_HEDWSTS_b4_rlse2312.rman

open new SS session
cd /home/oracle/tls/rman/

tail -f *.log

ext_save_backup.sh
ext_save_backup.sh
## mark backup keep 
rmanc

-- File date stamp will be different...

## Run this script to mark backupsets keep forever
@HEDWSTS_sbk_20230510_05:51:58.rman

Resume OEM Jobs if needed




## Create Restore Script
## Get Restore portion from  HEDWSTS_sbk_20230331_06:43:03.rman + add some missing BT code from original restore script. See below example.





## Save priv restore_HEDWSTS.rman

mv restore_HEDWSTS.rman restore_HEDWSTS.rman_20230511


vi restore_HEDWSTS.rman
set echo on
startup force mount;
set DBID=508057578
reset database to incarnation 11173546;
restore the spfile;
restore controlfile from 'c-508057578-20230510-27';
alter database mount;
run{
restore database until sequence 4608;
recover database until sequence 4608;
}
alter database disable block change tracking;
alter database enable block change tracking using file '+DATA_01';
alter database open resetlogs;









--- Restore steps



1. Suspend OEM jobs for HEDWSTS if not already suspended
2. comment out crontab jobs
3. Make sure HRP bring all apps down.

sqlplus / as sysdba

shutdown immediate
exit

. oraenv
+ASM


asmcmd 




rm -r */HEDWSTS_XHEDWDBW21S



ps -ef | grep restore_HEDWSTS.sh





cd /home/oracle/tls/rman/
nohup restore_HEDWSTS.sh HEDWSTS

open new SS session
cd /home/oracle/tls/rman/logs


tail -f *.log

##After your restore is complete, query the heartbeat table and compare the heartbeat date
 to the heartbeat date in the backup log prior to enabling the heartbeat job in cron.
select * from aedba.rman_heartbeat order by 2


   sqlplus / as sysdba

   @?/rdbms/admin/utlrp.sql

	select count(*)
	from dba_objects
	where status = 'INVALID';





!!!!!!!!!!!!!!!!!!!!!!!!!!! GI + RU PATCHING 




Once we get green light to remove saved backup do following
rmanc


--change back
CONFIGURE RETENTION POLICY TO RECOVERY WINDOW OF 14 DAYS;
crosscheck backup;




**********HEPYUAT save backup before HPR upgrade and restore steps


Copy scripts from HEPYSTS server to HEPYUAT if they are not there already





.oraenv

HEPYSTS

cd /home/oracle/tls/rman/

scp ext_save_backup.sh xhepydbwu21q:/home/oracle/tls/rman/ext_save_backup.sh
scp backup_HEPYSTS_b4_rlse2312.sh xhepydbwu21q:/home/oracle/tls/rman/backup_HEPYUAT_b4_rlse2312.sh
scp backup_HEPYSTS_b4_rlse2312.rman xhepydbwu21q:/home/oracle/tls/rman/backup_HEPYUAT_b4_rlse2312.rman



REMOVE PRIVIOUSE SAVED BACKUP
## Get DELETE NOPROMPT commands from this file HEPYSTS_sbk_20230331_02:26:47.rman 
##  Copy file to  your C Drive remove all stuff and uncommnet DELETE commands
##  Create HEPYSTS_DELETE_SBK_20230510.rman


!!! No need this time. Because this is first time
rmanc
---@HEPYSTS_DELETE_SBK_20230510.rman
--DELETE NOPROMPT BACKUPSET xx;
--DELETE NOPROMPT BACKUPSET xx;

crosscheck backup;


.oraenv

HEPYUAT


RMAN> list incarnation of database;



List of Database Incarnations
DB Key  Inc Key DB Name  DB ID            STATUS  Reset SCN  Reset Time
------- ------- -------- ---------------- --- ---------- ----------
5202315 5203737 HEPYUAT  3363474932       PARENT  13569781452168 02-SEP-2020 21:43:56
5202315 5202316 HEPYUAT  3363474932       CURRENT 13570500236902 13-NOV-2020 23:34:47



## Precreate new set of scripts. Copy old ones and make appropriate changes

!! No need for UAT
--CONFIGURE DEVICE TYPE 'SBT_TAPE' PARALLELISM 12 BACKUP TYPE TO BACKUPSET;

cd /home/oracle/tls/rman/



!!!! vi all files above and make appropriate changes..


!!!Suspend all OEM backup jobs
!!!Note backup next start times




Run my script backup + save

cd /home/oracle/tls/rman/
nohup backup_HEPYUAT_b4_rlse2312.sh ${ORACLE_SID} backup_HEPYUAT_b4_rlse2312.rman

open new SS session
cd /home/oracle/tls/rman/

tail -f *.log



## mark backup keep 
rmanc

-- File date stamp will be different...

## Run this script to mark backupsets keep forever
@HEPYUAT_sbk_XXXXXX_XX:XX:XX.rman

Resume OEM Jobs




## Create Restore Script
## Get this from HEPYUAT_sbk_XXXXX_02:26:47.rman
vi 






## Save priv restore_HEPYUAT.rman if exist

mv restore_HEPYUAT.rman restore_HEPYUAT.rman_xxx

vi restore_HEPYUAT.rman



set echo on
startup force nomount;
set DBID=880386359
reset database to incarnation 10669179;
restore the spfile;
restore controlfile from 'c-880386359-20230511-02';
alter database mount;
run{
restore database until sequence 1228;
recover database until sequence 1228;
}
alter database disable block change tracking;
alter database enable block change tracking using file '+DATA_01';
alter database open resetlogs;


--- Restore Steps

1. Suspend OEM jobs for HEPYUAT
2. comment out crontab jobs
3. Make sure HRP bring all apps down.

sqlplus / as sysdba

shutdown immediate
exit

asmcmd 


rm -r */HEPYUAT_XHEPYDBWU21Q



cd /home/oracle/tls/rman/
nohup restore_HEPYUAT.sh HEPYUAT

open new SS session
cd /home/oracle/tls/rman/logs


tail -f *.log






##After your restore is complete, query the heartbeat table and compare the heartbeat date
 to the heartbeat date in the backup log prior to enabling the heartbeat job in cron.
select * from aedba.rman_heartbeat order by 2


   sqlplus / as sysdba

   @?/rdbms/admin/utlrp.sql

	select count(*)
	from dba_objects
	where status = 'INVALID';


rmanc
CONFIGURE DEVICE TYPE 'SBT_TAPE' PARALLELISM 6 BACKUP TYPE TO BACKUPSET;

!!!!!!!!!!!!!!!!!!!!!!!!!!! GI + RU PATCHING ----> IF Needed




Once we get green light to remove saved backup do following
## Get DELETE NOPROMPT commands from this file HEPYSUAT_sbk_XXXXX_02:26:47.rman

rmanc
DELETE NOPROMPT BACKUPSET xx;
DELETE NOPROMPT BACKUPSET xx;

--change back
CONFIGURE RETENTION POLICY TO RECOVERY WINDOW OF 14 DAYS;
crosscheck backup;



**********HEDWUAT save backup before HPR upgrade and restore steps


Copy scripts from HEDWSTS server to HEDWUAT if they are not there already





.oraenv

HEDWSTS

cd /home/oracle/tls/rman/

scp ext_save_backup.sh xhedwdbwu21q:/home/oracle/tls/rman/ext_save_backup.sh
scp backup_HEDWSTS_b4_rlse2312.sh xhedwdbwu21q:/home/oracle/tls/rman/backup_HEDWUAT_b4_rlse2312.sh
scp backup_HEDWSTS_b4_rlse2312.rman xhedwdbwu21q:/home/oracle/tls/rman/backup_HEDWUAT_b4_rlse2312.rman



REMOVE PRIVIOUSE SAVED BACKUP
## Get DELETE NOPROMPT commands from this file HEPYSTS_sbk_20230331_02:26:47.rman 
##  Copy file to  your C Drive remove all stuff and uncommnet DELETE commands
##  Create HEDWSTS_DELETE_SBK_20230510.rman


!!! No need this time. Because this is first time
rmanc
---@HEDWSTS_DELETE_SBK_20230510.rman
--DELETE NOPROMPT BACKUPSET xx;
--DELETE NOPROMPT BACKUPSET xx;

crosscheck backup;


.oraenv

HEDWUAT


RMAN> list incarnation of database;




List of Database Incarnations
DB Key  Inc Key DB Name  DB ID            STATUS  Reset SCN  Reset Time
------- ------- -------- ---------------- --- ---------- ----------
5287239 5287746 HEDWUAT  3520657209       PARENT  13560420675273 06-JAN-2020 16:45:44
5287239 5287240 HEDWUAT  3520657209       CURRENT 13564695590046 13-NOV-2020 18:15:32


## Precreate new set of scripts. Copy old ones and make appropriate changes




!!!Suspend all OEM backup jobs
!!!Note backup next start times




Run my script backup + save

cd /home/oracle/tls/rman/
nohup backup_HEDWUAT_b4_rlse2312.sh ${ORACLE_SID} backup_HEDWUAT_b4_rlse2312.rman

open new SS session
cd /home/oracle/tls/rman/

tail -f *.log



## mark backup keep 
rmanc

-- File date stamp will be different...

## Run this script to mark backupsets keep forever
@HEDWUAT_sbk_XXXXXX_XX:XX:XX.rman

Resume OEM Jobs




## Create Restore Script
## Get this from HEDWUAT_sbk_XXXXX_02:26:47.rman
vi 






## Save priv restore_HEDWUAT.rman if exist

mv restore_HEDWUAT.rman restore_HEDWUAT.rman_xxx

vi restore_HEDWUAT.rman



set echo on
startup force nomount;
set DBID=880386359
reset database to incarnation 10669179;
restore the spfile;
restore controlfile from 'c-880386359-20230511-02';
alter database mount;
run{
restore database until sequence 1228;
recover database until sequence 1228;
}
alter database disable block change tracking;
alter database enable block change tracking using file '+DATA_01';
alter database open resetlogs;


--- Restore Steps

1. Suspend OEM jobs for HEDWUAT
2. comment out crontab jobs
3. Make sure HRP bring all apps down.

sqlplus / as sysdba

shutdown immediate
exit

asmcmd 


rm -r */HEDWUAT_XHEDWDBWU21Q



cd /home/oracle/tls/rman/
nohup restore_HEDWUAT.sh HEDWUAT

open new SS session
cd /home/oracle/tls/rman/logs


tail -f *.log






##After your restore is complete, query the heartbeat table and compare the heartbeat date
 to the heartbeat date in the backup log prior to enabling the heartbeat job in cron.
select * from aedba.rman_heartbeat order by 2


   sqlplus / as sysdba

   @?/rdbms/admin/utlrp.sql

	select count(*)
	from dba_objects
	where status = 'INVALID';


rmanc
CONFIGURE DEVICE TYPE 'SBT_TAPE' PARALLELISM 6 BACKUP TYPE TO BACKUPSET;

!!!!!!!!!!!!!!!!!!!!!!!!!!! GI + RU PATCHING ----> IF Needed




Once we get green light to remove saved backup do following
## Get DELETE NOPROMPT commands from this file HEDWUAT_sbk_XXXXX_02:26:47.rman

rmanc
DELETE NOPROMPT BACKUPSET xx;
DELETE NOPROMPT BACKUPSET xx;

--change back
CONFIGURE RETENTION POLICY TO RECOVERY WINDOW OF 14 DAYS;
crosscheck backup;




***** Restore HEPYQA from point in time *****



cd /home/oracle/tls/rman
./create_restore_point_new.sh HEPYQA B4DROP20230724

Run Archivelog backup

1. Suspend OEM backups
2. comment out crontab
3. Make sure HRP bring all apps down.

sqlplus / as sysdba

shutdown immediate

 ps -ef |grep pmon

exit

. oraenv
+ASM

asmcmd 

--Just for reference
cd +DATA_01/HEPYQA_XHEPYDBW21Q/DATAFILE
ASMCMD> du
Used_MB      Mirror_used_MB
85293484            85293484

Used_MB      Mirror_used_MB
68403372            68403372

76288196            76288196

83661016            83661016



rm all data files...




select  TOTALWORK, sofar, ROUND((sofar/totalwork) * 100,2) pct_done,
sysdate + TIME_REMAINING/3600/24 end_time
from   v$session_longops 
where  totalwork > sofar
and opname like 'RMAN%';


--Get latest Restore Point name

--select name, scn, time from v$restore_point order by time;


cd /home/oracle/tls/rman/

-- Special script to handle restore databases with DATA_01 and IND_01
vi restore_HEPYQA.rman

set echo on
startup force mount;
run {
set  until time "to_date('2023-07-14 11:19:00', 'YYYY-MM-DD HH24:MI:SS')";
restore database;
recover database;
}
alter database disable block change tracking;
alter database enable block change tracking using file '+DATA_01';
alter database open resetlogs;

~

ps -ef | grep restore_HEPYQA.sh

ps -ef | grep *.rman


nohup restore_HEPYQA.sh HEPYQA

open new SS session
cd /home/oracle/tls/rman/logs

##After your restore is complete, query the heartbeat table and compare the heartbeat date
 to the heartbeat date in the backup log prior to enabling the heartbeat job in cron.
select * from aedba.rman_heartbeat order by 2


   sqlplus / as sysdba

   @?/rdbms/admin/utlrp.sql

	select count(*)
	from dba_objects
	where status = 'INVALID';


Resume OEM backups
Uncomment out crontab



***** Restore HEDWQA from point in time *****



cd /home/oracle/tls/rman
./create_restore_point_new.sh HEDWQA B4DROP20230724

Run Archivelog backup

1. Suspend OEM backups
2. comment out crontab
3. Make sure HRP bring all apps down.

sqlplus / as sysdba

shutdown immediate

 ps -ef |grep pmon

exit

. oraenv
+ASM

asmcmd 

--Just for reference
cd +DATA_01/HEDWQA_XHEDWDBW21Q/DATAFILE
ASMCMD> du






rm all data files...




select  TOTALWORK, sofar, ROUND((sofar/totalwork) * 100,2) pct_done,
sysdate + TIME_REMAINING/3600/24 end_time
from   v$session_longops 
where  totalwork > sofar
and opname like 'RMAN%';


--Get latest Restore Point name

--select name, scn, time from v$restore_point order by time;


cd /home/oracle/tls/rman/

-- Special script to handle restore databases with DATA_01 and IND_01
vi restore_HEPYQA.rman

set echo on
startup force mount;
run {
set  until time "to_date('2023-07-14 11:19:00', 'YYYY-MM-DD HH24:MI:SS')";
restore database;
recover database;
}
alter database disable block change tracking;
alter database enable block change tracking using file '+DATA_01';
alter database open resetlogs;

~

ps -ef | grep restore_HEDWQA.sh

ps -ef | grep *.rman


nohup restore_HEDWQA.sh HEDWQA

open new SS session
cd /home/oracle/tls/rman/logs

##After your restore is complete, query the heartbeat table and compare the heartbeat date
 to the heartbeat date in the backup log prior to enabling the heartbeat job in cron.
select * from aedba.rman_heartbeat order by 2


   sqlplus / as sysdba

   @?/rdbms/admin/utlrp.sql

	select count(*)
	from dba_objects
	where status = 'INVALID';


Resume OEM backups
Uncomment out crontab



**********Pre 23.2.12 HEDWSTS save backup before HPR upgrade and restore steps

.oraenv

HEDWSTS

cd /home/oracle/tls/rman/


###REMOVE PRIVIOUSE SAVED BACKUP
## Get DELETE NOPROMPT commands from last HEDWSTS_sbk... file
HEDWSTS_sbk_20230510_05:51:58.rman

## Create new .rman file for delete

vi HEDWSTS_DELETE_SBK_20230510.rman

##Delete DataBase Backup
DELETE NOPROMPT BACKUPSET 11352877;
DELETE NOPROMPT BACKUPSET 11352924;
DELETE NOPROMPT BACKUPSET 11352925;
DELETE NOPROMPT BACKUPSET 11352926;
DELETE NOPROMPT BACKUPSET 11352927;
DELETE NOPROMPT BACKUPSET 11352927;
DELETE NOPROMPT BACKUPSET 11352927;
DELETE NOPROMPT BACKUPSET 11352927;
DELETE NOPROMPT BACKUPSET 11352927;
DELETE NOPROMPT BACKUPSET 11352927;
DELETE NOPROMPT BACKUPSET 11352927;
DELETE NOPROMPT BACKUPSET 11352928;
DELETE NOPROMPT BACKUPSET 11352929;
DELETE NOPROMPT BACKUPSET 11352930;
DELETE NOPROMPT BACKUPSET 11352931;
DELETE NOPROMPT BACKUPSET 11352931;
DELETE NOPROMPT BACKUPSET 11352931;
DELETE NOPROMPT BACKUPSET 11352931;
DELETE NOPROMPT BACKUPSET 11353177;
DELETE NOPROMPT BACKUPSET 11353187;
DELETE NOPROMPT BACKUPSET 11353209;
DELETE NOPROMPT BACKUPSET 11353222;
DELETE NOPROMPT BACKUPSET 11353256;
DELETE NOPROMPT BACKUPSET 11353271;
##End Delete DataBase Backup




rmanc
@HEDWSTS_DELETE_SBK_20230510.rman

crosscheck backup;


.oraenv

HEDWSTS


## Saved for reference

RMAN> list incarnation of database;


List of Database Incarnations
DB Key  Inc Key DB Name  DB ID            STATUS  Reset SCN  Reset Time
------- ------- -------- ---------------- --- ---------- ----------
10792117 10792577 HEDWSTS  508057578        PARENT  13609515762700 29-NOV-2022 18:14:41
10792117 10792118 HEDWSTS  508057578        PARENT  13614600124311 23-JAN-2023 11:29:55
10792117 11173546 HEDWSTS  508057578        CURRENT 13614969880415 06-APR-2023 10:57:32
11149417 11149879 HEDWSTS  514129988        PARENT  13607538940304 12-FEB-2022 11:10:15
11149417 11149418 HEDWSTS  514129988        PARENT  13614313985275 31-MAR-2023 18:17:06
11149417 11169517 HEDWSTS  514129988        CURRENT 13614327997354 05-APR-2023 14:33:26


.oraenv

HEDWSTS

cd /home/oracle/tls/rman/



!!!! vi all files above and make appropriate changes..



!!!Suspend all OEM backup jobs
!!! Note backup startup times

BACKUP_HEDWSTS_XHEDWDBW21S_DAILY_LEVEL_1 - Mar 31 11:30 PM

	
BACKUP_HEDWSTS_XHEDWDBW21S_LEVEL_0 - Apr 4 - 11:30 PM

BACKUP_HEDWSTS_XHEDWDBW21S_BIWKLY_LEVEL_1 - Apr 11 11:30 PM



## Create new backup script for this release as copy from previous release. Change Tags etc..

vi backup_HEDWSTS_b4_rlse23_2.rman
vi backup_HEDWSTS_b4_rlse23_2.sh

Run my script backup + save

cd /home/oracle/tls/rman/
nohup backup_HEDWSTS_b4_rlse23_2.sh ${ORACLE_SID} backup_HEDWSTS_b4_rlse23_2.rman

open new SS session
cd /home/oracle/tls/rman/

tail -f *.log

## mark backup keep 
rmanc

-- File date stamp will be different...

## Run this script to mark backupsets keep forever
@HEDWSTS_sbk_20230925_03:52:20.rman

Resume OEM Jobs if needed




## Create Restore Script
## Get Restore portion from  HEDWSTS_sbk_20230331_06:43:03.rman + add some missing BT code from original restore script. See below example.





## Save priv restore_HEDWSTS.rman

mv restore_HEDWSTS.rman restore_HEDWSTS.rman_priv


vi restore_HEDWSTS.rman
set echo on
startup force mount;
set DBID=508057578
reset database to incarnation 11173546;
restore the spfile;
restore controlfile from 'c-508057578-20230925-23';
alter database mount;
run{
restore database until sequence 29189;
recover database until sequence 29189;;
}
alter database disable block change tracking;
alter database enable block change tracking using file '+DATA_01';
alter database open resetlogs;









--- Restore steps



1. Suspend OEM jobs for HEDWSTS if not already suspended
2. comment out crontab jobs
3. Make sure HRP bring all apps down.

sqlplus / as sysdba

shutdown immediate
exit

. oraenv
+ASM


asmcmd 




rm -r */HEDWSTS_XHEDWDBW21S



ps -ef | grep restore_HEDWSTS.sh





cd /home/oracle/tls/rman/
nohup restore_HEDWSTS.sh HEDWSTS

open new SS session
cd /home/oracle/tls/rman/logs


tail -f *.log

##After your restore is complete, query the heartbeat table and compare the heartbeat date
 to the heartbeat date in the backup log prior to enabling the heartbeat job in cron.
select * from aedba.rman_heartbeat order by 2


   sqlplus / as sysdba

   @?/rdbms/admin/utlrp.sql

	select count(*)
	from dba_objects
	where status = 'INVALID';






!!!!!!!!!!!!!!!!!!!!!!!!!!! GI + RU PATCHING if needed






Once we get green light to remove saved backup do following
rmanc


--change back
CONFIGURE RETENTION POLICY TO RECOVERY WINDOW OF 14 DAYS;
crosscheck backup;



**********Pre 23.2.12 HEPYSTS save backup before HPR upgrade and restore steps

.oraenv

HEPYSTS

cd /home/oracle/tls/rman/


###REMOVE last SAVED BACKUP
## Get DELETE NOPROMPT commands from last HEPYSTS_sbk... file
HEDWSTS_sbk_20230510_05:51:58.rman

## Create new .rman file for delete

vi HEPYTS_DELETE_SBK_20230510.rman

##Delete DataBase Backup
DELETE NOPROMPT BACKUPSET 11352877;
DELETE NOPROMPT BACKUPSET 11352924;
...
##End Delete DataBase Backup




rmanc
@HEPYSTS_DELETE_SBK_20230510.rman

crosscheck backup;


.oraenv

HEPYSTS


## Saved for reference

RMAN> list incarnation of database;



List of Database Incarnations
DB Key  Inc Key DB Name  DB ID            STATUS  Reset SCN  Reset Time
------- ------- -------- ---------------- --- ---------- ----------
10420079 10420209 HEPYSTS  880386359        PARENT  13641666736748 23-DEC-2022 01:53:17
10420079 10420080 HEPYSTS  880386359        PARENT  13641684768252 24-JAN-2023 07:12:59
10420079 10669179 HEPYSTS  880386359        CURRENT 13642470233864 07-APR-2023 08:42:09
10654379 10656421 HEPYSTS  886457218        PARENT  13622195284692 16-AUG-2022 15:44:23
10654379 10654380 HEPYSTS  886457218        PARENT  13623171592566 01-APR-2023 13:34:39
10654379 10666179 HEPYSTS  886457218        CURRENT 13623191943984 05-APR-2023 15:20:42


.oraenv

HEPYSTS

cd /home/oracle/tls/rman/



!!!! vi all files above and make appropriate changes..



!!!Suspend all OEM backup jobs
!!! Note backup startup times




## Create new backup script for this release as copy from previous release. Change Tags etc..

vi backup_HEPYSTS_b4_rlse23_2.rman
vi backup_HEPYSTS_b4_rlse23_2.sh

Run my script backup + save

cd /home/oracle/tls/rman/
nohup backup_HEPYSTS_b4_rlse23_2.sh ${ORACLE_SID} backup_HEPYSTS_b4_rlse23_2.rman

open new SS session
cd /home/oracle/tls/rman/

tail -f *.log



## mark backup keep 
rmanc

-- File date stamp will be different...

## Run this script to mark backupsets keep forever
@HEPYSTS_sbk_20230925_03:57:27.rman

Resume OEM Jobs if needed




## Create Restore Script
## Get Restore portion from  HEDWSTS_sbk_20230331_06:43:03.rman + add some missing BT code from original restore script. See below example.





## Save priv restore_HEPYSTS.rman

mv restore_HEPYSTS.rman restore_HEPYSTS.rman_priv


vi restore_HEPYSTS.rman
set echo on
startup force mount;
set DBID=880386359
reset database to incarnation 10669179;
restore the spfile;
restore controlfile from 'c-880386359-20230925-13';
alter database mount;
run{
restore database until sequence 7583;
recover database until sequence 7583;
}
alter database disable block change tracking;
alter database enable block change tracking using file '+DATA_01';
alter database open resetlogs;







--- Restore steps



1. Suspend OEM jobs for HEPYSTS if not already suspended
2. comment out crontab jobs
3. Make sure HRP bring all apps down.

sqlplus / as sysdba

shutdown immediate
exit

. oraenv
+ASM


asmcmd 




rm -r */HEDWSTS_XHEPYDBW21S



ps -ef | grep restore_HEPYSTS.sh





cd /home/oracle/tls/rman/
nohup restore_HEPYSTS.sh HEPYSTS

open new SS session
cd /home/oracle/tls/rman/logs


tail -f *.log

##After your restore is complete, query the heartbeat table and compare the heartbeat date
 to the heartbeat date in the backup log prior to enabling the heartbeat job in cron.
select * from aedba.rman_heartbeat order by 2


   sqlplus / as sysdba

   @?/rdbms/admin/utlrp.sql

	select count(*)
	from dba_objects
	where status = 'INVALID';





!!!!!!!!!!!!!!!!!!!!!!!!!!! GI + RU PATCHING if needed






Once we get green light to remove saved backup do following
rmanc


--change back
CONFIGURE RETENTION POLICY TO RECOVERY WINDOW OF 30 DAYS;
crosscheck backup;



*****  Restore HEPYSTS to point  in time ****

!!! New Oracle RU was applied after, so restore needs to be done back to old RU Oracle Home and new RU applied afterwards.




1. Suspend OEM jobs for HEPYSTS if not already suspended
2. comment out crontab jobs
3. Make sure HRP bring all apps down.
4. Shutdown database
   
   srvctl stop database -d HEPYSTS_xhepydbw21s

ps -ef |grep pmon
ps -ef | grep tns

5. Point HEPYSTS to old oracle home

cd /etc
vi oratab
change --> HEPYSTS:/orahome/u01/app/oracle/product/19.22.0/db_1:N
           HEPYSTS:/orahome/u01/app/oracle/product/19.18.0/db_1:N 



. oraenv
HEPYSTS





ps -ef | grep restore_HEPYSTS.sh





cd /home/oracle/tls/rman/

vi  restore_HEPYSTS.rman

set echo on
startup force mount;
run {
 set until time "to_date('23-FEB-2024 09:01:00','DD-MON-YYYY HH24:MI:SS')";
 restore database;
 recover database;
}
alter database disable block change tracking;
alter database enable block change tracking using file '+DATA_01';
alter database open resetlogs;


!! because Oracle Home RU downgrade copy spfile back to old oracle home, because it not longer there
cd /orahome/u01/app/oracle/product/19.22.0/db_1/dbs
cp spfileHEPYSTS.ora /orahome/u01/app/oracle/product/19.18.0/db_1/dbs/spfileHEPYSTS.ora


nohup restore_HEPYSTS.sh HEPYSTS

open new SS session
cd /home/oracle/tls/rman/logs


tail -f *.log

##After your restore is complete, query the heartbeat table and compare the heartbeat date
 to the heartbeat date in the backup log prior to enabling the heartbeat job in cron.
select * from aedba.rman_heartbeat order by 2


   sqlplus / as sysdba

   @?/rdbms/admin/utlrp.sql

	select count(*)
	from dba_objects
	where status = 'INVALID';

!! Apply Latest Oracle RU via Jenkins

To avoid folowing error with Jenkings parch db

fatal: [xhedwdbw21s.aetna.com]: FAILED! => {"changed": false, "content": "xhedwdbw21s", "msg": "DBS file copied failed"}

1. Shutdown database

2. Copy all spfileHEPYSTS.ora, orapwHEPYSTS from 22 to 18 Oracle home

cd /orahome/u01/app/oracle/product/19.22.0/db_1/dbs

cp spfileHEPYSTS.ora /orahome/u01/app/oracle/product/19.18.0/db_1/dbs/spfileHEPYSTS.ora

cp orapwHEPYSTS /orahome/u01/app/oracle/product/19.18.0/db_1/dbs/orapwHEPYSTS

rename files under 22 home

mv spfileHEPYSTS.ora spfileHEPYSTS.ora_bkp
mv orapwHEPYSTS orapwHEPYSTS_bkp
mv hc_HEPYSTS.dat hc_HEPYSTS.dat_bkp
mv lkHEPYSTS lkHEPYSTS_bkp
mv lkHEPYSTS_XHEPYDBW21S lkHEPYSTS_XHEPYDBW21S_bkp


srvctl config database -d HEPYSTS_xhepydbw21s

srvctl modify database -d HEPYSTS_xhepydbw21s -oraclehome $ORACLE_HOME -spfile $ORACLE_HOME/dbs/spfileHEPYSTS.ora

srvctl config database -d HEPYSTS_xhepydbw21s

srvctl start database -d HEPYSTS_xhepydbw21s

srvctl config listener -l HEPYSTS

srvctl stop listener -l HEPYSTS
srvctl modify  listener -l HEPYSTS -oraclehome $ORACLE_HOME
srvctl config listener -l HEPYSTS
srvctl start listener -l HEPYSTS


ps -ef |grep pmon
ps -ef | grep tns

--> Apply Latest Oracle RU via Jenkins

https://ci-autoeng.cvshealth.com/jenkins/

patch_release: 19.22.0
instance_name: HEPYSTS

xhepydbw21s.aetna.com


BACKUP_HEPYSTS_XHEPYDBW21S_LEVEL0  - Next Apr 2, 2024 11:30:00 PM EDT - By weeks 2 SHould of ran March 22 7 PM



*****  Restore HEDWSTS to point  in time ****

!!! New Oracle RU was applied after, so restore needs to be done back to old RU Oracle Home and new RU applied afterwards.




1. Suspend OEM jobs for HEDWSTS if not already suspended
2. comment out crontab jobs
3. Make sure HRP bring all apps down.

4. Shutdown database
   

   srvctl stop database -d HEDWSTS_xhedwdbw21s

 srvctl start database -d HEDWSTS_xhedwdbw21s

srvctl modify database -d HEDWSTS_xhedwdbw21s -oraclehome $ORACLE_HOME -spfile $ORACLE_HOME/dbs/spfileHEDWSTS.ora

ps -ef |grep pmon
ps -ef | grep tns

srvctl stop listener -l HEDWSTS

srvctl start listener -l HEDWSTS

srvctl config listener -l HEDWSTS

srvctl modify  listener -l HEDWSTS -oraclehome $ORACLE_HOME


5. Point HEDWSTS to old oracle home

cd /etc
vi oratab
change --> HEDWSTS:/orahome/u01/app/oracle/product/19.22.0/db_1:N
           HEDWSTS:/orahome/u01/app/oracle/product/19.18.0/db_1:N 



. oraenv
HEDWSTS

srvctl start listener -l HEDWSTS



ps -ef | grep restore_HEDWSTS.sh





cd /home/oracle/tls/rman/

vi  restore_HEDWSTS.rman

set echo on
startup force mount;
run {
 set until time "to_date('23-FEB-2024 09:01:00','DD-MON-YYYY HH24:MI:SS')";
 restore database;
 recover database;
}
alter database disable block change tracking;
alter database enable block change tracking using file '+DATA_01';
alter database open resetlogs;



!! because Oracle Home RU downgrade copy spfile back to old oracle home, because it not longer there
cd /orahome/u01/app/oracle/product/19.22.0/db_1/dbs
cp spfileHEDWSTS.ora /orahome/u01/app/oracle/product/19.18.0/db_1/dbs/spfileHEDWSTS.ora


nohup restore_HEDWSTS.sh HEDWSTS

open new SS session
cd /home/oracle/tls/rman/logs


tail -f *.log

##After your restore is complete, query the heartbeat table and compare the heartbeat date
 to the heartbeat date in the backup log prior to enabling the heartbeat job in cron.
select * from aedba.rman_heartbeat order by 2


   sqlplus / as sysdba

   @?/rdbms/admin/utlrp.sql

	select count(*)
	from dba_objects
	where status = 'INVALID';

!! Apply Latest Oracle RU via Jenkins

To avoid folowing error with Jenkings parch db

fatal: [xhedwdbw21s.aetna.com]: FAILED! => {"changed": false, "content": "xhedwdbw21s", "msg": "DBS file copied failed"}

1. Shutdown database

2. Copy all spfileHEDWSTS.ora, orapwHEDWSTS from 22 to 18 Oracle home

cd /orahome/u01/app/oracle/product/19.22.0/db_1/dbs

cp spfileHEDWSTS.ora /orahome/u01/app/oracle/product/19.18.0/db_1/dbs/spfileHEDWSTS.ora

cp orapwHEDWSTS /orahome/u01/app/oracle/product/19.18.0/db_1/dbs/orapwHEDWSTS

rename files under 22 home

mv spfileHEDWSTS.ora spfileHEDWSTS.ora_bkp
mv orapwHEDWSTS orapwHEDWSTS_bkp
mv hc_HEDWSTS.dat hc_HEDWSTS.dat_bkp
mv lkHEDWSTS lkHEDWSTS_bkp
mv lkHEDWSTS_XHEDWDBW21S lkHEDWSTS_XHEDWDBW21S_bkp


srvctl config database -d HEDWSTS_xhedwdbw21s

srvctl modify database -d HEDWSTS_xhedwdbw21s -oraclehome $ORACLE_HOME -spfile $ORACLE_HOME/dbs/spfileHEDWSTS.ora

srvctl config database -d HEDWSTS_xhedwdbw21s

srvctl start database -d HEDWSTS_xhedwdbw21s

srvctl config listener -l HEDWSTS

srvctl stop listener -l HEDWSTS
srvctl modify  listener -l HEDWSTS -oraclehome $ORACLE_HOME
srvctl config listener -l HEDWSTS
srvctl start listener -l HEDWSTS


ps -ef |grep pmon
ps -ef | grep tns



