**** Wkabprod*****

0 3 * * 0 /workability/home/oracle/Scripts/arch_purge_ora_audit_trail.ksh -i wkabprod > /dev/null 2>&1

1. Create AEDBA user
2. Create tables

CREATE TABLE AEDBA.AEDBA_DB_AUDIT_ROLLUP
(
    WEEK_BEGINNING DATE              NULL,
    USERNAME       VARCHAR2(30)      NULL,
    OS_USERNAME    VARCHAR2(255)     NULL,
    USERHOST       VARCHAR2(128)     NULL,
    ROWCNT         NUMBER            NULL
)
ORGANIZATION HEAP
TABLESPACE TOOLS
NOLOGGING
PCTFREE 10
PCTUSED 0
INITRANS 1
MAXTRANS 255
STORAGE(BUFFER_POOL DEFAULT)
PARALLEL(DEGREE 2 INSTANCES 1)
NOCACHE
NOROWDEPENDENCIES
/


CREATE TABLE AEDBA.AEDBA_DB_AUDIT_ARCH_TMP_FRAG
(
    USERNAME    VARCHAR2(30)      NULL,
    OS_USERNAME VARCHAR2(255)     NULL,
    USERHOST    VARCHAR2(128)     NULL,
    TIMESTAMP   DATE              NULL,
    LOGOFF_TIME DATE              NULL,
    SESSIONID   NUMBER        NOT NULL
)
ORGANIZATION HEAP
TABLESPACE TAEDBA
LOGGING
PCTFREE 10
PCTUSED 0
INITRANS 1
MAXTRANS 255
STORAGE(BUFFER_POOL DEFAULT)
NOPARALLEL
NOCACHE
NOROWDEPENDENCIES
/



3. Create procedrue


CREATE OR REPLACE PACKAGE BODY AEDBA."AEDBA_AUDIT_MAINT"
is
   procedure audit_archive_purge
   is
   -- Set the window of time to save in sys.aud$
   l_window number := 14;

   begin
      -- Use insert append so that data will be compressed
      insert into "AEDBA"."AEDBA_DB_AUDIT_ROLLUP"
       SELECT trunc(next_day(to_date(TIMESTAMP)-7, 'SUNDAY')) AS WEEK_BEGINNING,
         username,
         os_username,
         userhost,
         COUNT(*) AS rowcnt
         FROM dba_audit_trail
        WHERE ACTION_NAME in ('LOGOFF', 'LOGON', 'LOGOFF BY CLEANUP')
          AND TIMESTAMP < trunc(next_day(to_date(sysdate)-l_window,'SUNDAY'))
      GROUP BY trunc(next_day(to_date(TIMESTAMP)-7,'SUNDAY')),
         username,
         os_username,
         userhost;

      delete
        from sys.aud$
       where from_tz(ntimestamp#,'00:00') at local < trunc(next_day(to_date(sysdate)-l_window,'SUNDAY'));
      commit;
   exception
      when others then
      begin
         -- Roll back so we can re-try this block again later
         rollback;
         dbms_output.put_line('Error: ' || SQLCODE || ' Msg: ' || SUBSTR(SQLERRM, 1, 64));

         -- Re-throw the error so we'll get a failure.
         raise;
      end;
   end;

end aedba_audit_maint;
/


CREATE OR REPLACE PACKAGE AEDBA.aedba_audit_maint
is
   procedure audit_archive_purge;
end aedba_audit_maint;
/


4. Stage and add entry in cron

0 3 * * 0 /workability/home/oracle/Scripts/arch_purge_ora_audit_trail.ksh -i wkabprod > /dev/null 2>&1




*********DR02 and DM02***********


1. Create OPS$ORACLE user
2. Create tables
CREATE TABLE OPS$ORACLE.AEDBA_DB_AUDIT_ROLLUP
(
    WEEK_BEGINNING DATE              NULL,
    USERNAME       VARCHAR2(30)      NULL,
    OS_USERNAME    VARCHAR2(255)     NULL,
    USERHOST       VARCHAR2(128)     NULL,
    ROWCNT         NUMBER            NULL
)
ORGANIZATION HEAP
TABLESPACE TOOLS
NOLOGGING
PCTFREE 10
PCTUSED 40
INITRANS 1
MAXTRANS 255
STORAGE(BUFFER_POOL DEFAULT)
PARALLEL(DEGREE 2 INSTANCES 1)
NOCACHE
NOROWDEPENDENCIES
/

3. Create procedrue

CREATE OR REPLACE PACKAGE OPS$ORACLE."AEDBA_AUDIT_MAINT"
is
   procedure audit_archive_purge;
end aedba_audit_maint;
/


CREATE OR REPLACE PACKAGE BODY OPS$ORACLE."AEDBA_AUDIT_MAINT"
is
   procedure audit_archive_purge
   is
   -- Set the window of time to save in sys.aud$
   l_window number := 14;

   begin
      -- Use insert append so that data will be compressed
      insert into "OPS$ORACLE"."AEDBA_DB_AUDIT_ROLLUP"
       SELECT trunc(next_day(to_date(TIMESTAMP)-7, 'SUNDAY')) AS WEEK_BEGINNING,
         username,
         os_username,
         userhost,
         COUNT(*) AS rowcnt
         FROM dba_audit_trail
        WHERE ACTION_NAME in ('LOGOFF', 'LOGON', 'LOGOFF BY CLEANUP')
          AND TIMESTAMP < trunc(next_day(to_date(sysdate)-l_window,'SUNDAY'))
      GROUP BY trunc(next_day(to_date(TIMESTAMP)-7,'SUNDAY')),
         username,
         os_username,
         userhost;

      delete
        from sys.aud$
       where from_tz(ntimestamp#,'00:00') at local < trunc(next_day(to_date(sysdate)-l_window,'SUNDAY'));
      commit;
   exception
      when others then
      begin
         -- Roll back so we can re-try this block again later
         rollback;
         dbms_output.put_line('Error: ' || SQLCODE || ' Msg: ' || SUBSTR(SQLERRM, 1, 64));

         -- Re-throw the error so we'll get a failure.
         raise;
      end;
   end;

end aedba_audit_maint;
/


4. Cron job and stage script

00 03 * * 00 /u35/aetna/scripts/maint/arch_purge_ora_audit_trail.ksh -i DR02 > /dev/null 2>&1
