*****************DPPQA***********************



. ~/.profile

DPUAT92


Move scripts from dppdev over to dppqa

login to dppdev

scp -rp /u01/app/oracle/aetna/admin/DPDEV92/encryption dppqa:/u01/app/oracle/aetna/admin/DPUAT92/encryption 


scp -rp /u01/app/oracle/tls/encrypt dppqa:/u01/app/oracle/tls/encrypt




1) Create the Wallet directory for each database on server



   mkdir -p $ORACLE_BASE/admin/DPDEV92/wallet 

   chmod 700 $ORACLE_BASE/admin/DPDEV92/wallet




2) Backup the sqlnet.ora file

   cd $ORACLE_HOME/network/admin

   cp -p sqlnet.ora sqlnet.ora_b4_encryption


3) Add TDE setup to the sqlnet.ora file
 


SQLNET.ENCRYPTION_TYPES_SERVER= (AES128)
SQLNET.ENCRYPTION_SERVER = requested


3) Backup, OEM Blackout 



  

   cd $BKPSCR
   savebkp.ksh DPDEV92 b4encryption

   
   

   Create OEM Blackout



$BKPSCR/start_archive.ksh

--Save(rename) old wallet files

cd /orahome/u01/app/oracle/admin/DPDEV92/wallet

mv cwallet.sso cwallet.sso_ori
mv ewallet.p12 ewallet.p12_ori

mv ewallet_2016100714073216.p12 ewallet_2016100714073216.p12_ori
mv ewallet_2016100714074092_peoplesoft_backup_DPDEV92.p12 ewallet_2016100714074092_peoplesoft_backup_DPDEV92.p12_ori



4) Create the 12c Wallet

   sqlplus / as sysdba

   ADMINISTER KEY MANAGEMENT CREATE KEYSTORE '/orahome/u01/app/oracle/admin/DPDEV92/wallet/' IDENTIFIED BY "F1shF00d";
   ADMINISTER KEY MANAGEMENT CREATE AUTO_LOGIN KEYSTORE FROM KEYSTORE '/orahome/u01/app/oracle/admin/DPDEV92/wallet/' IDENTIFIED BY "F1shF00d";

   -- Open 12c Wallet
   ADMINISTER KEY MANAGEMENT SET KEYSTORE OPEN IDENTIFIED BY "F1shF00d";

   -- Create 12c master key
   ADMINISTER KEY MANAGEMENT SET KEY IDENTIFIED BY "F1shF00d" WITH BACKUP;
   ADMINISTER KEY MANAGEMENT SET KEY USING TAG 'peoplesoft_DPDEV92' IDENTIFIED BY "F1shF00d" WITH BACKUP USING 'peoplesoft_backup_DPDEV92';


5) turn on autoextend for all tablespaces 




cd /u01/app/oracle/aetna/admin/DPDEV92/encryption 



sqlplus / as sysdba

       sql =>   @ext_alter_datafiles_autoextend.sql    (1 minute)
                    !view alter_datafiles_autoextend.sql  ?  review script to be run

•	Turn on autoextend

       sql => @alter_datafiles_autoextend.sql   (1 minute)
      sql =>   exit
     view alter_datafiles_autoextend.out  ?  review script output





6)   --encrypt table columns



cd $HOME/tls/encrypt

sqlplus / as sysdba

@ext_drop_indexes.sql DPDEV92

@ext_create_indexes.sql DPDEV92

@ext_altix_logging_noparallel.sql DPDEV92
exit

sqlplus / as sysdba

@drop_indexes_DPDEV92.sql

exit

sqlplus / as sysdba


@encrypt_table_columns.sql
exit


7) ---Move tables


cd $HOME/tls/encrypt


sqlplus / as sysdba

@move_encrypted_tables.sql


!!!! if we get error running out of UNDO tablespace


ALTER TABLE SYSADM.PS_KNS_OVPD_BAL MODIFY (SSN encrypt no salt);




[?12/?19/?2016 6:15 PM] Schloendorn, Thomas: 
I did this

   CREATE UNDO TABLESPACE PSUNDOTS2
   DATAFILE '/opt/u10/oradata/DPDEV92/psundots_2.dbf' SIZE 5G AUTOEXTEND OFF
   EXTENT MANAGEMENT LOCAL AUTOALLOCATE
   ONLINE
   /

   show parameter undo_tablespace;


shutdown immediate


Modify init.ora file

undo_tablespace=PSUNDOTS2


startup


  alter system set undo_tablespace=PSUNDOTS2;


undo_tablespace

   show parameter undo_tablespace; 


DROP TABLESPACE PSUNDOTS INCLUDING CONTENTS AND DATAFILES CASCADE CONSTRAINTS

/

create new PSUNDOTS



CREATE UNDO TABLESPACE PSUNDOTS
DATAFILE '/u02/oradata/DPDEV92/psundots.dbf' SIZE 5G AUTOEXTEND OFF
EXTENT MANAGEMENT LOCAL AUTOALLOCATE
ONLINE
/




shutdown immediate


Modify init.ora file

undo_tablespace=PSUNDOTS


startup

alter system set undo_tablespace=PSUNDOTS;




DROP TABLESPACE PSUNDOTS2 INCLUDING CONTENTS AND DATAFILES CASCADE CONSTRAINTS

/




exit

8) --Rebuild Indexes (LOB indexes excluded)


cd $HOME/tls/encrypt


sqlplus / as sysdba



@create_indexes_DPDEV92.sql


@ext_altix_logging_noparallel.sql DPDEV92

@altix_logging_noparallel_DPDEV92.sql

exit




8) -- Quick test/check. You can use DBArtisan for that.

select KNS_PARTC_ID from SYSADM.PS_KNS_ERNCD_STAGE

## Make sure it shows correct path
select * from V$ENCRYPTION_WALLET;
select * from DBA_ENCRYPTED_COLUMNS;


extract DDL from SYSADM.PS_YE_W2CP_DATA to make sure encryption there



9) --autoextend off

cd /u01/app/oracle/aetna/admin/DPDEV92/encryption


run => sqlplus / as sysdba

      sql => @alter_datafiles_autoextend_off.sql   (1 minute)

      sql => !view alter_datafiles_autoextend_off.out  ?  review script to be run


      exit






10) Run Key backup. one time, just so we have backup for now


sqlplus / as sysdba
ADMINISTER KEY MANAGEMENT EXPORT KEYS WITH SECRET "F1shF00d" TO '/tmp/export_DPDEV92.exp' IDENTIFIED BY F1shF00d; 

exit





11) -recompile

@?/rdbms/admin/utlrp.sql

select count(*)
from dba_objects
where status = 'INVALID';

0

$BKPSCR/start_archive.ksh

12) Add crontab jobs


copy scripts if needed. make appropriate changes

scp /u01/app/oracle/tls/encrypt/backup_wallet_dir_to_tsm.ksh dppqa:/u01/app/oracle/tls/encrypt/backup_wallet_dir_to_tsm.ksh 
scp /u01/app/oracle/tls/encrypt/backup_wallet.ksh dppqa:/u01/app/oracle/tls/encrypt/backup_wallet.ksh


# Backup  Wallet
30 02 * * * /u01/app/oracle/tls/encrypt/backup_wallet_dir_to_tsm.ksh DPUAT92 >/dev/null 2>&1

40 02 * * * /u01/app/oracle/tls/encrypt/backup_wallet.ksh DPUAT92 > /dev/null 2


13) -- End OEM Blackout


14) --export job .par file additions

cd /u01/app/oracle/aetna/db_mgmt/backup

vi expdp_full.par

ENCRYPTION_PASSWORD="encrypt_test"
ENCRYPTION=ENCRYPTED_COLUMNS_ONLY



***************Steps to decrypt********

[?10/?24/?2016 10:58 AM] Swafford, Mike: 
1) alter table modify (abc decrypt)
2) move table/ rebuild indexes
3) disable network encryption in sqlnet.ora (comment encryption parameters) - note this will affect all dbs in home
4) bounce front-end to get new connections
Leave the wallet and stuff alone since you're just going to reencrypt later



************* Table was dropped and re created without encryption. So need to encrypt  back again**************


ALTER TABLE SYSADM.PS_KNS_SPC_HNDL MODIFY (SSN encrypt no salt);
ALTER TABLE SYSADM.PS_KNS_SPC_HNDL MOVE TABLESPACE KNSAPP;
