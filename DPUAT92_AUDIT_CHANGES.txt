*******************DPUAT92*************************************

1. Identify A/N Users and move them to STANDARD profile

select USERNAME,  PROFILE from dba_users where regexp_like (USERNAME, '[A|N][0-9]{6}.*') order by USERNAME




ALTER USER A102703 PROFILE STANDARD;
ALTER USER A210545 PROFILE STANDARD;		
ALTER USER A216787 PROFILE STANDARD;		
ALTER USER A236120 PROFILE STANDARD;		
ALTER USER A336377 PROFILE STANDARD;		
ALTER USER A541143 PROFILE STANDARD;		
ALTER USER A554904 PROFILE STANDARD;		
ALTER USER A616888 PROFILE STANDARD;		
ALTER USER N025774 PROFILE STANDARD;		
ALTER USER N299548 PROFILE STANDARD;		
ALTER USER N634833 PROFILE STANDARD;		
ALTER USER N683573 PROFILE STANDARD;		
ALTER USER N683574 PROFILE STANDARD;		
ALTER USER OPS$A470669 PROFILE STANDARD;	
ALTER USER OPS$A554904 PROFILE STANDARD;	
ALTER USER OPS$N182655 PROFILE STANDARD;	


2. Identify all other users and move them to appropriate profile

select USERNAME,PROFILE from dba_users where not regexp_like (USERNAME, '[A|N][0-9]{6}.*') order by USERNAME 


ALTER USER AETNADBA PROFILE TRUSTED_ID_NO_EXPIRE;
ALTER USER BENENG PROFILE TRUSTED_ID_NO_EXPIRE;
ALTER USER DBCMS PROFILE TRUSTED_ID_NO_EXPIRE;
ALTER USER DBLINK_DATAMART PROFILE TRUSTED_ID_NO_EXPIRE;
ALTER USER DBLINK_DATAREP PROFILE TRUSTED_ID_NO_EXPIRE;
ALTER USER DBSNMP PROFILE TRUSTED_ID_NO_EXPIRE;
ALTER USER DPADMIN PROFILE TRUSTED_ID_NO_EXPIRE;
ALTER USER DPDEV01_LNK_USER PROFILE TRUSTED_ID_NO_EXPIRE;
ALTER USER DPPRD01_TMP_LINK PROFILE TRUSTED_ID_NO_EXPIRE;
ALTER USER DPPRD02_LNK_USER PROFILE TRUSTED_ID_NO_EXPIRE;
ALTER USER IVR PROFILE TRUSTED_ID_NO_EXPIRE;
ALTER USER PEOPLE PROFILE TRUSTED_ID_NO_EXPIRE;
ALTER USER PS PROFILE TRUSTED_ID_NO_EXPIRE;
ALTER USER PSAPPS PROFILE TRUSTED_ID_NO_EXPIRE;
ALTER USER PWMTRAND_LNK_USER PROFILE TRUSTED_ID_NO_EXPIRE;
ALTER USER S035590 PROFILE TRUSTED_ID_NO_EXPIRE;
ALTER USER S058102 PROFILE TRUSTED_ID_NO_EXPIRE;
ALTER USER SQLSRV_USER_LUMINXGL PROFILE TRUSTED_ID_NO_EXPIRE;
ALTER USER WKAB PROFILE TRUSTED_ID_NO_EXPIRE;
ALTER USER WKABQAB_LNK_USER PROFILE TRUSTED_ID_NO_EXPIRE;
ALTER USER WKABUAT_LNK_USER PROFILE TRUSTED_ID_NO_EXPIRE;
ALTER USER SYSADM PROFILE TRUSTED_ID_NO_EXPIRE;
ALTER USER DBLINK_92_UPGRADE PROFILE TRUSTED_ID_NO_EXPIRE;


ALTER USER ANONYMOUS PROFILE STANDARD;
ALTER USER APPQOSSYS PROFILE STANDARD;
ALTER USER ARANA PROFILE STANDARD;
ALTER USER AUDSYS PROFILE STANDARD;
ALTER USER CEASON PROFILE STANDARD;
ALTER USER CIOAN PROFILE STANDARD;
ALTER USER DIP PROFILE STANDARD;
ALTER USER ESMITH1 PROFILE STANDARD;
ALTER USER GSMADMIN_INTERNAL PROFILE STANDARD;
ALTER USER GSMCATUSER PROFILE STANDARD;
ALTER USER ICHEKRYG PROFILE STANDARD;
ALTER USER KJIWANI PROFILE STANDARD;
ALTER USER OEMDBA PROFILE STANDARD;
ALTER USER OPS$BATCHMGR PROFILE STANDARD;
ALTER USER OPS$DPPXFNCL PROFILE STANDARD;
ALTER USER OPS$PSOFT PROFILE STANDARD;
ALTER USER ORACLE_OCM PROFILE STANDARD;
ALTER USER ORATIVOLI PROFILE STANDARD;
ALTER USER OUTLN PROFILE STANDARD;
ALTER USER PSDBA PROFILE STANDARD;
ALTER USER SCASH PROFILE STANDARD;
ALTER USER SYS PROFILE STANDARD;
ALTER USER SYSBACKUP PROFILE STANDARD;
ALTER USER SYSDG PROFILE STANDARD;
ALTER USER SYSKM PROFILE STANDARD;
ALTER USER SYSTEM PROFILE STANDARD;
ALTER USER TBALLARD PROFILE STANDARD;
ALTER USER XDB PROFILE STANDARD;
ALTER USER YSOUFIAN PROFILE STANDARD;
ALTER USER GSMUSER PROFILE STANDARD;




3. Identify user who no longer with company and drop them. Use example from Raf Khersonsky  email



select username||';' from dba_users where regexp_like (username, '[0123456789]')
and (username like 'A______' or username like 'N______')


USERNAME||';'

N025774;
A541143;
N683574;
A102703;
A236120;
N299548;
A336377;
A554904;
A210545;
A616888;
A216787;
N634833;
N683573;


paste above  into Outlook and see who is not there



DROP USER A541143 CASCADE
;
DROP USER N683574 CASCADE
;
DROP USER A102703 CASCADE
;
DROP USER N299548 CASCADE
;
DROP USER A336377 CASCADE
;
DROP USER A210545 CASCADE
;
DROP USER N634833 CASCADE
;



4. Drop old users

select USERNAME, ACCOUNT_STATUS from dba_users where USERNAME IN ('ARANA','CEASON','CIOAN','ESMITH1','ICHEKRYG','KJIWANI','SCASH','TBALLARD','YSOUFIAN' )

select OWNER,OBJECT_NAME from dba_objects where owner in ('ARANA','CEASON','CIOAN','ESMITH1','ICHEKRYG','KJIWANI','SCASH','TBALLARD','YSOUFIAN' )


## Export User(s) with objects
cd /u10/oraback/export
expdp system/xxx DIRECTORY=EXP_DUMP_DIR DUMPFILE=ESMITH1_DPUAT92.dmp SCHEMAS=ESMITH1


DROP USER CIOAN CASCADE
;
DROP USER ESMITH1 CASCADE
;
DROP USER YSOUFIAN CASCADE
;
DROP USER CEASON CASCADE
;
DROP USER ARANA CASCADE
;
DROP USER KJIWANI CASCADE
;
DROP USER TBALLARD CASCADE
;
DROP USER SCASH CASCADE
;
DROP USER ICHEKRYG CASCADE
;


5.  Identify Roles with ANY grants

select role
from dba_roles a
where a.role in (select b.grantee from dba_sys_privs b where privilege like '%ANY%') 


ROLE

DBA
IMP_FULL_DATABASE
OEM_MONITOR
DATAPUMP_IMP_FULL_DATABASE
ICR_AUDIT
EM_EXPRESS_ALL
SCHEDULER_ADMIN
DEVELOPER_FULL
PSUSER1
AUDIT_ADMIN
EXP_FULL_DATABASE
RECOVERY_CATALOG_OWNER
AQ_ADMINISTRATOR_ROLE
DEVELOPER_SUID
PSADMIN
DEVELOPER_SELECT


6. Identify USERS with following roles 

select USERNAME, granted_role  from dba_users,dba_role_privs where username = grantee
and  granted_role IN ('DEVELOPER_FULL','PSUSER1','DEVELOPER_SUID','PSADMIN','DEVELOPER_SELECT') order by USERNAME




USERNAME			GRANTED_ROLE

A554904				DEVELOPER_SUID
A616888				DEVELOPER_FULL
N683573				DEVELOPER_FULL
OPS$A554904			DEVELOPER_SUID
DBLINK_92_UPGRADE		DEVELOPER_SELECT
DPDEV01_LNK_USER		DEVELOPER_SELECT
DPPRD02_LNK_USER		DEVELOPER_SELECT
PWMTRAND_LNK_USER		DEVELOPER_SELECT
WKABUAT_LNK_USER		DEVELOPER_SELECT
SYS				DEVELOPER_SELECT
SYS				DEVELOPER_SUID
SYS				PSADMIN
SYS				DEVELOPER_FULL
SYSADM				PSADMIN



7. Revoke/Grant Roles


REVOKE DEVELOPER_FULL FROM SYS
/
REVOKE DEVELOPER_SELECT FROM SYS
/
REVOKE DEVELOPER_SUID FROM SYS
/
REVOKE PSADMIN FROM SYS
/


REVOKE DEVELOPER_SUID FROM A554904

/
GRANT PSOPSBATCHMGR TO A554904

/

GRANT DEVELOPER_FULL TO A554904

/

ALTER USER A554904 DEFAULT ROLE "CONNECT",DEVELOPER_FULL
,
PSOPSBATCHMGR

/



##No changes for A616888
##No changes for N683573


REVOKE DEVELOPER_SUID FROM OPS$A554904
/
GRANT PSOPSBATCHMGR TO OPS$A554904
/

GRANT DEVELOPER_FULL TO OPS$A554904
/

ALTER USER OPS$A554904 DEFAULT ROLE "CONNECT",DEVELOPER_FULL
,
PSOPSBATCHMGR

/




REVOKE DEVELOPER_SELECT FROM DPDEV01_LNK_USER

/

GRANT PSSELECT TO DPDEV01_LNK_USER

/

ALTER USER DPDEV01_LNK_USER DEFAULT ROLE PSSELECT

/

REVOKE DEVELOPER_SELECT FROM DPPRD02_LNK_USER
/
GRANT PSSELECT TO DPPRD02_LNK_USER
/
ALTER USER DPPRD02_LNK_USER DEFAULT ROLE PSSELECT
/


REVOKE DEVELOPER_SELECT FROM PWMTRAND_LNK_USER
/
GRANT PSSELECT TO PWMTRAND_LNK_USER
/
ALTER USER PWMTRAND_LNK_USER DEFAULT ROLE PSSELECT
/


REVOKE DEVELOPER_SELECT FROM WKABUAT_LNK_USER
/
GRANT PSSELECT TO WKABUAT_LNK_USER
/
ALTER USER WKABUAT_LNK_USER DEFAULT ROLE PSSELECT
/

REVOKE DEVELOPER_SELECT FROM DBLINK_92_UPGRADE
/
GRANT PSSELECT TO DBLINK_92_UPGRADE
/
ALTER USER DBLINK_92_UPGRADE DEFAULT ROLE PSSELECT
/



8. Revoke ANY priv from these roles and assign regular priv if role still in use


REVOKE ALTER ANY INDEX FROM DEVELOPER_FULL
/
REVOKE ALTER ANY TABLE FROM DEVELOPER_FULL
/
REVOKE CREATE ANY INDEX FROM DEVELOPER_FULL
/
REVOKE CREATE ANY PROCEDURE FROM DEVELOPER_FULL
/
REVOKE CREATE ANY TABLE FROM DEVELOPER_FULL
/
REVOKE CREATE ANY VIEW FROM DEVELOPER_FULL
/
REVOKE DELETE ANY TABLE FROM DEVELOPER_FULL
/
REVOKE DROP ANY INDEX FROM DEVELOPER_FULL
/
REVOKE DROP ANY TABLE FROM DEVELOPER_FULL
/
REVOKE DROP ANY VIEW FROM DEVELOPER_FULL
/
REVOKE EXECUTE ANY PROCEDURE FROM DEVELOPER_FULL
/
REVOKE INSERT ANY TABLE FROM DEVELOPER_FULL
/
REVOKE SELECT ANY TABLE FROM DEVELOPER_FULL
/
REVOKE UPDATE ANY TABLE FROM DEVELOPER_FULL
/


GRANT CREATE  PROCEDURE TO DEVELOPER_FULL
/
GRANT CREATE  TABLE TO DEVELOPER_FULL
/
GRANT CREATE VIEW TO DEVELOPER_FULL
/

REVOKE ANALYZE ANY FROM PSADMIN
/
REVOKE GRANT ANY ROLE FROM PSADMIN
/



REVOKE ALTER ANY INDEX FROM PSUSER1
/
REVOKE ALTER ANY TABLE FROM PSUSER1
/
REVOKE CREATE ANY INDEX FROM PSUSER1
/
REVOKE CREATE ANY TABLE FROM PSUSER1
/
REVOKE CREATE ANY VIEW FROM PSUSER1
/
REVOKE DELETE ANY TABLE FROM PSUSER1
/
REVOKE DROP ANY INDEX FROM PSUSER1
/
REVOKE DROP ANY TABLE FROM PSUSER1
/
REVOKE DROP ANY VIEW FROM PSUSER1
/
REVOKE INSERT ANY TABLE FROM PSUSER1
/
REVOKE SELECT ANY TABLE FROM PSUSER1
/
REVOKE UPDATE ANY TABLE FROM PSUSER1
/


REVOKE DELETE ANY TABLE FROM DEVELOPER_SUID
/
REVOKE INSERT ANY TABLE FROM DEVELOPER_SUID
/
REVOKE SELECT ANY TABLE FROM DEVELOPER_SUID
/
REVOKE UPDATE ANY TABLE FROM DEVELOPER_SUID
/

REVOKE SELECT ANY TABLE FROM DEVELOPER_SELECT
/


9. Remove DBA from DPADMIN

I revoked DBA from DPADMIN.  As a result of that, I hit the following when doing a full export:

EXPDP - ORA-31693 ORA-01031 (Insufficient Privileges) On Some Tables When Exporting from 12cR1 (Doc ID 1676411.1)

To fix the above, I granted the following:

grant flashback any table to EXP_FULL_DATABASE ;
grant flashback on SYSTEM.SCHEDULER_PROGRAM_ARGS to EXP_FULL_DATABASE;


The DPPRD02 refresh script has been changed in dev.  I am granting and revoking DBA to DPADMIN during the refresh process.

