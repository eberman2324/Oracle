Below was used to mimic the application backout procedures.

Primary DataBase Server - xhepydbw41d

Primary Database - GROOT_xhepydbw41d

Standby Database Server - xhepydbw42d

Standby Database - GROOT_xhepydbw42d

Vis#2020



------------------------------------------------------------------------------------------

Create one time archivelog backup job and run immediately for Primary dataBase via OEM


--------------------------------------------------------------------------------------
Note: resync catalog was required as GROOT database was not registered in OEM for RMAN

Connect to RMAN target and catalog and issue command:

rman => resync catalog;
---------------------------------------------------------------------------------------

Start node level blackouts for primary database server and standby database server via OEM
 Do not allow jobs to run during blackout


Make copies of the Primary DataBase spfile, P file, Broker configuration files, and tnsnames.ora file

   From server xhepydbw41d

   . oraenv
   GROOT

   cd $DBS

   cp -p spfile${ORACLE_SID}.ora spfile${ORACLE_SID}.ora_b4_failover_`date +%Y%m%d`

   cp -p orapw${ORACLE_SID} orapw${ORACLE_SID}_b4_failover_`date +%Y%m%d`

   cp -p dr1${ORACLE_SID}_`hostname -s`.dat dr1${ORACLE_SID}_`hostname -s`.dat_b4_failover_`date +%Y%m%d`

   cp -p dr2${ORACLE_SID}_`hostname -s`.dat dr2${ORACLE_SID}_`hostname -s`.dat_b4_failover_`date +%Y%m%d`

   cd $ORACLE_HOME/network/admin

   cp -p tnsnames.ora tnsnames.ora_b4_failover_`date +%Y%m%d`


Show Broker Configuration for Primary Database

   From server xhepydbw41d

   cd /home/oracle/tls/dg

   show_broker_config.sh


Get srvctl Info for Primary DataBase and Listener

   From server xhepydbw41d

   cd /home/oracle/tls/dg

   show_srvctl.sh


Make copies of the Standby DataBase spfile, P file, and Broker configuration files

   From server xhepydbw42d

   . oraenv
   GROOT

   cd $DBS

   cp -p spfile${ORACLE_SID}.ora spfile${ORACLE_SID}.ora_b4_failover_`date +%Y%m%d`

   cp -p orapw${ORACLE_SID} orapw${ORACLE_SID}_b4_failover_`date +%Y%m%d`

   cp -p dr1${ORACLE_SID}_`hostname -s`.dat dr1${ORACLE_SID}_`hostname -s`.dat_b4_failover_`date +%Y%m%d`

   cp -p dr2${ORACLE_SID}_`hostname -s`.dat dr2${ORACLE_SID}_`hostname -s`.dat_b4_failover_`date +%Y%m%d`


Show Broker Configuration for Standby Database

   From server xhepydbw42d

   cd /home/oracle/tls/dg

   show_broker_config.sh


Get srvctl Info for Standby DataBase and Listener

   From server xhepydbw42d

   cd /home/oracle/tls/dg

   show_srvctl.sh




Failover to standby database from standby server

   From server xhepydbw42d

   dgmgrl => connect sys/locked99999@GROOT_xhepydbw42d

   dgmgrl => FAILOVER TO 'GROOT_xhepydbw42d';

   dgmgrl => show configuration;

             Configuration - GROOT

             Protection Mode: MaxPerformance
             Members:
             GROOT_xhepydbw42d - Primary database
             GROOT_xhepydbw41d - Physical standby database (disabled)
             ORA-16661: the standby database needs to be reinstated

   dgmgrl => exit
   

Stop the Broker and remove Broker Config Files on the new Primary server

   From server xhepydbw42d

   sqlplus / as sysdba

   alter system set dg_broker_start=FALSE;

   exit

   cd $DBS

   rm dr1${ORACLE_SID}_`hostname -s`.dat

   rm dr2${ORACLE_SID}_`hostname -s`.dat


Make copy of GROOT database entry in e/tc/oratab and comment

   vi /etc/oratab

   #GROOT:/orahome/u01/app/oracle/product/12.1.0.2.170418/db_1:N


Remove the old primary database

   From server xhepydbw41d

   cd /home/oracle/tls/dg


   Run this if database in open mode 

     $ORACLE_HOME/bin/dbca -silent -deleteDatabase -sourceDB $ORACLE_SID | tee -a drop_database_${ORACLE_SID}.out

   End open mode instructions


   Run this if database in mount mode 

     sqlplus / as sysdba
 
     shutdown immediate;

     startup mount restrict;

     drop database;

     exit

     srvctl remove database -db ${ORACLE_SID}_`hostname -s`

   End mount mode instructions


   Confirm database configuration removed from Oracle Restart

   srvctl config database -d ${ORACLE_SID}_`hostname -s`


Confirm Primary Database Files Removed From ASM

   From server xhepydbw41d

   . oraenv
   +ASM

   asmcmd

   ASMCMD [+] > lsdg

   ASMCMD [+] > ls -l DATA_01

   ASMCMD [+] > exit



Uncomment GROOT database entry in e/tc/oratab

   From server xhepydbw41d

   
   vi /etc/oratab

   GROOT:/orahome/u01/app/oracle/product/12.1.0.2.170418/db_1:N

   . oraenv
   GROOT


   If dbca was run then tnsnames.ora entry for GROOT is gone.

   cd $ORACLE_HOME/network/admin

   cp -p tnsnames.ora_b4_failover_`date +%Y%m%d` tnsnames.ora


Add New Primary DataBase to tnsnames.ora on new Standby DataBase Server
This was required since GROOT was not defined to LDAP.  However, should
be added in the event LDAP has issues.

   GROOT_xhepydbw42d=
     (DESCRIPTION =
       (ADDRESS_LIST =
         (ADDRESS = (PROTOCOL = TCP)(HOST = xhepydbw42d.aetna.com)(PORT = 1555))
       )
       (CONNECT_DATA =
         (SID = GROOT)
       )
     )


Remove Broker Config Files On new Standby DataBase server

   From server xhepydbw41d

   cd $DBS

   rm dr1${ORACLE_SID}_`hostname -s`.dat

   rm dr2${ORACLE_SID}_`hostname -s`.dat


Create New Physical Standby DataBase

   From server xhepydbw41d

   cd $HOME/tls/dg


   Note: For prod, need to add code to extract sys P from TPAM

   nohup ./create_standby_db_after_failover.sh ${ORACLE_SID} 1555 xhepydbw42d &

   Logfile - /orahome/u01/app/oracle/local/logs/create_standby_db_GROOT_after_failover_20170925_1506357013.out


Confirm all is well with standby database creation

   Review alert logs, broker logs, database restart settings via srvctl


Confirm Configuration

   dgmgrl

   dgmgrl => connect /

   dgmgrl => show configuration;

   dgmgrl => show database 'GROOT_xhepydbw41d';

   dgmgrl => show database 'GROOT_xhepydbw42d';

   dgmgrl => exit


Perform log switch on primary and confirm applying to standby

   From server xhepydbw42d

   sqlplus / as sysdba

   alter system switch logfile;


Perform switchover to standby database from primary database server

   From server xhepydbw42d

   dgmgrl => connect sys/locked99999@GROOT_xhepydbw42d

   dgmgrl => SWITCHOVER TO 'GROOT_xhepydbw41d';

   dgmgrl => show configuration;

   dgmgrl => show database 'GROOT_xhepydbw41d';

   dgmgrl => show database 'GROOT_xhepydbw42d';

   dgmgrl => exit;


Perform log switch on primary and confirm applying to standby

   From server xhepydbw41d

   sqlplus / as sysdba

   alter system switch logfile;


create a one time level 1 backup of primary database via OEM and run immediately


