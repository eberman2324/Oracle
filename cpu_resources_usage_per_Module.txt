ORA-04036: PGA memory used by the instance exceeds PGA_AGGREGATE_LIMIT


HEDWPRD

6t18s067t8nqx (blocking locks)

SELECT se.username, ss.sid, ROUND (value/100) "CPU Usage"
FROM v$session se, v$sesstat ss, v$statname st
WHERE ss.statistic# = st.statistic#
   AND name LIKE  '%CPU used by this session%'
   AND se.sid = ss.SID 
   AND se.username IS NOT NULL
  ORDER BY value DESC;


--Active Sessions
  SELECT
   s.username,
   t.sid,
   s.serial#,
   SUM(VALUE/100) as "cpu usage (seconds)"
FROM
   v$session s,
   v$sesstat t,
   v$statname n
WHERE
   t.STATISTIC# = n.STATISTIC#
AND
   NAME like '%CPU used by this session%'
AND
   t.SID = s.SID
AND
   s.status='ACTIVE'
AND
   s.username is not null
GROUP BY username,t.sid,s.serial#


select 
   ss.username,
   se.SID,
   VALUE/100 cpu_usage_seconds
from
   v$session ss, 
   v$sesstat se, 
   v$statname sn
where
   se.STATISTIC# = sn.STATISTIC#
and
   NAME like '%CPU used by this session%'
and
   se.SID = ss.SID
and 
   ss.username is not null
order by VALUE desc





SELECT SERVICE_NAME, STAT_NAME, ROUND(AVG(PCT_USAGE), 3) AS PCT_USAGE
  FROM (SELECT X.*,
               (CASE
                 WHEN SUM_VALUE <> 0 THEN
                  (VALUE / SUM_VALUE * 100)
                 ELSE
                  NULL
               END) AS PCT_USAGE
          FROM (SELECT SNAP_ID,
                       INSTANCE_NUMBER,
                       SERVICE_NAME,
                       STAT_NAME,
                       VALUE,
                       SUM(VALUE) OVER(PARTITION BY SNAP_ID, INSTANCE_NUMBER, STAT_NAME) AS SUM_VALUE
                  FROM (SELECT DISTINCT SRVC.SNAP_ID,
                                        SRVC.INSTANCE_NUMBER,
                                        SRVC.SERVICE_NAME,
                                        SRVC.STAT_NAME,
                                        SRVC.VALUE
                          FROM DBA_HIST_SERVICE_STAT SRVC,
                               DBA_HIST_SNAPSHOT     SNAP
                         WHERE SRVC.SNAP_ID = SNAP.SNAP_ID
                           AND SNAP.BEGIN_INTERVAL_TIME >=
                               TO_DATE('12/01/2018', 'MM/DD/YYYY')
                           AND SNAP.END_INTERVAL_TIME <
                               TO_DATE('12/10/2018', 'MM/DD/YYYY')
                           AND SRVC.STAT_NAME = 'DB CPU')) X)
 GROUP BY SERVICE_NAME, STAT_NAME
 ORDER BY (CASE
            WHEN PCT_USAGE = 0 THEN
             1
            ELSE
             0
          END),
          UPPER(SERVICE_NAME),
          STAT_NAME;
          




select 
   ss.username,
   se.SID,
   VALUE/100 cpu_usage_seconds
from
   V$ACTIVE_SESSION_HISTORY ss, 
   v$sesstat se, 
   v$statname sn
where
   se.STATISTIC# = sn.STATISTIC#
and
   NAME like '%CPU used by this session%'
and
   se.SID = ss.SID
and 
   ss.username is not null
order by VALUE desc



with total_cpu as
(select count(1)
from  V$ACTIVE_SESSION_HISTORY
where   SESSION_TYPE != 'BACKGROUND'
and session_state = 'ON CPU')
select  module,
count(1) "module_cpu",
(select * from total_cpu) "total_cpu",
round((count(1)/(select * from total_cpu))*100,2) PCT_CPU
from  V$ACTIVE_SESSION_HISTORY
where SESSION_TYPE != 'BACKGROUND'
and   session_state = 'ON CPU'
group by module order by PCT_CPU desc



with total_cpu as
(select count(1)*10
from  dba_hist_active_sess_history
where   SAMPLE_TIME >=TO_DATE('12/01/2018', 'MM/DD/YYYY')
and   SAMPLE_TIME < TO_DATE('12/10/2018', 'MM/DD/YYYY')
and   SESSION_TYPE != 'BACKGROUND'
and session_state = 'ON CPU')
select  module,
count(1)*10 "module_cpu",
(select * from total_cpu) "total_cpu",
round((count(1)*10/(select * from total_cpu))*100,2) PCT_CPU
from  dba_hist_active_sess_history
where   SAMPLE_TIME >=TO_DATE('12/01/2018', 'MM/DD/YYYY')
and   SAMPLE_TIME < TO_DATE('12/10/2018', 'MM/DD/YYYY')
and   SESSION_TYPE != 'BACKGROUND'
and   session_state = 'ON CPU'
group by module order by PCT_CPU des



SAMPLE_TIME >=TO_DATE('12/01/2018', 'MM/DD/YYYY')
AND SAMPLE_TIME < TO_DATE('12/10/2018', 'MM/DD/YYYY')                               
                           
      PaymentInquiry                          

8bzzqhscrcgz6
select 
   ss.user_id,
   se.SID,
   VALUE/100 cpu_usage_seconds
from
   V$ACTIVE_SESSION_HISTORY ss, 
   v$sesstat se, 
   v$statname sn
where
   se.STATISTIC# = sn.STATISTIC#
and ss.SAMPLE_TIME >= TO_DATE('12/01/2018', 'MM/DD/YYYY')
 and ss.SAMPLE_TIME <  TO_DATE('12/10/2018', 'MM/DD/YYYY') 
  and  NAME like '%CPU used by this session%'
and
   se.SID = ss.session_id
and 
   ss.user_id is not null
order by VALUE desc                        
                              

!!! 

We can find similar CPU time for past sessions using DBA_HIST_ACTIVE_SESS_HISTORY table.
 Following query will provide CPU time used by module as % of total CPU time between 2 AWR snapshots

-- Date range
with total_cpu as
(select count(1)*10
from  dba_hist_active_sess_history
where   SAMPLE_TIME >=TO_DATE('11/20/2018 11', 'MM/DD/YYYY HH24') 
and   SAMPLE_TIME < TO_DATE('12/11/2018 15', 'MM/DD/YYYY HH24') 
and   SESSION_TYPE != 'BACKGROUND'
and session_state = 'ON CPU')
select  module,
count(1)*10 "module_cpu",
(select * from total_cpu) "total_cpu",
round((count(1)*10/(select * from total_cpu))*100,2) PCT_CPU
from  dba_hist_active_sess_history
where   SAMPLE_TIME >=TO_DATE('11/20/2018 11', 'MM/DD/YYYY HH24') 
and   SAMPLE_TIME < TO_DATE('12/11/2018 15', 'MM/DD/YYYY HH24') 
and   SESSION_TYPE != 'BACKGROUND'
and   session_state = 'ON CPU'
group by module order by PCT_CPU desc

-- Per hour on given day

with total_cpu as
(select count(1)*10
from  dba_hist_active_sess_history
where   SAMPLE_TIME >=TO_DATE('12/06/2018 01', 'MM/DD/YYYY HH24') 
and   SAMPLE_TIME < TO_DATE('12/06/2018 02', 'MM/DD/YYYY HH24') 
and   SESSION_TYPE != 'BACKGROUND'
and session_state = 'ON CPU')
select  module,
count(1)*10 "module_cpu",
(select * from total_cpu) "total_cpu",
round((count(1)*10/(select * from total_cpu))*100,2) PCT_CPU
from  dba_hist_active_sess_history
where   SAMPLE_TIME >=TO_DATE('12/06/2018 01', 'MM/DD/YYYY HH24') 
and   SAMPLE_TIME < TO_DATE('12/06/2018 02', 'MM/DD/YYYY HH24') 
and   SESSION_TYPE != 'BACKGROUND'
and   session_state = 'ON CPU'
group by module order by PCT_CPU desc


